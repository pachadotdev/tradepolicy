{
  "hash": "8f0f9a08feeeae8e2b8fec246107cae9",
  "result": {
    "engine": "knitr",
    "markdown": "---\nbibliography: 00-references.bib\n---\n\n# General equilibrium trade policy analysis with structural gravity\n\n## Trade without borders\n\n### Initial data\n\nUnlike the previous chapter, we shall proceed by alternating both data transforming and regressions. In the previous chapter, it was possible first to process the datasets and then fit the regressions, but here we need the regressions' output to create new variables. In any case, we will follow quite similar steps to the last chapter.\n\nTo do what is shown in box #1 from page 104 in @yotov2016advanced, we need to convert \"DEU\" in both exporter and importer columns to \"0-DEU\" so that the software sets it as the reference factor (i.e., \"0-DEU\" will be listed before any text string starting with a letter). The book uses \"ZZZ,\" but in R, \"ZZZ\" will not be treated as the reference factor, for which case we could have used \"AAA.\" It is important to mention that box #1 does not show a previous step to filter observations for 2006, which is mentioned on page 103.\n\nBefore conducting any data filtering or regression, we need to load the required packages.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# dataset\nlibrary(tradepolicy)\n\n# data transformation\nlibrary(dplyr)\nlibrary(tidyr)\n\n# regression\nlibrary(capybara)\n\n# plots\nlibrary(ggplot2)\n```\n:::\n\n\nWe start by defining some parameters to simplify the code. The value for the elasticity of substitution, $\\sigma = 7$, used to set the convergence criteria is taken from the literature. There is an explanation in the original Stata code.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nref_country <- \"DEU\"\nref_country0 <- paste0(\"0-\", ref_country)\nsigma <- 7\nmax_dif <- 1\nsd_dif <- 1\nchange_price_i_old <- 0\n```\n:::\n\n\nIt is imperative to arrange the table by importers. Otherwise, there is a difference in the estimated fixed effects that changes the factory prices in the last figure from this section, and here the aim is to fully replicate the two figures from this section in the book. We mentioned this in the RTA effects section from the previous chapter.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application1 <- agtpa_applications |>\n  select(exporter, importer, pair_id, year, trade, dist, cntg, lang, clny) |>\n  filter(year == 2006) |>\n  mutate(\n    log_dist = log(dist),\n    intl = ifelse(exporter != importer, 1, 0),\n    exporter = ifelse(exporter == ref_country, ref_country0, exporter),\n    importer = ifelse(importer == ref_country, ref_country0, importer)\n  ) |>\n  arrange(importer) |>\n  # Create Yit\n  group_by(exporter) |>\n  mutate(y = sum(trade, na.rm = T)) |>\n  # Create Eit\n  group_by(importer) |>\n  mutate(e = sum(trade, na.rm = T)) |>\n  # Create Er\n  ungroup() |>\n  mutate(e_r = max(ifelse(importer == ref_country0, e, NA), na.rm = T))\n```\n:::\n\n\n### Step I: Solve the baseline model\n\nWe start by fitting the model\n\n$$\n\\begin{align}\nX_{ij,t} =& \\:\\exp\\left[\\pi_{i,t} + \\chi_{i,t} + \\beta_1 \\log(DIST)_{i,j} + \\beta_2 CNTG_{i,j} + \\beta_3 INTL_{i,j}\\right] \\times \\varepsilon_{ij,t}.\n\\end{align}\n$$\n\nWith the data from above, the model specification is straightforward.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_baseline_app1 <- fepoisson(\n  trade ~ log_dist + cntg + intl | exporter + importer,\n  data = ch2_application1,\n  control = list(iter_max = 500)\n)\n```\n:::\n\n\nWith the estimated model, we can proceed as in box #1 from page 105 in @yotov2016advanced to construct the variables for exporter and importer fixed effects. This step is very different compared to Stata.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfe_exporter_bln <- fit_baseline_app1$fixed_effects$exporter |>\n  tibble::enframe(name = \"exporter\", value = \"fe_exporter_bln\")\n\nfe_importer_bln <- fit_baseline_app1$fixed_effects$importer |>\n  tibble::enframe(name = \"importer\", value = \"fe_importer_bln\")\n\nch2_application1 <- ch2_application1 |>\n  left_join(fe_exporter_bln, by = \"exporter\") |>\n  left_join(fe_importer_bln, by = \"importer\")\n```\n:::\n\n\nStill following box #1, we need to compute the variables of bilateral trade costs and multilateral resistances.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application1 <- ch2_application1 |>\n  mutate(\n    tij_bln = exp(fit_baseline_app1$coef_table[\"log_dist\", 1] * log_dist +\n      fit_baseline_app1$coef_table[\"cntg\", 1] * cntg +\n      fit_baseline_app1$coef_table[\"intl\", 1] * intl),\n\n    # outward multilateral resistance (omr)\n    omr_bln = y * (e_r / exp(fe_exporter_bln)),\n\n    # inward multilateral resistance (imr)\n    imr_bln = e / (exp(fe_importer_bln) * e_r)\n  )\n```\n:::\n\n\nTo complete this estimation stage, we need to create a column with the estimated international trade for given output and expenditures. We start by adding a column with the estimated trade for the baseline model, and then we group by the exporter and summarise to obtain the required column $\\xi$-baseline.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application1 <- ch2_application1 |>\n  mutate(tradehat_bln = predict(fit_baseline_app1, ch2_application1)) |>\n  group_by(exporter) |>\n  mutate(xi_bln = sum(tradehat_bln * (exporter != importer), na.rm = T)) |>\n  ungroup()\n```\n:::\n\n\n### Step II: Define a counterfactual scenario\n\nBox #2 from page 105 in @yotov2016advanced proposes two alternatives to define the counterfactual scenario of removing international borders. The first alternative is to eliminate the border variable and generate the logged trade costs used in the constraint.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application1 <- ch2_application1 |>\n  mutate(\n    tij_cfl = exp(fit_baseline_app1$coef_table[\"log_dist\", 1] * log_dist +\n      fit_baseline_app1$coef_table[\"cntg\", 1] * cntg)\n  )\n```\n:::\n\n\nThe second alternative is to define a new counterfactual border variable. We only show this equivalent case without computation.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application1 <- ch2_application1 |>\n  mutate(\n    intl_cfl = 0,\n    tij_bln = exp(fit_baseline_app1$coef_table[\"log_dist\", 1] * log_dist +\n      fit_baseline_app1$coef_table[\"cntg\", 1] * cntg +\n      fit_baseline_app1$coef_table[\"intl\", 1] * intl_cfl)\n  )\n```\n:::\n\n\n### Step III: Solve the counterfactual model\n\nWe need to fit a model similar to the model from step I, the constrained gravity model, where $\\pi_{j,t}$ and $\\chi_{j,t}$ are altered as in the equation\n\n$$\n\\begin{align}\nX_{ij,t} =& \\:\\exp\\left[\\pi_{i,t}^{CFL} + \\chi_{i,t}^{CFL} + \\beta_1 \\log(DIST)_{i,j} + \\beta_2 CNTG_{i,j} + \\beta_3 INTL_{i,j}\\right] \\times \\varepsilon_{ij,t}.\n\\end{align}\n$$\n\nBox #1 from page 106 in @yotov2016advanced estimates the constrained gravity model with the PPML estimator using an offset argument, which is straightforward in R.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_counterfactual_app1 <- fepoisson(\n  trade ~ 0 | exporter + importer,\n  data = ch2_application1,\n  offset = ~ log(tij_cfl),\n  control = list(iter_max = 500)\n)\n```\n:::\n\n\nAs in the previous chapter, we need to extract the fixed effects.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfe_exporter_cfl <- fit_counterfactual_app1$fixed_effects$exporter |>\n  tibble::enframe(name = \"exporter\", value = \"fe_exporter_cfl\")\n\nfe_importer_cfl <- fit_counterfactual_app1$fixed_effects$importer |>\n  tibble::enframe(name = \"importer\", value = \"fe_importer_cfl\")\n\nch2_application1 <- ch2_application1 |>\n  left_join(fe_exporter_cfl, by = \"exporter\") |>\n  left_join(fe_importer_cfl, by = \"importer\")\n```\n:::\n\n\nNow we go for Box #2 from page 106 in @yotov2016advanced, where the authors obtain the bilateral trade costs and multilateral resistances variables.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application1 <- ch2_application1 |>\n  mutate(\n    # outward multilateral resistance (omr)\n    omr_cfl = y * (e_r / exp(fe_exporter_cfl)),\n\n    # inward multilateral resistance (imr)\n    imr_cfl = e / (exp(fe_importer_cfl) * e_r)\n  )\n```\n:::\n\n\nBox #2 also shows how to compute trade's conditional general equilibrium effects, similar to what we did in step I.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application1 <- ch2_application1 |>\n  mutate(tradehat_cfl = predict(fit_counterfactual_app1, ch2_application1)) |>\n  group_by(exporter) |>\n  mutate(xi_cfl = sum(tradehat_cfl * (exporter != importer), na.rm = T)) |>\n  ungroup()\n```\n:::\n\n\nBox #1 from page 107 in @yotov2016advanced can be simplified with R code. To construct the iterative procedure to converge to full endowment general equilibrium effects, we start by creating the required columns and parameters so that we will deviate from the original approach.\n\nWe start computing the change in bilateral trade costs (changes in $t_{ij}$) and trade deficit or surplus ($\\phi$).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application1 <- ch2_application1 |>\n  mutate(\n    change_tij = tij_cfl / tij_bln,\n    phi = ifelse(importer == exporter, e / y, 0)\n  ) |>\n  group_by(exporter) |>\n  mutate(phi = max(phi, na.rm = T)) |>\n  ungroup()\n```\n:::\n\n\nWe compute the change in prices for exporters (changes in $p_i$) and importers (changes in $p_j$).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application1 <- ch2_application1 |>\n  group_by(exporter) |>\n  mutate(change_p_i = ((exp(fe_exporter_cfl) / e_r) /\n    (exp(fe_exporter_bln) / e_r))^(1 / (1 - sigma))) |>\n  ungroup() |>\n  group_by(importer) |>\n  mutate(\n    change_p_j = ifelse(importer == exporter, change_p_i, 0),\n    change_p_j = max(change_p_j, na.rm = T)\n  ) |>\n  ungroup()\n```\n:::\n\n\nNext, we need to compute the counterfactual trade flows.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application1 <- ch2_application1 |>\n  mutate(trade_cfl = tradehat_cfl * change_p_i * change_p_j)\n```\n:::\n\n\nTo conclude the steps from Box #1 we need a `while()` loop and iterate until convergence is reached. We need to duplicate some columns under new names for the loop operations because we will overwrite them using the iterative steps.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application1 <- ch2_application1 |>\n  mutate(\n    omr_cfl_0 = omr_cfl,\n    imr_cfl_0 = imr_cfl,\n    change_imr_full_0 = 1,\n    change_omr_full_0 = 1,\n    change_p_i_0 = change_p_i,\n    change_p_j_0 = change_p_j,\n    fe_exporter_cfl_0 = fe_exporter_cfl,\n    fe_importer_cfl_0 = fe_importer_cfl,\n    tradehat_0 = tradehat_cfl,\n    e_r_cfl_0 = e_r\n  )\n```\n:::\n\n\nWe run the loop, which cannot be divided into smaller pieces because the step $N$ depends on the step $N-1$. As in the previous application, the idea is for the stopping criteria in this iteration is that the model converges when prices stop changing.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ni <- 1\nwhile (sd_dif > 1e-5 | max_dif > 1e-5) {\n  ch2_application1 <- ch2_application1 |>\n    mutate(trade_1 = tradehat_0 * change_p_i_0 * change_p_j_0 /\n      (change_omr_full_0 * change_imr_full_0))\n\n  # repeat the counterfactual model\n  fit_counterfactual_app1_2 <- fepoisson(\n    trade_1 ~ 0 | exporter + importer,\n    data = ch2_application1,\n    offset = ~ log(tij_cfl),\n    control = list(iter_max = 500)\n  )\n\n  fe_exporter_cfl_1 <- fit_counterfactual_app1_2$fixed_effects$exporter |>\n    tibble::enframe(name = \"exporter\", value = \"fe_exporter_cfl_1\")\n\n  fe_importer_cfl_1 <- fit_counterfactual_app1_2$fixed_effects$importer |>\n    tibble::enframe(name = \"importer\", value = \"fe_importer_cfl_1\")\n\n  ch2_application1$fe_exporter_cfl_1 <- NULL\n  ch2_application1$fe_importer_cfl_1 <- NULL\n    \n  ch2_application1 <- ch2_application1 |>\n    left_join(fe_exporter_cfl_1, by = \"exporter\") |>\n    left_join(fe_importer_cfl_1, by = \"importer\")\n\n  # compute the conditional general equilibrium effects of trade\n  ch2_application1 <- ch2_application1 |>\n    mutate(tradehat_1 = predict(fit_counterfactual_app1_2, ch2_application1)) |>\n    group_by(exporter) |>\n    mutate(y_cfl_1 = sum(tradehat_1, na.rm = T)) |>\n    ungroup() |>\n    mutate(e_cfl_1 = ifelse(importer == exporter, phi * y_cfl_1, 0)) |>\n    group_by(importer) |>\n    mutate(e_cfl_1 = max(e_cfl_1, na.rm = T)) |>\n    ungroup() |>\n    mutate(\n      e_r_cfl_1 = ifelse(importer == paste0(\"0-\", ref_country), e_cfl_1, 0),\n      e_r_cfl_1 = max(e_r_cfl_1, na.rm = T)\n    )\n\n  # compute the change in prices for exporters and importers\n  ch2_application1 <- ch2_application1 |>\n    mutate(change_p_i_1 = ((exp(fe_exporter_cfl_1) / e_r_cfl_1) /\n      (exp(fe_exporter_cfl_0) / e_r_cfl_0))^(1 / (1 - sigma)))\n\n  # compute the change in prices for exporters and importers\n  ch2_application1 <- ch2_application1 |>\n    group_by(importer) |>\n    mutate(\n      change_p_j_1 = ifelse(importer == exporter, change_p_i_1, 0),\n      change_p_j_1 = max(change_p_j_1, na.rm = T)\n    ) |>\n    ungroup()\n\n  # compute both outward and inward multilateral resistance\n  ch2_application1 <- ch2_application1 |>\n    mutate(\n      omr_cfl_1 = (y_cfl_1 * e_r_cfl_1) / exp(fe_exporter_cfl_1),\n      imr_cfl_1 = e_cfl_1 / (exp(fe_importer_cfl_1) * e_r_cfl_1)\n    )\n\n  # update the differences\n  max_dif <- abs(max(ch2_application1$change_p_i_0 - change_price_i_old))\n  sd_dif <- sd(ch2_application1$change_p_i_0 - change_price_i_old)\n  change_price_i_old <- ch2_application1$change_p_i_0\n\n  # compute changes in outward and inward multilateral resistance\n  ch2_application1 <- ch2_application1 |>\n    mutate(\n      change_omr_full_1 = omr_cfl_1 / omr_cfl_0,\n      change_imr_full_1 = imr_cfl_1 / imr_cfl_0,\n      omr_cfl_0 = omr_cfl_1,\n      imr_cfl_0 = imr_cfl_1,\n      change_omr_full_0 = change_omr_full_1,\n      change_imr_full_0 = change_imr_full_1,\n      change_p_i_0 = change_p_i_1,\n      change_p_j_0 = change_p_j_1,\n      fe_exporter_cfl_0 = fe_exporter_cfl_1,\n      fe_importer_cfl_0 = fe_importer_cfl_1,\n      tradehat_0 = tradehat_1,\n      e_r_cfl_0 = e_r_cfl_1\n    ) |>\n    select(-c(fe_exporter_cfl_1, fe_importer_cfl_1))\n\n  i <- i + 1\n}\n```\n:::\n\n\nBox #1 from page 108 in @yotov2016advanced shows the steps to obtain different endowments, which can be divided into smaller pieces. We start computing the full endowment general equilibrium of factory-gate price (changes in $p_i^{full}$ and $p_j^{full}$) and the full endowment general equilibrium of output ($y^{full}$).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application1 <- ch2_application1 |>\n  mutate(\n    change_p_i_full = ((exp(fe_exporter_cfl_0) / e_r_cfl_0) /\n      (exp(fe_exporter_bln) / e_r))^(1 / (1 - sigma)),\n    change_p_j_full = change_p_i_full * (exporter == importer)\n  ) |>\n  group_by(importer) |>\n  mutate(change_p_j_full = max(change_p_j_full, na.rm = T)) |>\n  ungroup() |>\n  mutate(y_full = change_p_i_full * y)\n```\n:::\n\n\nWe compute the full endowment general equilibrium of aggregate expenditures ($e^{full}$ and $e_r^{full}$).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application1 <- ch2_application1 |>\n  mutate(e_full = change_p_j_full * e * (exporter == importer)) |>\n  group_by(importer) |>\n  mutate(e_full = max(e_full, na.rm = TRUE)) |>\n  ungroup() |>\n  mutate(\n    e_full_r = e_full * (importer == ref_country0),\n    e_full_r = max(e_full_r, na.rm = T)\n  )\n```\n:::\n\n\nWith the aggregate expenditure, we proceed to obtain the full endowment general equilibrium of the outward multilateral resistance ($OMR^{full}$) and inward multilateral resistance ($IMR^{full}$).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application1 <- ch2_application1 |>\n  mutate(\n    omr_full = y_full * e_r_cfl_0 / exp(fe_exporter_cfl_0),\n    imr_full = e_full / (exp(fe_importer_cfl_0) * e_full_r)\n  )\n```\n:::\n\n\nFinally, we proceed to compute the full endowment general equilibrium of trade ($\\xi^{full}$).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application1 <- ch2_application1 |>\n  mutate(x_full = (y_full * e_full * tij_cfl) / (imr_full * omr_full)) |>\n  group_by(exporter) |>\n  mutate(xi_full = sum(x_full * (importer != exporter), na.rm = T)) |>\n  ungroup()\n```\n:::\n\n\n### Step IV: Collect, construct, and report indexes of interest\n\nBox #1 from page 108 in @yotov2016advanced consists of constructing the percentage change of the general equilibrium indexes. The steps are direct, we need to compute the change in full endowment general equilibrium factory-gate price on the export side (changes in $p_i^{full}$), the change in conditional and full general equilibrium outward multilateral resistances (changes in $OMR^{CFL}$ and $OMR^{full}$), and the change in conditional and full general equilibrium international trade (changes in $\\xi^{CFL}$ and $\\xi^{full}$).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application1 <- ch2_application1 |>\n  mutate(\n    change_price_full = (change_p_i_full - 1) * 100,\n    change_omr_cfl = (omr_cfl^(1 / (1 - sigma)) / omr_bln^(1 / (1 - sigma)) - 1) * 100,\n    change_omr_full = (omr_full^(1 / (1 - sigma)) / omr_bln^(1 / (1 - sigma)) - 1) * 100,\n    change_xi_cfl = (xi_cfl / xi_bln - 1) * 100,\n    change_xi_full = (xi_full / xi_bln - 1) * 100\n  )\n```\n:::\n\n\nWe also need to do something very similar for the importers in order to be able to recreate figure 7 later.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application1 <- ch2_application1 |>\n  mutate(\n    change_imr_full = -(imr_full^(1 / (1 - sigma)) / imr_bln^(1 / (1 - sigma)) - 1) * 100,\n    rgdp = ((y_full / imr_full^(1 / (1 - sigma))) / (y / imr_bln^(1 / (1 - sigma))) - 1) * 100\n  )\n```\n:::\n\n\n### Figures replication\n\nWith all of the steps above, we are ready to create the plots from page 110. in @yotov2016advanced. Figure 6 removes the observations where both the importer and the exporter are different, and this can be seen in the original Stata code provided with the book.\n\nWe need to filter rows and to obtain $\\log(y)$.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application1 <- ch2_application1 |>\n  filter(exporter == importer) |>\n  select(\n    exporter, importer, y, change_xi_cfl, change_xi_full, rgdp,\n    change_price_full, change_imr_full\n  ) |>\n  mutate(log_y = log(y))\n```\n:::\n\n\nIn addition, the original code removes Hong Kong for visualization scale purposes.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_figure_6 <- ch2_application1 |>\n  filter(exporter != \"HKG\") |>\n  select(x = log_y, change_xi_cfl, change_xi_full) |>\n  pivot_longer(names_to = \"change\", values_to = \"y\", -x) |>\n  mutate(\n    change = case_when(\n      change == \"change_xi_cfl\" ~ \"Conditional general equilibrium\",\n      TRUE ~ \"Full endowment general equilibrium\"\n    )\n  )\n\nDT::datatable(\n  ch2_application1 |>\n    filter(exporter != \"HKG\") |>\n    select(exporter, log_y, change_xi_cfl, change_xi_full)\n)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"datatables html-widget html-fill-item\" id=\"htmlwidget-decf9d87dec39e3c1eee\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-decf9d87dec39e3c1eee\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"11\",\"12\",\"13\",\"14\",\"15\",\"16\",\"17\",\"18\",\"19\",\"20\",\"21\",\"22\",\"23\",\"24\",\"25\",\"26\",\"27\",\"28\",\"29\",\"30\",\"31\",\"32\",\"33\",\"34\",\"35\",\"36\",\"37\",\"38\",\"39\",\"40\",\"41\",\"42\",\"43\",\"44\",\"45\",\"46\",\"47\",\"48\",\"49\",\"50\",\"51\",\"52\",\"53\",\"54\",\"55\",\"56\",\"57\",\"58\",\"59\",\"60\",\"61\",\"62\",\"63\",\"64\",\"65\",\"66\",\"67\",\"68\"],[\"0-DEU\",\"ARG\",\"AUS\",\"AUT\",\"BEL\",\"BGR\",\"BOL\",\"BRA\",\"CAN\",\"CHE\",\"CHL\",\"CHN\",\"CMR\",\"COL\",\"CRI\",\"CYP\",\"DNK\",\"ECU\",\"EGY\",\"ESP\",\"FIN\",\"FRA\",\"GBR\",\"GRC\",\"HUN\",\"IDN\",\"IND\",\"IRL\",\"IRN\",\"ISL\",\"ISR\",\"ITA\",\"JOR\",\"JPN\",\"KEN\",\"KOR\",\"KWT\",\"LKA\",\"MAC\",\"MAR\",\"MEX\",\"MLT\",\"MMR\",\"MUS\",\"MWI\",\"MYS\",\"NER\",\"NGA\",\"NLD\",\"NOR\",\"NPL\",\"PAN\",\"PHL\",\"POL\",\"PRT\",\"QAT\",\"ROM\",\"SEN\",\"SGP\",\"SWE\",\"THA\",\"TTO\",\"TUN\",\"TUR\",\"TZA\",\"URY\",\"USA\",\"ZAF\"],[14.51255025933853,10.99476332329066,12.63066370015108,12.04605981951315,13.54406951697332,10.11392696312086,8.328442270026345,13.22246502426961,13.09191085778309,12.84938975209422,11.56762642486734,15.12702537161587,8.142149128757358,10.85905148856411,9.742713845635695,9.395181704999173,11.63205421786272,9.503197822730067,10.39602299168585,13.32185360433921,11.86891204212935,13.89414647237568,13.73823868829244,11.40953215673082,11.56310459308899,12.33909221060346,13.21497345625378,12.05742105979283,11.26404437484492,9.123344766668035,11.64068703724784,13.93496694517064,10.19636122947261,14.79566676919525,8.985910060025754,13.86947764174263,9.957216489764729,10.50724522443006,8.298637631810479,10.36228624755637,12.84351378761215,8.638632764898947,10.36623234449581,8.162755543154901,7.314413082860949,12.62943675524799,5.87692199833775,11.50663991384777,13.03625193954884,11.52093503221388,8.344199885749697,8.61135089909534,11.50632188272803,12.33857595808454,11.42591989865071,9.617680909556487,11.10191573926805,8.008967352186341,12.70629175001187,12.41894467191328,12.43984877106244,9.678842081652475,10.00025121685518,12.53486295584056,7.574686482334182,9.125859371502532,15.42893323354374,12.15729898185088],[133.388722378753,65.52422347823803,229.5592287014495,59.21193392169089,156.9112444865022,24.21949310089089,13.53877787975715,172.5608129819121,80.82462218363504,92.99682531052773,105.173618777733,175.4955670857313,7.642831434320119,83.65363590161547,84.90941033902904,59.06468586258982,65.93324656392008,65.89396318539866,61.86244197053523,149.7786848492594,77.92298518752001,118.7129694776871,214.111058040602,112.2068973781648,66.5230965109117,108.1167844281605,145.9798761798207,64.46514353896069,70.78749529306896,38.93250182417536,141.1148883740217,143.8764205611836,76.26535854712139,220.7947157825578,35.23423203046379,210.1790078125917,180.0894430099179,88.35515566590921,104.9588228139301,42.99750427775236,114.5538446873004,78.08919386435372,28.54912449306506,94.50401846773413,8.23107302645807,101.6251022074907,0.8675407701613347,109.7259320576228,120.0913423325301,59.36231627239672,6.9452300075451,74.93967509947055,80.43665885134052,83.15828452721452,72.99745727988886,169.6904037832924,52.90943408420365,24.2972942043729,230.0552826832303,76.56170728178842,139.5064154774308,93.8957196291627,31.71276139885715,113.063039953225,8.304922220961931,33.44034159378082,359.9822940248227,164.1128479322317],[190.7955321580687,118.1196389815866,300.2236182372143,111.2234974533151,218.83428987426,69.10148177440954,58.17657600405695,233.6008172664824,138.0842186488909,148.9324510092187,161.4873668756107,238.2471126834258,50.54671579242105,138.110476627673,138.9940566991052,110.0806876568311,119.3384417860523,118.0746332739106,113.6107390199007,209.4984645129293,131.4239595998478,177.2901773136845,279.7979960411885,168.6201646945292,117.8611581520297,169.1476124688376,212.4446096248983,116.4320550250545,124.5402578830023,88.08760326731151,199.4573437794229,202.6437314437403,129.9097413567621,293.4316699469062,83.90044801096512,287.5306949155801,243.4583262413056,146.04971709681,157.313183108072,91.87732423227008,174.7345383150857,131.4288807709416,80.29825669126913,151.8307001969996,52.08621208975315,162.9036595227966,42.25892244806582,167.082396763609,179.9548206121115,110.8055905534827,53.43152931943649,128.0069634541151,139.3158028354152,138.47544300258,125.4000231022343,232.8819045908769,102.8085642509636,70.72935703117005,303.7104788125687,129.5473484539944,203.1058660883007,149.5293654013504,78.93811030846798,169.6513722267887,51.99264382645694,81.04099544634167,440.9557409177688,226.9022521037473]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>exporter<\\/th>\\n      <th>log_y<\\/th>\\n      <th>change_xi_cfl<\\/th>\\n      <th>change_xi_full<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"columnDefs\":[{\"className\":\"dt-right\",\"targets\":[2,3,4]},{\"orderable\":false,\"targets\":0},{\"name\":\" \",\"targets\":0},{\"name\":\"exporter\",\"targets\":1},{\"name\":\"log_y\",\"targets\":2},{\"name\":\"change_xi_cfl\",\"targets\":3},{\"name\":\"change_xi_full\",\"targets\":4}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n\n```{.r .cell-code}\nggplot(data = data_figure_6) +\n  geom_point(aes(x = x, y = y, color = change)) +\n  labs(\n    x = \"Log value of output\",\n    y = \"Percent change of exports\",\n    title = \"Figure 6: Effects of abolishing international borders on exports\",\n    caption = \"Source: Authors' calculations\",\n    color = \"\"\n  ) +\n  theme_minimal() +\n  theme(legend.position = \"bottom\") +\n  scale_color_manual(values = c(\"#b6b8dd\", \"#232958\"))\n```\n\n::: {.cell-output-display}\n![](02-general-equilibrium_files/figure-html/ch2_app1_figures_2-2.png){width=672}\n:::\n:::\n\n\nTo create Figure 7, we proceed in the same way as Figure 6.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_figure_7 <- ch2_application1 |>\n  filter(exporter != \"HKG\") |>\n  select(x = log_y, change_imr_full, change_price_full, rgdp) |>\n  pivot_longer(names_to = \"change\", values_to = \"y\", -x) |>\n  mutate(\n    change = case_when(\n      change == \"change_imr_full\" ~ \"-(inward multilateral resistances)\",\n      change == \"change_price_full\" ~ \"Factory-gate price\",\n      TRUE ~ \"Real GDP\"\n    )\n  )\n\nDT::datatable(\n  ch2_application1 |>\n    filter(exporter != \"HKG\") |>\n    select(exporter, log_y, change_imr_full, change_price_full, rgdp)\n)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"datatables html-widget html-fill-item\" id=\"htmlwidget-7b0542b57f1b261b0fde\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-7b0542b57f1b261b0fde\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"11\",\"12\",\"13\",\"14\",\"15\",\"16\",\"17\",\"18\",\"19\",\"20\",\"21\",\"22\",\"23\",\"24\",\"25\",\"26\",\"27\",\"28\",\"29\",\"30\",\"31\",\"32\",\"33\",\"34\",\"35\",\"36\",\"37\",\"38\",\"39\",\"40\",\"41\",\"42\",\"43\",\"44\",\"45\",\"46\",\"47\",\"48\",\"49\",\"50\",\"51\",\"52\",\"53\",\"54\",\"55\",\"56\",\"57\",\"58\",\"59\",\"60\",\"61\",\"62\",\"63\",\"64\",\"65\",\"66\",\"67\",\"68\"],[\"0-DEU\",\"ARG\",\"AUS\",\"AUT\",\"BEL\",\"BGR\",\"BOL\",\"BRA\",\"CAN\",\"CHE\",\"CHL\",\"CHN\",\"CMR\",\"COL\",\"CRI\",\"CYP\",\"DNK\",\"ECU\",\"EGY\",\"ESP\",\"FIN\",\"FRA\",\"GBR\",\"GRC\",\"HUN\",\"IDN\",\"IND\",\"IRL\",\"IRN\",\"ISL\",\"ISR\",\"ITA\",\"JOR\",\"JPN\",\"KEN\",\"KOR\",\"KWT\",\"LKA\",\"MAC\",\"MAR\",\"MEX\",\"MLT\",\"MMR\",\"MUS\",\"MWI\",\"MYS\",\"NER\",\"NGA\",\"NLD\",\"NOR\",\"NPL\",\"PAN\",\"PHL\",\"POL\",\"PRT\",\"QAT\",\"ROM\",\"SEN\",\"SGP\",\"SWE\",\"THA\",\"TTO\",\"TUN\",\"TUR\",\"TZA\",\"URY\",\"USA\",\"ZAF\"],[14.51255025933853,10.99476332329066,12.63066370015108,12.04605981951315,13.54406951697332,10.11392696312086,8.328442270026345,13.22246502426961,13.09191085778309,12.84938975209422,11.56762642486734,15.12702537161587,8.142149128757358,10.85905148856411,9.742713845635695,9.395181704999173,11.63205421786272,9.503197822730067,10.39602299168585,13.32185360433921,11.86891204212935,13.89414647237568,13.73823868829244,11.40953215673082,11.56310459308899,12.33909221060346,13.21497345625378,12.05742105979283,11.26404437484492,9.123344766668035,11.64068703724784,13.93496694517064,10.19636122947261,14.79566676919525,8.985910060025754,13.86947764174263,9.957216489764729,10.50724522443006,8.298637631810479,10.36228624755637,12.84351378761215,8.638632764898947,10.36623234449581,8.162755543154901,7.314413082860949,12.62943675524799,5.87692199833775,11.50663991384777,13.03625193954884,11.52093503221388,8.344199885749697,8.61135089909534,11.50632188272803,12.33857595808454,11.42591989865071,9.617680909556487,11.10191573926805,8.008967352186341,12.70629175001187,12.41894467191328,12.43984877106244,9.678842081652475,10.00025121685518,12.53486295584056,7.574686482334182,9.125859371502532,15.42893323354374,12.15729898185088],[-0,11.29871718072581,5.639705763045644,10.81643810443929,2.947816872148001,14.51280984673479,17.29613710653453,2.09641594978921,14.20730368580315,7.51522421555072,6.726509091495458,-7.769146186675391,16.90951319020281,12.74455312260652,11.44541403932193,13.39841649062059,10.69448944171394,14.80407395911966,12.42985425588471,6.407175322528724,7.999405056674691,6.5327851766524,3.25206134945536,10.32492959265742,9.724029646159815,6.158178562181361,4.840956106008687,6.266233249214714,11.99659559513657,14.81740515190281,3.022948662541591,2.777213870054607,10.95428148234569,-9.21921180795926,15.15370720956514,-5.330775646529773,7.336298487351211,9.268745207519435,11.35612781074627,13.89536549574563,11.54085669263207,11.97536677984041,14.33875883182325,11.3372883353392,16.90595633088701,4.864231007109387,17.61745497051012,9.270772471887057,5.930337322895118,11.99136010415862,16.76368546467648,17.3035006093255,7.777995330685838,9.51991290560178,11.50068558143887,10.65377900474155,12.47603926992839,16.62602592187382,-10.97257226741544,7.544731017903894,1.247951978979056,8.205215851514536,14.27968571724499,7.804232218341378,17.11213765500766,14.42659977078664,-0.335024077964996,4.686721574025221],[24.3613280359277,32.15179189017672,21.3567955994197,32.96091495509867,23.98171123381618,36.27016874534845,39.41489189827207,22.59134562237908,32.36253871023522,29.2926997133733,27.9672924888305,23.23883844232364,39.91361612989992,30.10273911461967,29.77106677982622,32.31477502669624,32.50669016523,31.8109567088785,32.24785377388535,23.86402899411899,30.40451049437394,27.07877992345104,20.1127300305878,26.72635885246961,31.08337016538776,29.78408965329928,27.43833007799697,32.12547602769513,31.7805268869451,35.62719269285041,24.07326691036005,23.90099768688936,30.73182352769881,22.73827057538416,36.19179717383323,25.63293745417734,22.45597128354177,31.02014337083303,26.18869643371626,34.42865913133115,29.00086242062478,30.21584593644901,40.45455855207683,29.80515512517297,40.58188451220992,30.95850960129645,41.12555612885362,27.68598164588865,27.5454409130983,32.55301873478346,43.52165478137098,30.64861294920924,33.18398636594632,30.52841302776081,30.6106795316615,23.40122045906696,32.87014909197177,37.51401224927579,20.58729657809653,30.33828720486704,26.9138563753349,29.31726028696842,36.04750018584492,26.74321092356035,40.39801390764994,35.88781210364842,10.97237729216705,23.94159772030246],[24.3613280359277,48.98520933392976,28.61002244723046,49.08679596224679,27.74747279047654,59.4041967001574,68.57119730653767,25.21640225091959,54.28182630545449,39.79890053981514,37.19577903903952,14.35447231701361,68.38704586022803,49.10557881553552,46.54358706781143,52.78563008304098,48.37459562895427,54.71509358983955,51.01933729826229,32.34350968780439,41.74311652517726,35.96080739500911,24.15016971517836,41.31726719234698,45.20294786264982,38.30090642400486,33.92140658744458,40.95824867359039,49.74480564488524,59.21937214369801,27.94085322166879,27.44028701387613,46.81427215591476,12.37791277160611,60.51590787851935,19.27467227221207,32.15096017595012,44.40464167557337,42.35467530604345,56.1224432404845,45.83101033704005,47.93114287765836,63.96512195792916,46.40332185656661,69.18406940456288,37.65433441872197,71.30516674173629,40.73301969459011,35.58615741070461,50.6136430373888,72.42672934595606,57.98566313188125,44.41671143835133,44.26203291734237,47.58383202149223,38.115769289913,51.81002777256636,64.93637705264872,8.664054652632602,40.97442865058014,28.51769549966117,40.8764795152057,58.7109208875295,37.47183192152404,69.38307966405419,58.79678935237462,10.60183451586789,30.0360241165788]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>exporter<\\/th>\\n      <th>log_y<\\/th>\\n      <th>change_imr_full<\\/th>\\n      <th>change_price_full<\\/th>\\n      <th>rgdp<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"columnDefs\":[{\"className\":\"dt-right\",\"targets\":[2,3,4,5]},{\"orderable\":false,\"targets\":0},{\"name\":\" \",\"targets\":0},{\"name\":\"exporter\",\"targets\":1},{\"name\":\"log_y\",\"targets\":2},{\"name\":\"change_imr_full\",\"targets\":3},{\"name\":\"change_price_full\",\"targets\":4},{\"name\":\"rgdp\",\"targets\":5}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n\n```{.r .cell-code}\nggplot(data = data_figure_7) +\n  geom_point(aes(x = x, y = y, color = change)) +\n  labs(\n    x = \"Log value of output\",\n    y = \"Percent changes\",\n    title = \"Figure 7: Effects of abolishing international borders on real GDP\",\n    caption = \"Note: The inward multilateral resistances have been reformulated by multiplying their value by minus one.\\nSource: Authors' calculations\",\n    color = \"\"\n  ) +\n  theme_minimal() +\n  theme(legend.position = \"bottom\") +\n  scale_color_manual(values = c(\"#3bade3\", \"#b6b8dd\", \"#232958\"))\n```\n\n::: {.cell-output-display}\n![](02-general-equilibrium_files/figure-html/ch2_app1_figures_3-2.png){width=672}\n:::\n:::\n\n\n## Impact of regional trade agreements\n\n### Initial data\n\nAs in the previous application, we shall proceed by alternating both data transforming and regressions. To replicate the results from box #1 on page 112 in @yotov2016advanced, we need to convert \"DEU\" in both exporter and importer columns to \"0-DEU\", as in the previous section. \n\nWe start by defining some parameters to simplify the code.  As the notes in the original Stata code say, the criteria of convergence ($\\sigma = 7$) was taken from the literature.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nref_country <- \"DEU\"\nref_country0 <- paste0(\"0-\", ref_country)\ncountries_rta <- c(\"MEX\", \"USA\", \"CAN\")\nyear_rta <- 1994\nsigma <- 7\nmax_dif <- 1\nsd_dif <- 1\nchange_price_i_old <- 0\n```\n:::\n\n\nIn this case, we shall keep the panel dimension of the dataset to identify the effects of RTAs and comprehensively capture the impact of all time-invariant trade costs with the use of pair fixed effects.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application2 <- agtpa_applications |>\n  select(exporter, importer, pair_id, year, trade, dist, cntg, lang, clny, rta) |>\n  filter(year %in% seq(1986, 2006, 4)) |>\n  mutate(\n    log_dist = log(dist),\n    intl = ifelse(exporter != importer, 1, 0),\n    exporter = ifelse(exporter == ref_country, ref_country0, exporter),\n    importer = ifelse(importer == ref_country, ref_country0, importer)\n  ) |>\n  # Create Yit\n  group_by(exporter, year) |>\n  mutate(y = sum(trade, na.rm = T)) |>\n  # Create Eit\n  group_by(importer, year) |>\n  mutate(e = sum(trade, na.rm = T)) |>\n  # Create Er\n  group_by(year) |>\n  mutate(e_r = max(ifelse(importer == ref_country0, e, NA), na.rm = T)) |>\n  arrange(importer)\n```\n:::\n\n\nBecause of the panel dimension, we proceed as we did in the previous chapter by creating columns to combine exporter/importer and year alongside a pairing variable for the internal dyads for the fixed effects.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application2 <- ch2_application2 |>\n  mutate(\n    exp_year = paste0(exporter, year),\n    imp_year = paste0(importer, year),\n    pair_id_2 = ifelse(exporter == importer, \"0-domestic\", pair_id)\n  )\n```\n:::\n\n\nIn addition, we need to compute the trade sum to filter the cases where the sum by dyad is zero.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application2 <- ch2_application2 |>\n  group_by(pair_id) |>\n  mutate(sum_trade = sum(trade, na.rm = T)) |>\n  ungroup()\n```\n:::\n\n\n### Step 1: Solve the baseline gravity model\n\n#### Stage 1: Obtain the estimates of pair fixed effects and the effects of RTAs\n\nWith the steps done before, it is straightforward to obtain the PPML regression shown in box #1 from page 112 in @yotov2016advanced.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_baseline_app2 <- fepoisson(\n  trade ~ rta | exp_year + imp_year + pair_id_2,\n  data = filter(ch2_application2, sum_trade > 0),\n  control = list(iter_max = 500)\n)\n```\n:::\n\n\nWe can construct the variables for exporter-time, importer-time, and internal dyads with the estimated fixed effects from the model.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfe_exporter_bln <- fit_baseline_app2$fixed_effects$exp_year |>\n  tibble::enframe(name = \"exp_year\", value = \"fe_exporter_bln\")\n\nfe_importer_bln <- fit_baseline_app2$fixed_effects$imp_year |>\n  tibble::enframe(name = \"imp_year\", value = \"fe_importer_bln\")\n\nfe_pair_id_2_bln <- fit_baseline_app2$fixed_effects$pair_id_2 |>\n  tibble::enframe(name = \"pair_id_2\", value = \"fe_pair_id_2_bln\")\n\nch2_application2 <- ch2_application2 |>\n  left_join(fe_exporter_bln, by = \"exp_year\") |>\n  left_join(fe_importer_bln, by = \"imp_year\") |>\n  left_join(fe_pair_id_2_bln, by = \"pair_id_2\")\n```\n:::\n\n\n#### Stage 2: Regress the estimates of pair fixed effects on gravity variables and country fixed effects\n\nBox #1 from page 113 in @yotov2016advanced can be divided into smaller chunks. \nWe start by filtering to keep the observation from 1994, and then we compute the trade costs ($\\bar{t}_{ij}$ and $t_{ij}^{BLN}$) from the internal dyads fixed effects and the estimated RTA coefficient.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application2 <- ch2_application2 |>\n  mutate(\n    tij_bar = exp(fe_pair_id_2_bln),\n    tij_bln = exp(fe_pair_id_2_bln + fit_baseline_app2$coef_table[\"rta\", 1] * rta)\n  )\n```\n:::\n\n\nWe need to create a table for the year 1994 and international flows, which we will use to predict the trade costs for the observations with zero trade flows. The reason to create a sub-table, instead of filtering observations in the regression function, is that it eases posterior work to predict the costs.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application2_2 <- ch2_application2 |>\n  filter(year == year_rta, exporter != importer)\n```\n:::\n\n\nNow, unlike the book, which duplicates $\\overline{t_{ij}}$ by creating $t_{ij}$, we can fit a regression to estimate the costs. This is something that emerges from the small differences between expressing an idea in Stata or R.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_costs_app2 <- fepoisson(\n  tij_bar ~ log_dist + cntg + lang + clny | exporter + importer,\n  data = ch2_application2_2,\n  control = list(iter_max = 500)\n)\n```\n:::\n\n\nWith the regression, we add the fitted values to the sub-table.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application2_2 <- ch2_application2_2 |>\n  mutate(tij_no_rta = predict(fit_costs_app2, newdata = ch2_application2_2)) |>\n  select(exporter, importer, tij_no_rta)\n```\n:::\n\n\nThe final step is to keep the observations for the year 1994 in the original table and replace the missing costs with the predicted values.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application2 <- ch2_application2 |>\n  filter(year == year_rta) |>\n  left_join(ch2_application2_2, by = c(\"exporter\", \"importer\")) |>\n  mutate(\n    tij_bar = ifelse(is.na(tij_bar), tij_no_rta, tij_bar),\n    tij_bln = ifelse(is.na(tij_bln), tij_bar * exp(fit_baseline_app2$coef_table[\"rta\", 1] * rta), tij_bln)\n  ) |>\n  select(-tij_no_rta)\n```\n:::\n\n\nBox #2 from page 113 in @yotov2016advanced is easier to replicate. The first part of completing Box #2 involves solving the constrained baseline gravity model.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_constrained_app2 <- fepoisson(\n  trade ~ 0 | exporter + importer,\n  data = ch2_application2,\n  offset = ~ log(tij_bln),\n  control = list(iter_max = 500)\n)\n```\n:::\n\n\nWith the fitted model, we can add the prediction and the $\\xi^{BLN}$ column.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application2 <- ch2_application2 |>\n  mutate(tradehat_bln = predict(fit_constrained_app2, ch2_application2)) |>\n  group_by(exporter) |>\n  mutate(xi_bln = sum(tradehat_bln * (exporter != importer), na.rm = T)) |>\n  ungroup()\n```\n:::\n\n\nThe book specifies that all other baseline indexes of interest can be obtained by applying the same procedure described in the previous application. Here we will obtain the multilateral resistances terms ($OMR^{BLN}$ and $IMR^{BLN}$) by adding the fixed effects from the constrained model to the data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfe_exporter_cns <- fit_constrained_app2$fixed_effects$exporter |>\n  tibble::enframe(name = \"exporter\", value = \"fe_exporter_cns\")\n\nfe_importer_cns <- fit_constrained_app2$fixed_effects$importer |>\n  tibble::enframe(name = \"importer\", value = \"fe_importer_cns\")\n\nch2_application2 <- ch2_application2 |>\n  left_join(fe_exporter_cns, by = \"exporter\") |>\n  left_join(fe_importer_cns, by = \"importer\")\n\nch2_application2 <- ch2_application2 |>\n  mutate(\n    omr_bln = y * e_r / exp(fe_exporter_cns),\n    imr_bln = e / (exp(fe_importer_cns) * e_r)\n  )\n```\n:::\n\n\n### Step II: Define a counterfactual scenario\n\nBox #1 from page 114 in @yotov2016advanced is direct and consists in replacing the RTA values by zero if the pairs of countries are NAFTA members.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application2 <- ch2_application2 |>\n  mutate(\n    rta_no_nafta = ifelse(exporter %in% countries_rta & importer %in% countries_rta, 0, rta),\n    tij_cfl = tij_bar * exp(fit_baseline_app2$coef_table[\"rta\", 1] * rta_no_nafta)\n  )\n```\n:::\n\n\n### Step III: Solve the counterfactual model\n\nThe same procedure from the previous section applies to obtain the conditional general equilibrium effects and then compute the full endowment general equilibrium effects. We start by fitting a counterfactual model.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_counterfactual_app2 <- fepoisson(\n  trade ~ 0 | exporter + importer,\n  data = ch2_application2,\n  offset = ~ log(tij_cfl),\n  control = list(iter_max = 500)\n)\n```\n:::\n\n\nWith the fitted model we add the fixed effects.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfe_exporter_cfl <- fit_counterfactual_app2$fixed_effects$exporter |>\n  tibble::enframe(name = \"exporter\", value = \"fe_exporter_cfl\")\n\nfe_importer_cfl <- fit_counterfactual_app2$fixed_effects$importer |>\n  tibble::enframe(name = \"importer\", value = \"fe_importer_cfl\")\n\nch2_application2 <- ch2_application2 |>\n  left_join(fe_exporter_cfl, by = \"exporter\") |>\n  left_join(fe_importer_cfl, by = \"importer\")\n```\n:::\n\n\nAs we did in stage 2, we compute the multilateral resistance terms.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application2 <- ch2_application2 |>\n  mutate(\n    omr_cfl = y * e_r / exp(fe_exporter_cfl),\n    imr_cfl = e / (exp(fe_importer_cfl) * e_r)\n  )\n```\n:::\n\n\nUp to this point, we are ready to compute the conditional general equilibrium effects of trade.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application2 <- ch2_application2 |>\n  mutate(tradehat_cfl = predict(fit_counterfactual_app2, ch2_application2)) |>\n  group_by(exporter) |>\n  mutate(xi_cfl = sum(tradehat_cfl * (exporter != importer), na.rm = T)) |>\n  ungroup()\n```\n:::\n\n\nNow we are going to compute the full endowment general equilibrium effects. We start by repeating the steps to obtain changes in $t_{ij}$ $\\phi$ from the last section.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application2 <- ch2_application2 |>\n  mutate(\n    change_tij = tij_cfl / tij_bln,\n    phi = ifelse(importer == exporter, e / y, 0)\n  ) |>\n  group_by(exporter) |>\n  mutate(phi = max(phi, na.rm = T)) |>\n  ungroup()\n```\n:::\n\n\nNow we compute changes in $p_i$, $p_j$ and $trade^{CFL}$, which is just a repetition of the previous steps with some adaptation.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application2 <- ch2_application2 |>\n  group_by(exporter) |>\n  mutate(change_p_i = ((exp(fe_exporter_cfl) / e_r) / (exp(fe_exporter_cns) / e_r))^(1 / (1 - sigma))) |>\n  ungroup() |>\n  group_by(importer) |>\n  mutate(\n    change_p_j = ifelse(importer == exporter, change_p_i, 0),\n    change_p_j = max(change_p_j, na.rm = T)\n  ) |>\n  ungroup()\n\nch2_application2 <- ch2_application2 |>\n  mutate(trade_cfl = tradehat_cfl * change_p_i * change_p_j)\n```\n:::\n\n\nThen we need a `while()` loop, but before, we need to duplicate some columns under new names for the loop operations.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application2 <- ch2_application2 |>\n  mutate(\n    omr_cfl_0 = omr_cfl,\n    imr_cfl_0 = imr_cfl,\n    change_imr_full_0 = 1,\n    change_omr_full_0 = 1,\n    change_p_i_0 = change_p_i,\n    change_p_j_0 = change_p_j,\n    fe_exporter_cfl_0 = fe_exporter_cfl,\n    fe_importer_cfl_0 = fe_importer_cfl,\n    tradehat_0 = tradehat_cfl,\n    e_r_cfl_0 = e_r\n  )\n```\n:::\n\n\nFurthermore, now we run the loop, where the step $N$ depends on the step $N-1$ as in the previous section.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ni2 <- 1\nwhile (sd_dif > 1e-3 | max_dif > 1e-3) {\n  ch2_application2 <- ch2_application2 |>\n    mutate(trade_1 = tradehat_0 * change_p_i_0 * change_p_j_0 / (change_omr_full_0 * change_imr_full_0))\n\n  # repeat the counterfactual model\n  fit_counterfactual_app2_2 <- fepoisson(\n    trade_1 ~ 0 | exporter + importer,\n    data = ch2_application2,\n    offset = ~ log(tij_cfl),\n    control = list(iter_max = 500)\n  )\n\n  fe_exporter_cfl <- fit_counterfactual_app2_2$fixed_effects$exporter |>\n    tibble::enframe(name = \"exporter\", value = \"fe_exporter_cfl\")\n\n  fe_importer_cfl <- fit_counterfactual_app2_2$fixed_effects$importer |>\n    tibble::enframe(name = \"importer\", value = \"fe_importer_cfl\")\n\n  ch2_application2$fe_exporter_cfl <- NULL\n  ch2_application2$fe_importer_cfl <- NULL\n\n  ch2_application2 <- ch2_application2 |>\n    left_join(fe_exporter_cfl, by = \"exporter\") |>\n    left_join(fe_importer_cfl, by = \"importer\")\n\n  # compute the conditional general equilibrium effects of trade\n  ch2_application2 <- ch2_application2 |>\n    mutate(tradehat_1 = predict(fit_counterfactual_app2_2, ch2_application2)) |>\n    group_by(exporter) |>\n    mutate(y_cfl_1 = sum(tradehat_1, na.rm = T)) |>\n    ungroup() |>\n    mutate(e_cfl_1 = ifelse(importer == exporter, phi * y_cfl_1, 0)) |>\n    group_by(importer) |>\n    mutate(e_cfl_1 = max(e_cfl_1, na.rm = T)) |>\n    ungroup() |>\n    mutate(\n      e_r_cfl_1 = ifelse(importer == ref_country0, e_cfl_1, 0),\n      e_r_cfl_1 = max(e_r_cfl_1, na.rm = T)\n    )\n\n  # compute the change in prices for exporters and importers\n  ch2_application2 <- ch2_application2 |>\n    mutate(change_p_i_1 = ((exp(fe_exporter_cfl) / e_r_cfl_1) /\n      (exp(fe_exporter_cfl_0) / e_r_cfl_0))^(1 / (1 - sigma)))\n\n  # compute the change in prices for exporters and importers\n  ch2_application2 <- ch2_application2 |>\n    group_by(importer) |>\n    mutate(\n      change_p_j_1 = ifelse(importer == exporter, change_p_i_1, 0),\n      change_p_j_1 = max(change_p_j_1, na.rm = T)\n    ) |>\n    ungroup()\n\n  # compute both outward and inward multilateral resistance\n  ch2_application2 <- ch2_application2 |>\n    mutate(\n      omr_cfl_1 = (y_cfl_1 * e_r_cfl_1) / exp(fe_exporter_cfl),\n      imr_cfl_1 = e_cfl_1 / (exp(fe_importer_cfl) * e_r_cfl_1)\n    )\n\n  # update the differences\n  max_dif <- abs(max(ch2_application2$change_p_i_0 - change_price_i_old, na.rm = T))\n  sd_dif <- sd(ch2_application2$change_p_i_0 - change_price_i_old)\n  change_price_i_old <- ch2_application2$change_p_i_0\n\n  # compute changes in outward and inward multilateral resistance\n  ch2_application2 <- ch2_application2 |>\n    mutate(\n      change_omr_full_1 = omr_cfl_1 / omr_cfl_0,\n      change_imr_full_1 = imr_cfl_1 / imr_cfl_0,\n      omr_cfl_0 = omr_cfl_1,\n      imr_cfl_0 = imr_cfl_1,\n      change_omr_full_0 = change_omr_full_1,\n      change_imr_full_0 = change_imr_full_1,\n      change_p_i_0 = change_p_i_1,\n      change_p_j_0 = change_p_j_1,\n      fe_exporter_cfl_0 = fe_exporter_cfl,\n      fe_importer_cfl_0 = fe_importer_cfl,\n      tradehat_0 = tradehat_1,\n      e_r_cfl_0 = e_r_cfl_1\n    ) |>\n    select(-fe_exporter_cfl, -fe_importer_cfl)\n\n  i2 <- i2 + 1\n}\n```\n:::\n\n\nThe last loop allows us to obtain changes in $p_i^{full}$, $p_j^{full}$ and $y^{full}$.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application2 <- ch2_application2 |>\n  mutate(\n    change_p_i_full = ((exp(fe_exporter_cfl_0) / e_r_cfl_0) /\n      (exp(fe_exporter_cns) / e_r))^(1 / (1 - sigma)),\n    change_p_j_full = change_p_i_full * (exporter == importer)\n  ) |>\n  group_by(importer) |>\n  mutate(change_p_j_full = max(change_p_j_full, na.rm = T)) |>\n  ungroup() |>\n  mutate(y_full = change_p_i_full * y)\n```\n:::\n\n\nNow we compute $e^{full} and $e_r^{full}$.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application2 <- ch2_application2 |>\n  mutate(e_full = change_p_j_full * e * (exporter == importer)) |>\n  group_by(importer) |>\n  mutate(e_full = max(e_full, na.rm = T)) |>\n  ungroup() |>\n  mutate(\n    e_full_r = e_full * (importer == ref_country0),\n    e_full_r = max(e_full_r, na.rm = T)\n  )\n```\n:::\n\n\nWe also need `omr_full` and `imr_full`. This part of the code needs *attention* because the IMR full term is computed in a different way compared to the previous section. Please see the script *RTAsEffects.do*.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application2 <- ch2_application2 |>\n  mutate(\n    omr_full = y_full * e_r_cfl_0 / exp(fe_exporter_cfl_0),\n    imr_full = e_cfl_1 / (exp(fe_importer_cfl_0) * e_r_cfl_0)\n  )\n```\n:::\n\n\nTo complete this step, we compute $\\xi^{full}$.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch2_application2 <- ch2_application2 |>\n  mutate(x_full = (y_full * e_full * tij_cfl) / (imr_full * omr_full)) |>\n  group_by(exporter) |>\n  mutate(xi_full = sum(x_full * (importer != exporter), na.rm = T)) |>\n  ungroup()\n```\n:::\n\n\n### Step IV: Collect, construct, and report indexes of interest\n\nThis step aims to reproduce the table from page 116 in @yotov2016advanced.\n\nTo ease the task of creating the table from the book, we divide between exporter and importer indexes.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexporter_indexes <- ch2_application2 |>\n  select(\n    exporter, starts_with(\"omr_\"), change_p_i_full,\n    starts_with(\"xi_\"), y, y_full\n  ) |>\n  distinct() |>\n  mutate(exporter = ifelse(exporter == ref_country0, ref_country, exporter)) |>\n  arrange(exporter) |>\n  mutate(\n    change_p_i_full = (1 - change_p_i_full) * 100,\n    change_omr_cfl = ((omr_bln / omr_cfl)^(1 / (1 - sigma)) - 1) * 100,\n    change_omr_full = ((omr_bln / omr_full)^(1 / (1 - sigma)) - 1) * 100,\n    change_xi_cfl = (xi_bln / xi_cfl - 1) * 100,\n    change_xi_full = (xi_bln / xi_full - 1) * 100\n  ) |>\n  select(exporter, starts_with(\"change\"), starts_with(\"y\"))\n\nimporter_indexes <- ch2_application2 |>\n  select(importer, imr_bln, imr_cfl, imr_full) |>\n  distinct() |>\n  mutate(importer = ifelse(importer == ref_country0, ref_country, importer)) |>\n  arrange(importer) |>\n  mutate(\n    change_imr_cfl = ((imr_bln / imr_cfl)^(1 / (1 - sigma)) - 1) * 100,\n    change_imr_full = ((imr_bln / imr_full)^(1 / (1 - sigma)) - 1) * 100\n  )\n```\n:::\n\n\nFinally, we can replicate the table that we wanted to. Instead of printing the raw table, we format it as HTML in a separate chunk. Note that this result matches the Stata\ncode but in the book flipped the GDP and OMR columns.\n\n\n::: {.cell}\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"datatables html-widget html-fill-item\" id=\"htmlwidget-4b9d9ef98c9c5304b36b\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-4b9d9ef98c9c5304b36b\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"11\",\"12\",\"13\",\"14\",\"15\",\"16\",\"17\",\"18\",\"19\",\"20\",\"21\",\"22\",\"23\",\"24\",\"25\",\"26\",\"27\",\"28\",\"29\",\"30\",\"31\",\"32\",\"33\",\"34\",\"35\",\"36\",\"37\",\"38\",\"39\",\"40\",\"41\",\"42\",\"43\",\"44\",\"45\",\"46\",\"47\",\"48\",\"49\",\"50\",\"51\",\"52\",\"53\",\"54\",\"55\",\"56\",\"57\",\"58\",\"59\",\"60\",\"61\",\"62\",\"63\",\"64\",\"65\",\"66\",\"67\",\"68\",\"69\"],[\"ARG\",\"AUS\",\"AUT\",\"BEL\",\"BGR\",\"BOL\",\"BRA\",\"CAN\",\"CHE\",\"CHL\",\"CHN\",\"CMR\",\"COL\",\"CRI\",\"CYP\",\"DEU\",\"DNK\",\"ECU\",\"EGY\",\"ESP\",\"FIN\",\"FRA\",\"GBR\",\"GRC\",\"HKG\",\"HUN\",\"IDN\",\"IND\",\"IRL\",\"IRN\",\"ISL\",\"ISR\",\"ITA\",\"JOR\",\"JPN\",\"KEN\",\"KOR\",\"KWT\",\"LKA\",\"MAC\",\"MAR\",\"MEX\",\"MLT\",\"MMR\",\"MUS\",\"MWI\",\"MYS\",\"NER\",\"NGA\",\"NLD\",\"NOR\",\"NPL\",\"PAN\",\"PHL\",\"POL\",\"PRT\",\"QAT\",\"ROM\",\"SEN\",\"SGP\",\"SWE\",\"THA\",\"TTO\",\"TUN\",\"TUR\",\"TZA\",\"URY\",\"USA\",\"ZAF\"],[-0.66,-0.49,-0.07000000000000001,-0.09,-0.05,-0.47,-0.65,34.99,-0.14,-0.8100000000000001,-0.34,-0.13,-1.8,-1.03,-0.09,-0.14,-0.06,-0.93,-0.31,-0.13,-0.09,-0.13,-0.23,-0.08,-0.2,-0.04,-0.19,-0.3,-0.1,-0.13,-0.23,-0.38,-0.12,-0.28,-0.35,-0.22,-0.41,-0.23,-0.3,-0.21,-0.08,41.64,-0.13,-0.09,-0.06,-0.18,-0.22,-0.11,-0.37,-0.07000000000000001,-0.24,-0.22,-0.6,-0.29,-0.05,-0.06,-0.19,-0.08,-0.08,-0.15,-0.11,-0.25,-0.86,-0.04,-0.14,-0.16,-0.42,14.48,-0.31],[-0.6899999999999999,-0.51,-0.1,-0.12,-0.07000000000000001,-0.48,-0.6899999999999999,37.46,-0.17,-0.83,-0.38,-0.16,-1.73,-1.04,-0.11,-0.17,-0.09,-0.89,-0.33,-0.15,-0.11,-0.15,-0.25,-0.11,-0.23,-0.07000000000000001,-0.24,-0.33,-0.13,-0.16,-0.25,-0.41,-0.15,-0.3,-0.42,-0.24,-0.45,-0.26,-0.33,-0.24,-0.1,43.51,-0.15,-0.19,-0.09,-0.19,-0.27,-0.13,-0.39,-0.09,-0.25,-0.25,-0.62,-0.33,-0.07000000000000001,-0.08,-0.22,-0.1,-0.11,-0.19,-0.13,-0.29,-0.88,-0.07000000000000001,-0.16,-0.17,-0.44,14.88,-0.34],[-0.01,-0.01,-0.01,-0,-0,-0.02,-0.01,3.4,-0.01,-0.03,-0.01,-0.01,-0.03,-0.07000000000000001,-0,-0.01,-0.01,-0.02,-0.01,-0.01,-0.01,-0.01,-0.01,-0,-0.02,-0,-0.01,-0.01,-0.03,-0,-0.01,-0.02,-0.01,-0,-0.01,-0,-0.02,-0.01,-0.01,-0.05,-0,3.81,-0.02,-0,-0.01,-0.01,-0.03,-0.02,-0,-0.01,-0.01,-0.01,-0.02,-0.03,-0,-0,-0.01,-0,-0,-0.03,-0.01,-0.01,-0.08,-0,-0,-0.01,-0.02,0.33,-0.01],[0.01,0.02,0,0,0,0.03,-0,-1.48,0,0.01,-0.01,0.01,0.09,0.06,0.01,0,0,0.08,0.02,0,-0,0,0.01,0.01,0.01,-0,-0,0.01,0.01,0.01,0.02,0.02,0,0.02,-0.02,0.02,-0.01,0.01,0.02,0.02,0,-2.4,0.01,0.01,0.01,0.02,0.01,0.02,0.03,0,0.02,0.02,0.02,0.01,0,0,0.01,0,0.01,0.01,0,-0,0.02,0,0,0.02,0.01,-0.18,0.01],[0,-0.01,0.01,0,0,-0.01,0.02,-2.14,0.01,0.03,0.03,-0,-0.07000000000000001,0.01,-0.01,0.01,0.01,-0.06,-0.02,0.01,0.01,0.01,0.01,-0,0.01,0.01,0.01,0,0.02,-0.01,-0.01,0,0.01,-0.02,0.03,-0.02,0.03,0,-0.01,0.03,-0,-1.52,0.01,-0.01,0,-0.01,0.03,0.01,-0.03,0.01,-0,-0.01,-0,0.02,0,0,0.01,0,-0.01,0.02,0.01,0.02,0.07000000000000001,-0,0,-0.01,0.01,-0.17,-0],[-0,0.01,-0.01,-0,-0,0.01,-0.01,1.84,-0.01,-0.03,-0.02,0,0.06,-0.01,0.01,-0.01,-0.01,0.05,0.01,-0.01,-0.01,-0,-0,0,-0.01,-0,-0.01,-0,-0.02,0.01,0.01,-0,-0.01,0.02,-0.03,0.02,-0.02,-0,0,-0.02,0,1.3,-0.01,0.01,-0,0.01,-0.02,-0.01,0.02,-0.01,0,0.01,0,-0.02,-0,-0,-0.01,-0,0.01,-0.02,-0.01,-0.01,-0.06,0,-0,0.01,-0.01,0.15,0]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>exporter<\\/th>\\n      <th>change_xi_cfl<\\/th>\\n      <th>change_xi_full<\\/th>\\n      <th>change_rgdp_full<\\/th>\\n      <th>change_imr_full<\\/th>\\n      <th>change_omr_full<\\/th>\\n      <th>change_p_i_full<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"scrollX\":true,\"columnDefs\":[{\"className\":\"dt-right\",\"targets\":[2,3,4,5,6,7]},{\"orderable\":false,\"targets\":0},{\"name\":\" \",\"targets\":0},{\"name\":\"exporter\",\"targets\":1},{\"name\":\"change_xi_cfl\",\"targets\":2},{\"name\":\"change_xi_full\",\"targets\":3},{\"name\":\"change_rgdp_full\",\"targets\":4},{\"name\":\"change_imr_full\",\"targets\":5},{\"name\":\"change_omr_full\",\"targets\":6},{\"name\":\"change_p_i_full\",\"targets\":7}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n## References\n",
    "supporting": [
      "02-general-equilibrium_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"site_libs/htmltools-fill-0.5.8.1/fill.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/htmlwidgets-1.6.4/htmlwidgets.js\"></script>\n<link href=\"site_libs/datatables-css-0.0.0/datatables-crosstalk.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/datatables-binding-0.34.0/datatables.js\"></script>\n<script src=\"site_libs/jquery-3.6.0/jquery-3.6.0.min.js\"></script>\n<link href=\"site_libs/dt-core-1.13.6/css/jquery.dataTables.min.css\" rel=\"stylesheet\" />\n<link href=\"site_libs/dt-core-1.13.6/css/jquery.dataTables.extra.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/dt-core-1.13.6/js/jquery.dataTables.min.js\"></script>\n<link href=\"site_libs/crosstalk-1.2.2/css/crosstalk.min.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/crosstalk-1.2.2/js/crosstalk.min.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}