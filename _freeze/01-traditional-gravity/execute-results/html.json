{
  "hash": "8c9d51777d1bf869f863246317dcc28c",
  "result": {
    "engine": "knitr",
    "markdown": "---\nbibliography: 00-references.bib\n---\n\n# Partial equilibrium trade policy analysis with structural gravity\n\n## Traditional gravity estimates\n\n### Preparing the data\n\nIf the reader has never used R before, please check chapters 1 to 25 from @wickham2016r.\n\nIf the reader has only fitted a few regressions in R, without much practice on transforming and cleaning data before, please check chapters 5 and 18 from @wickham2016r.\n\nPlease see the note from page 42 in @yotov2016advanced. It is a really important note, which tells us that we need to:\n\n1. Filter observations for a range of years (1986, 1990, 1994, 1998, 2002 and 2006)\n2. Transform some variables to logarithm scale (trade and dist) and create new variables from those in the original dataset\n3. Remove cases where both the exporter and the importer are the same\n4. Drop observations where the trade flow is zero\n\nUnlike @yotov2016advanced, here we shall use a single dataset for all the applications and subset its columns depending on what we need. This decision kept the *tradepolicy* R package as light as possible.\n\nBefore conducting any data filtering or regression, we need to load the required packages.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# dataset\nlibrary(tradepolicy)\n\n# data transformation\nlibrary(dplyr)\nlibrary(tidyr)\n\n# regression\nlibrary(capybara)\n\n# delta method\nlibrary(msm)\n```\n:::\n\n\nStep 1, including subsetting columns for this application, is straightforward.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch1_application1 <- agtpa_applications |>\n  select(exporter, importer, pair_id, year, trade, dist, cntg, lang, clny) |>\n  filter(year %in% seq(1986, 2006, 4))\n```\n:::\n\n\nFor step 2, this can be divided in parts, starting with the log transformation of trade and distance.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch1_application1 <- ch1_application1 |>\n  mutate(\n    log_trade = log(trade),\n    log_dist = log(dist)\n  )\n```\n:::\n\n\nContinuing step 2, we can now create the variables $Y_{i,t}$ and $E_{i,t}$ that appear on the OLS model equation in the book.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch1_application1 <- ch1_application1 |>\n  # Create Yit\n  group_by(exporter, year) |>\n  mutate(\n    y = sum(trade),\n    log_y = log(y)\n  ) |>\n  # Create Eit\n  group_by(importer, year) |>\n  mutate(\n    e = sum(trade),\n    log_e = log(e)\n  )\n```\n:::\n\n\nThe OLS model with remoteness index needs both exporter and importer index, which grouping variables can create. We divide it into sub-steps: Replicate the computation of total exports, then the remoteness index for exporters, and finally the total imports with the corresponding remoteness index for importers.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch1_application1 <- ch1_application1 |>\n  # Replicate total_e\n  group_by(exporter, year) |>\n  mutate(total_e = sum(e)) |>\n  group_by(year) |>\n  mutate(total_e = max(total_e)) |>\n  # Replicate rem_exp\n  group_by(exporter, year) |>\n  mutate(\n    remoteness_exp = sum(dist * total_e / e),\n    log_remoteness_exp = log(remoteness_exp)\n  ) |>\n  # Replicate total_y\n  group_by(importer, year) |>\n  mutate(total_y = sum(y)) |>\n  group_by(year) |>\n  mutate(total_y = max(total_y)) |>\n  # Replicate rem_imp\n  group_by(importer, year) |>\n  mutate(\n    remoteness_imp = sum(dist / (y / total_y)),\n    log_remoteness_imp = log(remoteness_imp)\n  ) |>\n  ungroup()\n```\n:::\n\n\nTo create the variables for the OLS with Fixed Effects Model, we followed box #1 on page 44 from @yotov2016advanced. We combine both exporter and importer variables with the year to create the fixed effects variables.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch1_application1 <- ch1_application1 |>\n  # This merges the columns exporter/importer with year\n  mutate(\n    exp_year = paste0(exporter, year),\n    imp_year = paste0(importer, year)\n  )\n```\n:::\n\n\nThe addition of exporter/importer time fixed effects concludes step 2, and now we need to perform step 3. This step will\nbe commented for now as I found an error in the reported $R^2$ for the PPML model that I show next.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ch1_application1 <- ch1_application1 |>\n#   filter(exporter != importer)\n```\n:::\n\n\nSome cases require conducting step 4, and we will be explicit about it when needed.\n\n### OLS estimation ignoring multilateral resistance terms\n\nThe general equation for this model is\n$$\n\\begin{align}\n\\log X_{ij,t} =& \\:\\beta_0 + \\beta_1 DIST_{i,j} + \\beta_2 CNTG_{i,j} + \\beta_3 LANG_{i,j} + \\beta_4 CLNY_{i,j} + \\beta_5 \\log Y_{i,t} +\\\\\n\\text{ }& \\:\\beta_6 \\log E_{j,t} + \\varepsilon_{ij,t}.\n\\end{align}\n$$\n\nPlease see page 41 in @yotov2016advanced for full detail of each variable.\n\nThe model for this case is straightforward, and in this case, we need to apply step 4 from the previous section to drop cases where the trade is zero.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_ols <- felm(\n  log_trade ~ log_dist + cntg + lang + clny + log_y + log_e,\n  data = ch1_application1 |>\n    filter(trade > 0) |>\n    filter(exporter != importer) # commented out step 3\n)\n\nfit_ols\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nFormula: log_trade ~ log_dist + cntg + lang + clny + log_y + log_e\n\nEstimates:\n\n|             | Estimate | Std. Error | z value  | Pr(>|z|)  |\n|-------------|----------|------------|----------|-----------|\n| (Intercept) | -11.2831 |     0.1517 | -74.3632 | 0.0000 ** |\n| log_dist    |  -1.0016 |     0.0142 | -70.7423 | 0.0000 ** |\n| cntg        |   0.5738 |     0.0744 |   7.7098 | 0.0000 ** |\n| lang        |   0.8015 |     0.0337 |  23.7516 | 0.0000 ** |\n| clny        |   0.7349 |     0.0704 |  10.4405 | 0.0000 ** |\n| log_y       |   1.1902 |     0.0054 | 220.3244 | 0.0000 ** |\n| log_e       |   0.9076 |     0.0056 | 162.7301 | 0.0000 ** |\n\nSignificance codes: ** p < 0.01; * p < 0.05; + p < 0.10\n\nR-squared     : 0.7585 \nAdj. R-squared: 0.7585 \n\nNumber of observations: Full 25689; Missing 0; Perfect classification 0 \n```\n\n\n:::\n:::\n\n\nNote that the $R^2$ and adjusted $R^2$ look the same because of rounding.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_ols$r_squared\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.7585251\n```\n\n\n:::\n\n```{.r .cell-code}\nfit_ols$adj_r_squared\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.7584687\n```\n\n\n:::\n:::\n\n\nThe employed function, `felm()`, does not carry a copy of its training data by default besides providing faster fitting for models with fixed effects. This is not the case in base R, where `glm()` outputs include this data, increasing the model's size, but this does not affect the model's predictions and can be changed as the user needs it [@trimmingfat].\n\nThe model is almost ready. We only need to stick to the methodology from @yotov2016advanced and cluster the standard errors by country pair (see the note on page 42, it is imperative).\n\nThe capybara package processes formulas as:\n\n```r\nresponse ~ slopes | fixed_effects | cluster\n```\n\nThe model with clustered standard errors is as follows.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_ols <- felm(\n  log_trade ~ log_dist + cntg + lang + clny + log_y + log_e | 0 | pair_id,\n  data = ch1_application1 |>\n    filter(trade > 0) |>\n    filter(exporter != importer) # commented out step 3\n)\n\nfit_ols\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nFormula: log_trade ~ log_dist + cntg + lang + clny + log_y + log_e | 0 | \n    pair_id\n\nEstimates:\n\n|             | Estimate | Std. Error | z value  | Pr(>|z|)  |\n|-------------|----------|------------|----------|-----------|\n| (Intercept) | -11.2831 |     0.2958 | -38.1452 | 0.0000 ** |\n| log_dist    |  -1.0016 |     0.0273 | -36.6395 | 0.0000 ** |\n| cntg        |   0.5738 |     0.1847 |   3.1069 | 0.0019 ** |\n| lang        |   0.8015 |     0.0821 |   9.7640 | 0.0000 ** |\n| clny        |   0.7349 |     0.1442 |   5.0969 | 0.0000 ** |\n| log_y       |   1.1902 |     0.0095 | 125.8863 | 0.0000 ** |\n| log_e       |   0.9076 |     0.0099 |  91.5953 | 0.0000 ** |\n\nSignificance codes: ** p < 0.01; * p < 0.05; + p < 0.10\n\nR-squared     : 0.7585 \nAdj. R-squared: 0.7585 \n\nNumber of observations: Full 25689; Missing 0; Perfect classification 0 \n```\n\n\n:::\n:::\n\n\nTo conduct the RESET test we need to add the squared fitted values to the training data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch1_application1_ols <- ch1_application1 |>\n  filter(\n    trade > 0,\n    exporter != importer\n  )\n\nch1_application1_ols <- ch1_application1_ols |>\n  mutate(trade_hat_sq = (predict(fit_ols, newdata = ch1_application1_ols))^2)\n\nreset_ols <- felm(\n  log_trade ~ log_dist + cntg + lang + clny + log_y + log_e + trade_hat_sq | 0 | pair_id,\n  data = ch1_application1_ols\n)\n\nround(reset_ols$coef_table[\"trade_hat_sq\", \"Pr(>|z|)\"], 4)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0\n```\n\n\n:::\n:::\n\n\n### OLS estimation controlling for multilateral resistance terms with remote indexes\n\nThe remoteness model adds variables to the OLS model. The general equation for this model is\n$$\n\\begin{align}\n\\log X_{ij,t} =& \\:\\beta_0 + \\beta_1 DIST_{i,j} + \\beta_2 CNTG_{i,j} + \\beta_3 LANG_{i,j} + \\beta_4 CLNY_{i,j} + \\beta_5 \\log Y_{i,t} +\\\\\n\\text{ }& \\beta_6 \\log E_{j,t} + \\beta_7 \\log(REM\\_EXP_i,t) + \\beta_8 \\log(REM\\_IMP_i,t) + \\varepsilon_{ij,t}.\n\\end{align}\n$$\n\nIn the equation above $REM\\_EXP$ and $REM\\_IMP$ are defined as\n$$\n\\begin{align}\n\\log(REM\\_EXP_{i,t}) &= \\log \\left( \\sum_j \\frac{DIST_{i,j}}{E_{j,t} / Y_t} \\right) \\text{ and }\\\\\n\\log(REM\\_IMP_{j,t}) &= \\log \\left( \\sum_i \\frac{DIST_{i,j}}{Y_{i,t} / Y_t} \\right).\n\\end{align}\n$$\n\nPlease see page 43 in @yotov2016advanced for full detail of each variable.\n\nOur approach follows box #1 on page 43 from @yotov2016advanced. Fitting the regression is straightforward. It is just about adding more regressors to what we did in the last section, and we can create a list with a summary for the model.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_ols_remoteness <- felm(\n  log_trade ~ log_dist + cntg + lang + clny + log_y + log_e +\n    log_remoteness_exp + log_remoteness_imp | 0 | pair_id,\n  data = ch1_application1 |>\n    filter(trade > 0) |>\n    filter(exporter != importer) # commented out step 3\n)\n\nfit_ols_remoteness\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nFormula: log_trade ~ log_dist + cntg + lang + clny + log_y + log_e + log_remoteness_exp + \n    log_remoteness_imp | 0 | pair_id\n\nEstimates:\n\n|                    | Estimate | Std. Error | z value  | Pr(>|z|)  |\n|--------------------|----------|------------|----------|-----------|\n| (Intercept)        | -35.2185 |     1.9859 | -17.7341 | 0.0000 ** |\n| log_dist           |  -1.1848 |     0.0313 | -37.8977 | 0.0000 ** |\n| cntg               |   0.2466 |     0.1769 |   1.3939 | 0.1633    |\n| lang               |   0.7394 |     0.0784 |   9.4304 | 0.0000 ** |\n| clny               |   0.8425 |     0.1502 |   5.6081 | 0.0000 ** |\n| log_y              |   1.1643 |     0.0095 | 122.8377 | 0.0000 ** |\n| log_e              |   0.9026 |     0.0099 |  91.1162 | 0.0000 ** |\n| log_remoteness_exp |   0.9718 |     0.0682 |  14.2528 | 0.0000 ** |\n| log_remoteness_imp |   0.2737 |     0.0598 |   4.5789 | 0.0000 ** |\n\nSignificance codes: ** p < 0.01; * p < 0.05; + p < 0.10\n\nR-squared     : 0.765 \nAdj. R-squared: 0.765 \n\nNumber of observations: Full 25689; Missing 0; Perfect classification 0 \n```\n\n\n:::\n:::\n\n\nFor the RESET test, we need to add the squared fitted values to the training data as before.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch1_application1_ols_remoteness <- ch1_application1 |>\n  ungroup() |>\n  filter(\n    trade > 0,\n    exporter != importer\n  )\n\nch1_application1_ols_remoteness <- ch1_application1_ols_remoteness |>\n  mutate(trade_hat_sq = (predict(fit_ols_remoteness, newdata = ch1_application1_ols_remoteness))^2) \n\nreset_ols_remoteness <- felm(\n  log_trade ~ log_dist + cntg + lang + clny + log_y + log_e +\n    log_remoteness_exp + log_remoteness_imp + trade_hat_sq | 0 | pair_id,\n  data = ch1_application1_ols_remoteness\n)\n\nround(reset_ols_remoteness$coef_table[\"trade_hat_sq\", \"Pr(>|z|)\"], 4)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 2e-04\n```\n\n\n:::\n:::\n\n\n### OLS estimation controlling for multilateral resistance terms with fixed effects\n\nThe general equation for this model is\n$$\n\\begin{align}\n\\log X_{ij,t} =& \\: \\beta_1 \\log(DIST)_{i,j} + \\beta_2 CNTG_{i,j} + \\beta_3 LANG_{i,j} +\\\\\n\\text{ }& \\:\\beta_4 CLNY_{i,j} + \\pi_{i,t} + \\chi_{i,t} + \\varepsilon_{ij,t}.\n\\end{align}\n$$\n\nWhere the added terms, concerning the OLS model, are $\\pi_{i,t}$ and $\\chi_{i,t}$ that account for exporter-time and importer-time fixed effects, respectively. See page 44 in @yotov2016advanced for full detail of each variable.\n\nWe can quickly generate a list as we did with the previous models. The only difference to the previous models is that in this case that the variables to the right of the \"|\" operator are the fixed effects, which are treated differently by the *fixest* package, which is used internally by the *tradepolicy* package, for faster model fitting.\n\nPlease notice that the summaries intentionally do not show fixed effects, because there are cases where we have thousands of fixed effects.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# tp_summary_app_1(\n#   formula = log_trade ~ log_dist + cntg + lang + clny | exp_year + imp_year,\n#   data = filter(ch1_application1, trade > 0),\n#   method = \"ols\"\n# )\n\nfit_fe <- felm(\n  log_trade ~ log_dist + cntg + lang + clny | exp_year + imp_year | pair_id,\n  data = ch1_application1 |>\n    filter(trade > 0) |>\n    filter(exporter != importer) # commented out step 3\n)\n\nfit_fe\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nFormula: log_trade ~ log_dist + cntg + lang + clny | exp_year + imp_year | \n    pair_id\n\nEstimates:\n\n|          | Estimate | Std. Error | z value  | Pr(>|z|)  |\n|----------|----------|------------|----------|-----------|\n| log_dist |  -1.2156 |     0.0376 | -32.3685 | 0.0000 ** |\n| cntg     |   0.2232 |     0.1995 |   1.1187 | 0.2633    |\n| lang     |   0.6609 |     0.0807 |   8.1860 | 0.0000 ** |\n| clny     |   0.6705 |     0.1470 |   4.5614 | 0.0000 ** |\n\nSignificance codes: ** p < 0.01; * p < 0.05; + p < 0.10\n\nR-squared     : 0.8432 \nAdj. R-squared: 0.838 \n\nNumber of observations: Full 25689; Missing 0; Perfect classification 0 \n```\n\n\n:::\n:::\n\n\nNote that the `felm()` function does not print the fixed effects. You can access them with `fit_fe$fixed_effects` and\n`fit_fe$fe_levels` as needed.\n\nFor the RESET test, we need to add the squared fitted values to the training data as before.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch1_application1_fe <- ch1_application1 |>\n  ungroup() |>\n  filter(\n    trade > 0,\n    exporter != importer\n  )\n\nch1_application1_fe <- ch1_application1_fe |>\n  mutate(trade_hat_sq = (predict(fit_fe, newdata = ch1_application1_fe))^2)\n\nreset_fe <- felm(\n  log_trade ~ log_dist + cntg + lang + clny + trade_hat_sq | exp_year + imp_year | pair_id,\n  data = ch1_application1_fe\n)\n\nround(reset_fe$coef_table[\"trade_hat_sq\", \"Pr(>|z|)\"], 4)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0\n```\n\n\n:::\n:::\n\n\n### PPML estimation controlling for multilateral resistance terms with fixed effects\n\nThe general equation for this model is\n$$\n\\begin{align}\nX_{ij,t} =& \\:\\exp\\left[\\beta_1 \\log(DIST)_{i,j} + \\beta_2 CNTG_{i,j} +\\right.\\\\\n\\text{ }& \\:\\left.\\beta_3 LANG_{i,j} + \\beta_4 CLNY_{i,j} + \\pi_{i,t} + \\chi_{i,t}\\right] \\times \\varepsilon_{ij,t}.\n\\end{align}\n$$\n\nThe reason to compute this model, despite the lower speed compared to OLS, is that PPML is the only estimator perfectly consistent with the theoretical gravity model. By estimating with PPML, the fixed effects correspond precisely to the corresponding theoretical terms.\n\nThe data for this model is the same as for the fixed effects model, and one option in R is to use the `fepois()` function.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_ppml <- fepoisson(trade ~ log_dist + cntg + lang + clny | exp_year + imp_year | pair_id,\n  data = ch1_application1 |>\n    filter(exporter != importer) # commented out step 3\n)\n\nfit_ppml\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nFormula: trade ~ log_dist + cntg + lang + clny | exp_year + imp_year | \n    pair_id\n\nFamily: Poisson\n\nEstimates:\n\n|          | Estimate | Std. Error | z value  | Pr(>|z|)  |\n|----------|----------|------------|----------|-----------|\n| log_dist |  -0.8409 |     0.0317 | -26.5633 | 0.0000 ** |\n| cntg     |   0.4374 |     0.0832 |   5.2603 | 0.0000 ** |\n| lang     |   0.2475 |     0.0765 |   3.2333 | 0.0012 ** |\n| clny     |  -0.2225 |     0.1162 |  -1.9140 | 0.0556 +  |\n\nSignificance codes: ** p < 0.01; * p < 0.05; + p < 0.10\n\nPseudo R-squared: 0.9461 \n\nNumber of observations: Full 28152; Missing 0; Perfect classification 0 \n\nNumber of Fisher Scoring iterations: 12 \n```\n\n\n:::\n:::\n\n\nUp to this part, everything matches table 1 in @yotov2016advanced, except for the $R^2$ of the PPML model, which I could\nnot replicate except by obtaining an out-of-sample $R^2$ by obtaining the fitted values including domestic flows. I\nbelieve there is a mistake in the book regarding this value.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntrade <- pull(ch1_application1, trade)\ntrade_hat <- predict(fit_ppml, newdata = ch1_application1)\ncor(trade, trade_hat)^2\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.6143843\n```\n\n\n:::\n:::\n\n\nFor the RESET test, we need to add the squared fitted link values to the training data as before.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch1_application1_ppml <- ch1_application1 |>\n  ungroup() |>\n  filter(exporter != importer)\n\nch1_application1_ppml <- ch1_application1_ppml |>\n  mutate(trade_hat_sq = (predict(fit_ppml, type = \"link\", newdata = ch1_application1_ppml))^2)\n\nreset_ppml <- fepoisson(\n  trade ~ log_dist + cntg + lang + clny + trade_hat_sq | exp_year + imp_year | pair_id,\n  data = ch1_application1_ppml\n)\n\nround(reset_ppml$coef_table[\"trade_hat_sq\", \"Pr(>|z|)\"], 4)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.6416\n```\n\n\n:::\n:::\n\n\n### Presenting all models together\n\nCapybara provides the `summary_table()` function to present multiple models together. We can use it to show all the\nmodels fitted in this section (note it is a general use function that does not include the RESET test p-values).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary_table(fit_ols, fit_ols_remoteness, fit_fe, fit_ppml)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n|       Variable       |         (1)         |         (2)         |        (3)         |        (4)         |\n|----------------------|---------------------|---------------------|--------------------|--------------------|\n| (Intercept)          |           -11.283** |           -35.219** |                    |                    |\n|                      |             (0.296) |             (1.986) |                    |                    |\n| log_dist             |            -1.002** |            -1.185** |           -1.216** |           -0.841** |\n|                      |             (0.027) |             (0.031) |            (0.038) |            (0.032) |\n| cntg                 |             0.574** |               0.247 |              0.223 |            0.437** |\n|                      |             (0.185) |             (0.177) |            (0.199) |            (0.083) |\n| lang                 |             0.802** |             0.739** |            0.661** |            0.247** |\n|                      |             (0.082) |             (0.078) |            (0.081) |            (0.077) |\n| clny                 |             0.735** |             0.842** |            0.670** |            -0.222+ |\n|                      |             (0.144) |             (0.150) |            (0.147) |            (0.116) |\n| log_y                |             1.190** |             1.164** |                    |                    |\n|                      |             (0.009) |             (0.009) |                    |                    |\n| log_e                |             0.908** |             0.903** |                    |                    |\n|                      |             (0.010) |             (0.010) |                    |                    |\n| log_remoteness_exp   |                     |             0.972** |                    |                    |\n|                      |                     |             (0.068) |                    |                    |\n| log_remoteness_imp   |                     |             0.274** |                    |                    |\n|                      |                     |             (0.060) |                    |                    |\n|                      |                     |                     |                    |                    |\n| Fixed effects        |                     |                     |                    |                    |\n| exp_year             |                  No |                  No |                Yes |                Yes |\n| imp_year             |                  No |                  No |                Yes |                Yes |\n|                      |                     |                     |                    |                    |\n| N                    |              25,689 |              25,689 |             25,689 |             28,152 |\n| Pseudo R-squared     |               0.759 |               0.765 |              0.843 |              0.946 |\n\nStandard errors in parenthesis\nSignificance levels: ** p < 0.01; * p < 0.05; + p < 0.10\n```\n\n\n:::\n:::\n\n\nThe difference with @yotov2016advanced is that the 3rd and 4th columns do not include the \"grand mean\" (intercept)\nbecause I included exporter-time and importer-time fixed effects, which remove the need for an intercept as it is\nabsorbed by the fixed effects and the slopes and their standard effect match.\n\n## The \"distance puzzle\" resolved\n\n### Preparing the data\n\nPlease see the note from page 47 in @yotov2016advanced. We need to proceed with similar steps as in the previous section.\n\nThe distance puzzle proposes the gravity specification\n$$\n\\begin{align}\nX_{ij,t} =& \\:\\exp\\left[\\pi_{i,t} + \\chi_{i,t} + \\beta_1 \\log(DIST)_{i,j} + \\beta_2 CNTG_{i,j} + \\beta_3 LANG_{i,j}\\right]\\times\\\\\n\\text{ }& \\:\\exp\\left[\\beta_4 CLNY_{i,j} + \\beta_5 \\log(DIST\\_INTRA_{i,i})\\right] \\times \\varepsilon_{ij,t}.\n\\end{align}\n$$\n\nThe difference concerning the last section is that now we need to separate the distance variable into multiple columns that account for discrete-time effects. The $\\beta_T$ terms of the equation reflect this. Perhaps the easiest option is to transform the year into a text column and then use the `pivot_wider()` function.\n\nWe need to remove cases where the exporter is the same as the importer and cases where trade is zero for the OLS model. For the PPML models, we need to mark rows where the exporter and the importer are the same, and we need to create the same country column, which is also required to transform the distance variables as shown in box #1 in page 48 from @yotov2016advanced.\n\nIn order to avoid creating two very similar datasets, we shall create one dataset to cover both OLS and PPML.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch1_application2 <- agtpa_applications |>\n  select(exporter, importer, pair_id, year, trade, dist, cntg, lang, clny) |>\n  # this filter covers both OLS and PPML\n  filter(year %in% seq(1986, 2006, 4)) |>\n  mutate(\n    # variables for both OLS and PPML\n    exp_year = paste0(exporter, year),\n    imp_year = paste0(importer, year),\n    year = paste0(\"log_dist_\", year),\n    log_trade = log(trade),\n    log_dist = log(dist),\n    smctry = ifelse(importer != exporter, 0, 1),\n\n    # PPML specific variables\n    log_dist_intra = log_dist * smctry,\n    intra_pair = ifelse(exporter == importer, exporter, \"inter\")\n  ) |>\n  pivot_wider(names_from = year, values_from = log_dist, values_fill = 0) |>\n  mutate(across(log_dist_1986:log_dist_2006, function(x) x * (1 - smctry)))\n```\n:::\n\n\nThe `across()` function is a shortcut to avoid repetition, as in the following example provided for reference without\ncomputation.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch1_application2 |>\n  mutate(\n    log_dist_1986 =  log_dist_1986 * (1 - smctry),\n    log_dist_1990 =  log_dist_1990 * (1 - smctry),\n\n    # repeat log_dist_T many_times for T = 1994, 1998, ...\n\n    log_dist_2006 =  log_dist_2006 * (1 - smctry)\n  )\n```\n:::\n\n\nNote that the OLS model shall require filtering when we specify the model because we skipped filtering the cases where trade is equal to zero and both the importer and the exporter are the same. Because the solution for the \"distance puzzle\" implies different transformations and filters for the OLS and PPML cases, one possibility is to filter in the same summary functions.\n\n### OLS solution for the \"distance puzzle\"\n\nThe gravity specification, which includes $\\pi_{i,t} + \\chi_{i,t}$, means that we need to do something very similar to what we did in the last section.\n\nWith the data from above, the model specification is straightforward.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_ols_distance_puzzle <- felm(\n  log_trade ~ log_dist_1986 + log_dist_1990 + log_dist_1994 +\n    log_dist_1998 + log_dist_2002 + log_dist_2006 + cntg + lang + clny | exp_year +\n    imp_year | pair_id,\n  data = filter(ch1_application2, importer != exporter, trade > 0)\n)\n\nfit_ols_distance_puzzle\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nFormula: log_trade ~ log_dist_1986 + log_dist_1990 + log_dist_1994 + log_dist_1998 + \n    log_dist_2002 + log_dist_2006 + cntg + lang + clny | exp_year + \n    imp_year | pair_id\n\nEstimates:\n\n|               | Estimate | Std. Error | z value  | Pr(>|z|)  |\n|---------------|----------|------------|----------|-----------|\n| log_dist_1986 |  -1.1685 |     0.0429 | -27.2219 | 0.0000 ** |\n| log_dist_1990 |  -1.1551 |     0.0416 | -27.7495 | 0.0000 ** |\n| log_dist_1994 |  -1.2106 |     0.0449 | -26.9459 | 0.0000 ** |\n| log_dist_1998 |  -1.2481 |     0.0421 | -29.6654 | 0.0000 ** |\n| log_dist_2002 |  -1.2413 |     0.0434 | -28.6114 | 0.0000 ** |\n| log_dist_2006 |  -1.2613 |     0.0430 | -29.3333 | 0.0000 ** |\n| cntg          |   0.2230 |     0.1993 |   1.1187 | 0.2633    |\n| lang          |   0.6611 |     0.0807 |   8.1899 | 0.0000 ** |\n| clny          |   0.6702 |     0.1469 |   4.5616 | 0.0000 ** |\n\nSignificance codes: ** p < 0.01; * p < 0.05; + p < 0.10\n\nR-squared     : 0.8433 \nAdj. R-squared: 0.838 \n\nNumber of observations: Full 25689; Missing 0; Perfect classification 0 \n```\n\n\n:::\n:::\n\n\nFor the inference, we need to use the Delta method on the estimated coefficients.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbeta_log_dist <- grep(\"log_dist\", rownames(fit_ols_distance_puzzle$coef_table), value = TRUE)\nbeta_log_dist <- c(min(beta_log_dist), max(beta_log_dist))\n\n# change = 100 * (beta2 - beta1) / beta1\nbetas <- fit_ols_distance_puzzle$coef_table[, 1][beta_log_dist]\nbeta_pct_chg <- as.numeric(100 * (betas[2] - betas[1]) / betas[1])\n\nbeta_vcov_cluster <- fit_ols_distance_puzzle$vcov[\n  which(grepl(paste(beta_log_dist, collapse = \"|\"), rownames(fit_ols_distance_puzzle$vcov))),\n  which(grepl(paste(beta_log_dist, collapse = \"|\"), rownames(fit_ols_distance_puzzle$vcov)))\n]\n\nbeta_std_err <- deltamethod(\n  ~ 100 * (x2 - x1) / x1,\n  c(betas[1], betas[2]), beta_vcov_cluster\n)\n\nbeta_tstat <- beta_pct_chg / beta_std_err\n\nbeta_pval <- pnorm(-abs(beta_tstat)) + (1 - pnorm(abs(beta_tstat)))\n\nround(c(\n  \"pct_chg_log_dist\" = beta_pct_chg,\n  \"std_err\" = beta_std_err,\n  \"p-value\" = beta_pval\n), 4)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\npct_chg_log_dist          std_err          p-value \n          7.9502           3.6976           0.0316 \n```\n\n\n:::\n:::\n\n\n### PPML solution for the \"distance puzzle\"\n\nThis model is very similar to the one specified in the PPML section from the last section. We can directly fit the model.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_ppml_distance_puzzle <- fepoisson(\n  trade ~ log_dist_1986 + log_dist_1990 + log_dist_1994 +\n    log_dist_1998 + log_dist_2002 + log_dist_2006 + cntg + lang + clny |\n    exp_year + imp_year | pair_id,\n  data = filter(ch1_application2, importer != exporter)\n)\n\nfit_ppml_distance_puzzle\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nFormula: trade ~ log_dist_1986 + log_dist_1990 + log_dist_1994 + log_dist_1998 + \n    log_dist_2002 + log_dist_2006 + cntg + lang + clny | exp_year + \n    imp_year | pair_id\n\nFamily: Poisson\n\nEstimates:\n\n|               | Estimate | Std. Error | z value  | Pr(>|z|)  |\n|---------------|----------|------------|----------|-----------|\n| log_dist_1986 |  -0.8593 |     0.0370 | -23.1952 | 0.0000 ** |\n| log_dist_1990 |  -0.8341 |     0.0377 | -22.1362 | 0.0000 ** |\n| log_dist_1994 |  -0.8348 |     0.0351 | -23.7915 | 0.0000 ** |\n| log_dist_1998 |  -0.8469 |     0.0354 | -23.9491 | 0.0000 ** |\n| log_dist_2002 |  -0.8484 |     0.0316 | -26.8072 | 0.0000 ** |\n| log_dist_2006 |  -0.8356 |     0.0312 | -26.7420 | 0.0000 ** |\n| cntg          |   0.4372 |     0.0832 |   5.2574 | 0.0000 ** |\n| lang          |   0.2475 |     0.0765 |   3.2335 | 0.0012 ** |\n| clny          |  -0.2223 |     0.1163 |  -1.9111 | 0.0560 +  |\n\nSignificance codes: ** p < 0.01; * p < 0.05; + p < 0.10\n\nPseudo R-squared: 0.9462 \n\nNumber of observations: Full 28152; Missing 0; Perfect classification 0 \n\nNumber of Fisher Scoring iterations: 12 \n```\n\n\n:::\n:::\n\n\nFor the inference, we need to use the Delta method on the estimated coefficients as we did in the OLS case.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbeta_log_dist <- grep(\"log_dist\", rownames(fit_ppml_distance_puzzle$coef_table), value = TRUE)\nbeta_log_dist <- c(min(beta_log_dist), max(beta_log_dist))\n\n# change = 100 * (beta2 - beta1) / beta1\nbetas <- fit_ppml_distance_puzzle$coef_table[, 1][beta_log_dist]\nbeta_pct_chg <- as.numeric(100 * (betas[2] - betas[1]) / betas[1])\n\nbeta_vcov_cluster <- fit_ppml_distance_puzzle$vcov[\n  which(grepl(paste(beta_log_dist, collapse = \"|\"), rownames(fit_ppml_distance_puzzle$vcov))),\n  which(grepl(paste(beta_log_dist, collapse = \"|\"), rownames(fit_ppml_distance_puzzle$vcov)))\n]\n\nbeta_std_err <- deltamethod(\n  ~ 100 * (x2 - x1) / x1,\n  c(betas[1], betas[2]), beta_vcov_cluster\n)\n\nbeta_tstat <- beta_pct_chg / beta_std_err\nbeta_pval <- pnorm(-abs(beta_tstat)) + (1 - pnorm(abs(beta_tstat)))\n\nround(c(\n  \"pct_chg_log_dist\" = beta_pct_chg,\n  \"std_err\" = beta_std_err,\n  \"p-value\" = beta_pval\n), 4)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\npct_chg_log_dist          std_err          p-value \n         -2.7503           3.0039           0.3599 \n```\n\n\n:::\n:::\n\n\n### Internal distance solution for the \"distance puzzle\"\n\nThis model requires us to add the internal distance variable to the PPML model and not filter the rows where the exporter and the importer are the same.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_ppml_intra_distance_puzzle <- fepoisson(\n  trade ~ log_dist_1986 + log_dist_1990 + log_dist_1994 +\n    log_dist_1998 + log_dist_2002 + log_dist_2006 + cntg + lang + clny +\n    log_dist_intra | exp_year + imp_year | pair_id,\n  data = ch1_application2\n)\n\nfit_ppml_intra_distance_puzzle\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nFormula: trade ~ log_dist_1986 + log_dist_1990 + log_dist_1994 + log_dist_1998 + \n    log_dist_2002 + log_dist_2006 + cntg + lang + clny + log_dist_intra | \n    exp_year + imp_year | pair_id\n\nFamily: Poisson\n\nEstimates:\n\n|                | Estimate | Std. Error | z value  | Pr(>|z|)  |\n|----------------|----------|------------|----------|-----------|\n| log_dist_1986  |  -0.9797 |     0.0720 | -13.6042 | 0.0000 ** |\n| log_dist_1990  |  -0.9399 |     0.0731 | -12.8558 | 0.0000 ** |\n| log_dist_1994  |  -0.9150 |     0.0720 | -12.7027 | 0.0000 ** |\n| log_dist_1998  |  -0.8868 |     0.0710 | -12.4819 | 0.0000 ** |\n| log_dist_2002  |  -0.8839 |     0.0706 | -12.5150 | 0.0000 ** |\n| log_dist_2006  |  -0.8722 |     0.0713 | -12.2331 | 0.0000 ** |\n| cntg           |   0.3714 |     0.1396 |   2.6602 | 0.0078 ** |\n| lang           |   0.3373 |     0.1682 |   2.0060 | 0.0449 *  |\n| clny           |   0.0192 |     0.1563 |   0.1226 | 0.9024    |\n| log_dist_intra |  -0.4884 |     0.1007 |  -4.8506 | 0.0000 ** |\n\nSignificance codes: ** p < 0.01; * p < 0.05; + p < 0.10\n\nPseudo R-squared: 0.9954 \n\nNumber of observations: Full 28566; Missing 0; Perfect classification 0 \n\nNumber of Fisher Scoring iterations: 13 \n```\n\n\n:::\n:::\n\n\nFor the inference, we need to use the Delta method on the estimated coefficients as we did in the OLS case (we need the\nnumbers for the regular expression).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbeta_log_dist <- grep(\"log_dist_[0-9]{4}\", rownames(fit_ppml_intra_distance_puzzle$coef_table), value = TRUE)\nbeta_log_dist <- c(min(beta_log_dist), max(beta_log_dist))\n\n# change = 100 * (beta2 - beta1) / beta1\nbetas <- fit_ppml_intra_distance_puzzle$coef_table[, 1][beta_log_dist]\nbeta_pct_chg <- as.numeric(100 * (betas[2] - betas[1]) / betas[1])\n\nbeta_vcov_cluster <- fit_ppml_intra_distance_puzzle$vcov[\n  which(grepl(paste(beta_log_dist, collapse = \"|\"), rownames(fit_ppml_intra_distance_puzzle$vcov))),\n  which(grepl(paste(beta_log_dist, collapse = \"|\"), rownames(fit_ppml_intra_distance_puzzle$vcov)))\n]\n\nbeta_std_err <- deltamethod(\n  ~ 100 * (x2 - x1) / x1,\n  c(betas[1], betas[2]), beta_vcov_cluster\n)\n\nbeta_tstat <- beta_pct_chg / beta_std_err\nbeta_pval <- pnorm(-abs(beta_tstat)) + (1 - pnorm(abs(beta_tstat)))\n\nround(c(\n  \"pct_chg_log_dist\" = beta_pct_chg,\n  \"std_err\" = beta_std_err,\n  \"p-value\" = beta_pval\n), 4)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\npct_chg_log_dist          std_err          p-value \n        -10.9648           1.0580           0.0000 \n```\n\n\n:::\n:::\n\n\n### Internal distance and home bias solution for the \"distance puzzle\"\n\nThis model requires us to add the same country variable to the internal distance model and repeat the rest of the steps from the last section.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_ppml_home_distance_puzzle <- fepoisson(\n  trade ~ log_dist_1986 + log_dist_1990 + log_dist_1994 +\n    log_dist_1998 + log_dist_2002 + log_dist_2006 + cntg + lang + clny +\n    log_dist_intra + smctry | exp_year + imp_year | pair_id,\n  data = ch1_application2\n)\n\nfit_ppml_home_distance_puzzle\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nFormula: trade ~ log_dist_1986 + log_dist_1990 + log_dist_1994 + log_dist_1998 + \n    log_dist_2002 + log_dist_2006 + cntg + lang + clny + log_dist_intra + \n    smctry | exp_year + imp_year | pair_id\n\nFamily: Poisson\n\nEstimates:\n\n|                | Estimate | Std. Error | z value  | Pr(>|z|)  |\n|----------------|----------|------------|----------|-----------|\n| log_dist_1986  |  -0.8570 |     0.0627 | -13.6777 | 0.0000 ** |\n| log_dist_1990  |  -0.8189 |     0.0633 | -12.9386 | 0.0000 ** |\n| log_dist_1994  |  -0.7958 |     0.0635 | -12.5342 | 0.0000 ** |\n| log_dist_1998  |  -0.7699 |     0.0630 | -12.2197 | 0.0000 ** |\n| log_dist_2002  |  -0.7666 |     0.0626 | -12.2409 | 0.0000 ** |\n| log_dist_2006  |  -0.7544 |     0.0622 | -12.1287 | 0.0000 ** |\n| cntg           |   0.5737 |     0.1551 |   3.6995 | 0.0002 ** |\n| lang           |   0.3523 |     0.1370 |   2.5719 | 0.0101 *  |\n| clny           |   0.0269 |     0.1248 |   0.2155 | 0.8294    |\n| log_dist_intra |  -0.6024 |     0.1092 |  -5.5182 | 0.0000 ** |\n| smctry         |   1.6890 |     0.5737 |   2.9440 | 0.0032 ** |\n\nSignificance codes: ** p < 0.01; * p < 0.05; + p < 0.10\n\nPseudo R-squared: 0.9962 \n\nNumber of observations: Full 28566; Missing 0; Perfect classification 0 \n\nNumber of Fisher Scoring iterations: 12 \n```\n\n\n:::\n:::\n\n\nFor the inference, we need to use the Delta method on the estimated coefficients as we did in the OLS case (we need the\nnumbers for the regular expression).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbeta_log_dist <- grep(\"log_dist_[0-9]{4}\", rownames(fit_ppml_home_distance_puzzle$coef_table), value = TRUE)\nbeta_log_dist <- c(min(beta_log_dist), max(beta_log_dist))\n\n# change = 100 * (beta2 - beta1) / beta1\nbetas <- fit_ppml_home_distance_puzzle$coef_table[, 1][beta_log_dist]\nbeta_pct_chg <- as.numeric(100 * (betas[2] - betas[1]) / betas[1])\n\nbeta_vcov_cluster <- fit_ppml_home_distance_puzzle$vcov[\n  which(grepl(paste(beta_log_dist, collapse = \"|\"), rownames(fit_ppml_home_distance_puzzle$vcov))),\n  which(grepl(paste(beta_log_dist, collapse = \"|\"), rownames(fit_ppml_home_distance_puzzle$vcov)))\n]\n\nbeta_std_err <- deltamethod(\n  ~ 100 * (x2 - x1) / x1,\n  c(betas[1], betas[2]), beta_vcov_cluster\n)\n\nbeta_tstat <- beta_pct_chg / beta_std_err\nbeta_pval <- pnorm(-abs(beta_tstat)) + (1 - pnorm(abs(beta_tstat)))\n\nround(c(\n  \"pct_chg_log_dist\" = beta_pct_chg,\n  \"std_err\" = beta_std_err,\n  \"p-value\" = beta_pval\n), 4)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\npct_chg_log_dist          std_err          p-value \n        -11.9693           1.1730           0.0000 \n```\n\n\n:::\n:::\n\n\n### Fixed effects solution for the \"distance puzzle\"\n\nThis model requires us to remove the internal distance and same country variables from the last model and include the internal pair variable to account for the intra-national fixed effects.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_fe_distance_puzzle <- fepoisson(\n  trade ~ log_dist_1986 + log_dist_1990 + log_dist_1994 +\n    log_dist_1998 + log_dist_2002 + log_dist_2006 + cntg + lang + clny +\n    intra_pair | exp_year + imp_year | pair_id,\n  data = ch1_application2\n)\n\nfit_fe_distance_puzzle\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nFormula: trade ~ log_dist_1986 + log_dist_1990 + log_dist_1994 + log_dist_1998 + \n    log_dist_2002 + log_dist_2006 + cntg + lang + clny + intra_pair | \n    exp_year + imp_year | pair_id\n\nFamily: Poisson\n\nEstimates:\n\n|                 | Estimate | Std. Error | z value  | Pr(>|z|)  |\n|-----------------|----------|------------|----------|-----------|\n| log_dist_1986   |  -0.9100 |     0.0323 | -28.1877 | 0.0000 ** |\n| log_dist_1990   |  -0.8790 |     0.0321 | -27.3896 | 0.0000 ** |\n| log_dist_1994   |  -0.8598 |     0.0318 | -27.0035 | 0.0000 ** |\n| log_dist_1998   |  -0.8329 |     0.0317 | -26.3092 | 0.0000 ** |\n| log_dist_2002   |  -0.8292 |     0.0320 | -25.9030 | 0.0000 ** |\n| log_dist_2006   |  -0.8105 |     0.0320 | -25.3203 | 0.0000 ** |\n| cntg            |   0.4421 |     0.0816 |   5.4149 | 0.0000 ** |\n| lang            |   0.2406 |     0.0760 |   3.1649 | 0.0016 ** |\n| clny            |  -0.2203 |     0.1165 |  -1.8910 | 0.0586 +  |\n| intra_pairAUS   |  -1.0409 |     0.5066 |  -2.0544 | 0.0399 *  |\n| intra_pairAUT   |   0.0635 |     0.5297 |   0.1199 | 0.9046    |\n| intra_pairBEL   |   0.4164 |     0.5093 |   0.8176 | 0.4136    |\n| intra_pairBGR   |   2.4933 |     0.5558 |   4.4861 | 0.0000 ** |\n| intra_pairBOL   |   2.6240 |     0.5554 |   4.7243 | 0.0000 ** |\n| intra_pairBRA   |  -0.2690 |     0.4173 |  -0.6446 | 0.5192    |\n| intra_pairCAN   |  -1.5790 |     0.4864 |  -3.2466 | 0.0012 ** |\n| intra_pairCHE   |   0.9178 |     0.5002 |   1.8348 | 0.0665 +  |\n| intra_pairCHL   |  -0.1113 |     0.5607 |  -0.1986 | 0.8426    |\n| intra_pairCHN   |  -1.4946 |     0.4810 |  -3.1073 | 0.0019 ** |\n| intra_pairCMR   |   3.0592 |     0.8006 |   3.8212 | 0.0001 ** |\n| intra_pairCOL   |   1.6936 |     0.5048 |   3.3547 | 0.0008 ** |\n| intra_pairCRI   |   1.5236 |     0.4901 |   3.1086 | 0.0019 ** |\n| intra_pairCYP   |   2.8819 |     0.7195 |   4.0052 | 0.0001 ** |\n| intra_pairDEU   |  -1.6567 |     0.4823 |  -3.4351 | 0.0006 ** |\n| intra_pairDNK   |   0.1439 |     0.5432 |   0.2649 | 0.7911    |\n| intra_pairECU   |   2.1609 |     0.5964 |   3.6232 | 0.0003 ** |\n| intra_pairEGY   |   1.9717 |     0.5081 |   3.8806 | 0.0001 ** |\n| intra_pairESP   |  -0.7392 |     0.5111 |  -1.4463 | 0.1481    |\n| intra_pairFIN   |   0.1308 |     0.5218 |   0.2506 | 0.8021    |\n| intra_pairFRA   |  -0.9571 |     0.4795 |  -1.9961 | 0.0459 *  |\n| intra_pairGBR   |  -1.4163 |     0.4793 |  -2.9550 | 0.0031 ** |\n| intra_pairGRC   |   1.0790 |     0.5476 |   1.9702 | 0.0488 *  |\n| intra_pairHKG   |  -2.3710 |     0.5025 |  -4.7189 | 0.0000 ** |\n| intra_pairHUN   |   0.5927 |     0.6168 |   0.9610 | 0.3366    |\n| intra_pairIDN   |  -0.2140 |     0.5106 |  -0.4190 | 0.6752    |\n| intra_pairIND   |   0.5259 |     0.5147 |   1.0218 | 0.3069    |\n| intra_pairinter |   1.3019 |     0.5628 |   2.3133 | 0.0207 *  |\n| intra_pairIRL   |  -0.6181 |     0.4883 |  -1.2660 | 0.2055    |\n| intra_pairIRN   |   2.5378 |     0.6097 |   4.1622 | 0.0000 ** |\n| intra_pairISL   |   3.1902 |     0.6502 |   4.9065 | 0.0000 ** |\n| intra_pairISR   |   0.2918 |     0.5617 |   0.5196 | 0.6034    |\n| intra_pairITA   |  -1.0192 |     0.4938 |  -2.0638 | 0.0390 *  |\n| intra_pairJOR   |   3.8689 |     0.6082 |   6.3617 | 0.0000 ** |\n| intra_pairJPN   |  -1.7755 |     0.5024 |  -3.5341 | 0.0004 ** |\n| intra_pairKEN   |   3.7424 |     0.6182 |   6.0541 | 0.0000 ** |\n| intra_pairKOR   |  -0.8640 |     0.5231 |  -1.6519 | 0.0986 +  |\n| intra_pairKWT   |   1.6315 |     0.5567 |   2.9307 | 0.0034 ** |\n| intra_pairLKA   |   1.7413 |     0.5485 |   3.1745 | 0.0015 ** |\n| intra_pairMAC   |   2.8863 |     0.9020 |   3.1998 | 0.0014 ** |\n| intra_pairMAR   |   1.7540 |     0.7438 |   2.3583 | 0.0184 *  |\n| intra_pairMEX   |  -1.5878 |     0.5143 |  -3.0871 | 0.0020 ** |\n| intra_pairMLT   |   1.8356 |     0.5695 |   3.2233 | 0.0013 ** |\n| intra_pairMMR   |   5.0208 |     0.5118 |   9.8104 | 0.0000 ** |\n| intra_pairMUS   |   1.0756 |     0.7584 |   1.4182 | 0.1561    |\n| intra_pairMWI   |   3.6429 |     0.7584 |   4.8037 | 0.0000 ** |\n| intra_pairMYS   |  -1.3164 |     0.5493 |  -2.3968 | 0.0165 *  |\n| intra_pairNER   |   2.7655 |     1.1507 |   2.4034 | 0.0162 *  |\n| intra_pairNGA   |   3.6139 |     0.5060 |   7.1419 | 0.0000 ** |\n| intra_pairNLD   |  -0.8928 |     0.5039 |  -1.7720 | 0.0764 +  |\n| intra_pairNOR   |   0.5495 |     0.5320 |   1.0329 | 0.3017    |\n| intra_pairNPL   |   4.0378 |     0.8442 |   4.7830 | 0.0000 ** |\n| intra_pairPAN   |   1.2654 |     0.8971 |   1.4106 | 0.1584    |\n| intra_pairPHL   |  -0.5611 |     0.5243 |  -1.0701 | 0.2846    |\n| intra_pairPOL   |   1.0607 |     0.5605 |   1.8925 | 0.0584 +  |\n| intra_pairPRT   |   0.1395 |     0.5965 |   0.2339 | 0.8151    |\n| intra_pairQAT   |   2.0616 |     0.5307 |   3.8847 | 0.0001 ** |\n| intra_pairROM   |   1.6095 |     0.5779 |   2.7853 | 0.0053 ** |\n| intra_pairSEN   |   3.7758 |     0.9521 |   3.9658 | 0.0001 ** |\n| intra_pairSGP   |  -2.5061 |     0.4837 |  -5.1811 | 0.0000 ** |\n| intra_pairSWE   |  -0.8703 |     0.5036 |  -1.7281 | 0.0840 +  |\n| intra_pairTHA   |  -1.0006 |     0.5214 |  -1.9192 | 0.0550 +  |\n| intra_pairTTO   |   2.4571 |     0.5254 |   4.6762 | 0.0000 ** |\n| intra_pairTUN   |   2.0248 |     0.7405 |   2.7345 | 0.0062 ** |\n| intra_pairTUR   |   0.4969 |     0.5326 |   0.9328 | 0.3509    |\n| intra_pairTZA   |   2.2220 |     0.7014 |   3.1678 | 0.0015 ** |\n| intra_pairURY   |   1.6219 |     0.7106 |   2.2824 | 0.0225 *  |\n| intra_pairUSA   |  -3.4131 |     0.4803 |  -7.1064 | 0.0000 ** |\n| intra_pairZAF   |  -0.3844 |     0.5679 |  -0.6768 | 0.4986    |\n\nSignificance codes: ** p < 0.01; * p < 0.05; + p < 0.10\n\nPseudo R-squared: 0.9993 \n\nNumber of observations: Full 28566; Missing 0; Perfect classification 0 \n\nNumber of Fisher Scoring iterations: 13 \n```\n\n\n:::\n:::\n\n\nFor the inference, we need to use the Delta method on the estimated coefficients as we did in the OLS case.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbeta_log_dist <- grep(\"log_dist_[0-9]{4}\", rownames(fit_fe_distance_puzzle$coef_table), value = TRUE)\nbeta_log_dist <- c(min(beta_log_dist), max(beta_log_dist))\n\n# change = 100 * (beta2 - beta1) / beta1\nbetas <- fit_fe_distance_puzzle$coef_table[, 1][beta_log_dist]\nbeta_pct_chg <- as.numeric(100 * (betas[2] - betas[1]) / betas[1])\n\nbeta_vcov_cluster <- fit_fe_distance_puzzle$vcov[\n  which(grepl(paste(beta_log_dist, collapse = \"|\"), rownames(fit_fe_distance_puzzle$vcov))),\n  which(grepl(paste(beta_log_dist, collapse = \"|\"), rownames(fit_fe_distance_puzzle$vcov)))\n]\n\nbeta_std_err <- deltamethod(\n  ~ 100 * (x2 - x1) / x1,\n  c(betas[1], betas[2]), beta_vcov_cluster\n)\n\nbeta_tstat <- beta_pct_chg / beta_std_err\nbeta_pval <- pnorm(-abs(beta_tstat)) + (1 - pnorm(abs(beta_tstat)))\n\nround(c(\n  \"pct_chg_log_dist\" = beta_pct_chg,\n  \"std_err\" = beta_std_err,\n  \"p-value\" = beta_pval\n), 4)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\npct_chg_log_dist          std_err          p-value \n        -10.9311           0.7688           0.0000 \n```\n\n\n:::\n:::\n\n\n### Presenting all models together\n\nAs it was done in the previous section, we can use the `summary_table()` function to show all the models fitted in this section.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary_table(\n  fit_ols_distance_puzzle,\n  fit_ppml_distance_puzzle,\n  fit_ppml_intra_distance_puzzle,\n  fit_ppml_home_distance_puzzle,\n  fit_fe_distance_puzzle\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n|      Variable      |        (1)         |        (2)         |        (3)         |        (4)         |        (5)         |\n|--------------------|--------------------|--------------------|--------------------|--------------------|--------------------|\n| log_dist_1986      |           -1.168** |           -0.859** |           -0.980** |           -0.857** |           -0.910** |\n|                    |            (0.043) |            (0.037) |            (0.072) |            (0.063) |            (0.032) |\n| log_dist_1990      |           -1.155** |           -0.834** |           -0.940** |           -0.819** |           -0.879** |\n|                    |            (0.042) |            (0.038) |            (0.073) |            (0.063) |            (0.032) |\n| log_dist_1994      |           -1.211** |           -0.835** |           -0.915** |           -0.796** |           -0.860** |\n|                    |            (0.045) |            (0.035) |            (0.072) |            (0.063) |            (0.032) |\n| log_dist_1998      |           -1.248** |           -0.847** |           -0.887** |           -0.770** |           -0.833** |\n|                    |            (0.042) |            (0.035) |            (0.071) |            (0.063) |            (0.032) |\n| log_dist_2002      |           -1.241** |           -0.848** |           -0.884** |           -0.767** |           -0.829** |\n|                    |            (0.043) |            (0.032) |            (0.071) |            (0.063) |            (0.032) |\n| log_dist_2006      |           -1.261** |           -0.836** |           -0.872** |           -0.754** |           -0.811** |\n|                    |            (0.043) |            (0.031) |            (0.071) |            (0.062) |            (0.032) |\n| cntg               |              0.223 |            0.437** |            0.371** |            0.574** |            0.442** |\n|                    |            (0.199) |            (0.083) |            (0.140) |            (0.155) |            (0.082) |\n| lang               |            0.661** |            0.248** |             0.337* |             0.352* |            0.241** |\n|                    |            (0.081) |            (0.077) |            (0.168) |            (0.137) |            (0.076) |\n| clny               |            0.670** |            -0.222+ |              0.019 |              0.027 |            -0.220+ |\n|                    |            (0.147) |            (0.116) |            (0.156) |            (0.125) |            (0.117) |\n| log_dist_intra     |                    |                    |           -0.488** |           -0.602** |                    |\n|                    |                    |                    |            (0.101) |            (0.109) |                    |\n| smctry             |                    |                    |                    |            1.689** |                    |\n|                    |                    |                    |                    |            (0.574) |                    |\n| intra_pairAUS      |                    |                    |                    |                    |            -1.041* |\n|                    |                    |                    |                    |                    |            (0.507) |\n| intra_pairAUT      |                    |                    |                    |                    |              0.064 |\n|                    |                    |                    |                    |                    |            (0.530) |\n| intra_pairBEL      |                    |                    |                    |                    |              0.416 |\n|                    |                    |                    |                    |                    |            (0.509) |\n| intra_pairBGR      |                    |                    |                    |                    |            2.493** |\n|                    |                    |                    |                    |                    |            (0.556) |\n| intra_pairBOL      |                    |                    |                    |                    |            2.624** |\n|                    |                    |                    |                    |                    |            (0.555) |\n| intra_pairBRA      |                    |                    |                    |                    |             -0.269 |\n|                    |                    |                    |                    |                    |            (0.417) |\n| intra_pairCAN      |                    |                    |                    |                    |           -1.579** |\n|                    |                    |                    |                    |                    |            (0.486) |\n| intra_pairCHE      |                    |                    |                    |                    |             0.918+ |\n|                    |                    |                    |                    |                    |            (0.500) |\n| intra_pairCHL      |                    |                    |                    |                    |             -0.111 |\n|                    |                    |                    |                    |                    |            (0.561) |\n| intra_pairCHN      |                    |                    |                    |                    |           -1.495** |\n|                    |                    |                    |                    |                    |            (0.481) |\n| intra_pairCMR      |                    |                    |                    |                    |            3.059** |\n|                    |                    |                    |                    |                    |            (0.801) |\n| intra_pairCOL      |                    |                    |                    |                    |            1.694** |\n|                    |                    |                    |                    |                    |            (0.505) |\n| intra_pairCRI      |                    |                    |                    |                    |            1.524** |\n|                    |                    |                    |                    |                    |            (0.490) |\n| intra_pairCYP      |                    |                    |                    |                    |            2.882** |\n|                    |                    |                    |                    |                    |            (0.720) |\n| intra_pairDEU      |                    |                    |                    |                    |           -1.657** |\n|                    |                    |                    |                    |                    |            (0.482) |\n| intra_pairDNK      |                    |                    |                    |                    |              0.144 |\n|                    |                    |                    |                    |                    |            (0.543) |\n| intra_pairECU      |                    |                    |                    |                    |            2.161** |\n|                    |                    |                    |                    |                    |            (0.596) |\n| intra_pairEGY      |                    |                    |                    |                    |            1.972** |\n|                    |                    |                    |                    |                    |            (0.508) |\n| intra_pairESP      |                    |                    |                    |                    |             -0.739 |\n|                    |                    |                    |                    |                    |            (0.511) |\n| intra_pairFIN      |                    |                    |                    |                    |              0.131 |\n|                    |                    |                    |                    |                    |            (0.522) |\n| intra_pairFRA      |                    |                    |                    |                    |            -0.957* |\n|                    |                    |                    |                    |                    |            (0.479) |\n| intra_pairGBR      |                    |                    |                    |                    |           -1.416** |\n|                    |                    |                    |                    |                    |            (0.479) |\n| intra_pairGRC      |                    |                    |                    |                    |             1.079* |\n|                    |                    |                    |                    |                    |            (0.548) |\n| intra_pairHKG      |                    |                    |                    |                    |           -2.371** |\n|                    |                    |                    |                    |                    |            (0.502) |\n| intra_pairHUN      |                    |                    |                    |                    |              0.593 |\n|                    |                    |                    |                    |                    |            (0.617) |\n| intra_pairIDN      |                    |                    |                    |                    |             -0.214 |\n|                    |                    |                    |                    |                    |            (0.511) |\n| intra_pairIND      |                    |                    |                    |                    |              0.526 |\n|                    |                    |                    |                    |                    |            (0.515) |\n| intra_pairinter    |                    |                    |                    |                    |             1.302* |\n|                    |                    |                    |                    |                    |            (0.563) |\n| intra_pairIRL      |                    |                    |                    |                    |             -0.618 |\n|                    |                    |                    |                    |                    |            (0.488) |\n| intra_pairIRN      |                    |                    |                    |                    |            2.538** |\n|                    |                    |                    |                    |                    |            (0.610) |\n| intra_pairISL      |                    |                    |                    |                    |            3.190** |\n|                    |                    |                    |                    |                    |            (0.650) |\n| intra_pairISR      |                    |                    |                    |                    |              0.292 |\n|                    |                    |                    |                    |                    |            (0.562) |\n| intra_pairITA      |                    |                    |                    |                    |            -1.019* |\n|                    |                    |                    |                    |                    |            (0.494) |\n| intra_pairJOR      |                    |                    |                    |                    |            3.869** |\n|                    |                    |                    |                    |                    |            (0.608) |\n| intra_pairJPN      |                    |                    |                    |                    |           -1.775** |\n|                    |                    |                    |                    |                    |            (0.502) |\n| intra_pairKEN      |                    |                    |                    |                    |            3.742** |\n|                    |                    |                    |                    |                    |            (0.618) |\n| intra_pairKOR      |                    |                    |                    |                    |            -0.864+ |\n|                    |                    |                    |                    |                    |            (0.523) |\n| intra_pairKWT      |                    |                    |                    |                    |            1.631** |\n|                    |                    |                    |                    |                    |            (0.557) |\n| intra_pairLKA      |                    |                    |                    |                    |            1.741** |\n|                    |                    |                    |                    |                    |            (0.549) |\n| intra_pairMAC      |                    |                    |                    |                    |            2.886** |\n|                    |                    |                    |                    |                    |            (0.902) |\n| intra_pairMAR      |                    |                    |                    |                    |             1.754* |\n|                    |                    |                    |                    |                    |            (0.744) |\n| intra_pairMEX      |                    |                    |                    |                    |           -1.588** |\n|                    |                    |                    |                    |                    |            (0.514) |\n| intra_pairMLT      |                    |                    |                    |                    |            1.836** |\n|                    |                    |                    |                    |                    |            (0.569) |\n| intra_pairMMR      |                    |                    |                    |                    |            5.021** |\n|                    |                    |                    |                    |                    |            (0.512) |\n| intra_pairMUS      |                    |                    |                    |                    |              1.076 |\n|                    |                    |                    |                    |                    |            (0.758) |\n| intra_pairMWI      |                    |                    |                    |                    |            3.643** |\n|                    |                    |                    |                    |                    |            (0.758) |\n| intra_pairMYS      |                    |                    |                    |                    |            -1.316* |\n|                    |                    |                    |                    |                    |            (0.549) |\n| intra_pairNER      |                    |                    |                    |                    |             2.765* |\n|                    |                    |                    |                    |                    |            (1.151) |\n| intra_pairNGA      |                    |                    |                    |                    |            3.614** |\n|                    |                    |                    |                    |                    |            (0.506) |\n| intra_pairNLD      |                    |                    |                    |                    |            -0.893+ |\n|                    |                    |                    |                    |                    |            (0.504) |\n| intra_pairNOR      |                    |                    |                    |                    |              0.550 |\n|                    |                    |                    |                    |                    |            (0.532) |\n| intra_pairNPL      |                    |                    |                    |                    |            4.038** |\n|                    |                    |                    |                    |                    |            (0.844) |\n| intra_pairPAN      |                    |                    |                    |                    |              1.265 |\n|                    |                    |                    |                    |                    |            (0.897) |\n| intra_pairPHL      |                    |                    |                    |                    |             -0.561 |\n|                    |                    |                    |                    |                    |            (0.524) |\n| intra_pairPOL      |                    |                    |                    |                    |             1.061+ |\n|                    |                    |                    |                    |                    |            (0.560) |\n| intra_pairPRT      |                    |                    |                    |                    |              0.140 |\n|                    |                    |                    |                    |                    |            (0.597) |\n| intra_pairQAT      |                    |                    |                    |                    |            2.062** |\n|                    |                    |                    |                    |                    |            (0.531) |\n| intra_pairROM      |                    |                    |                    |                    |            1.610** |\n|                    |                    |                    |                    |                    |            (0.578) |\n| intra_pairSEN      |                    |                    |                    |                    |            3.776** |\n|                    |                    |                    |                    |                    |            (0.952) |\n| intra_pairSGP      |                    |                    |                    |                    |           -2.506** |\n|                    |                    |                    |                    |                    |            (0.484) |\n| intra_pairSWE      |                    |                    |                    |                    |            -0.870+ |\n|                    |                    |                    |                    |                    |            (0.504) |\n| intra_pairTHA      |                    |                    |                    |                    |            -1.001+ |\n|                    |                    |                    |                    |                    |            (0.521) |\n| intra_pairTTO      |                    |                    |                    |                    |            2.457** |\n|                    |                    |                    |                    |                    |            (0.525) |\n| intra_pairTUN      |                    |                    |                    |                    |            2.025** |\n|                    |                    |                    |                    |                    |            (0.740) |\n| intra_pairTUR      |                    |                    |                    |                    |              0.497 |\n|                    |                    |                    |                    |                    |            (0.533) |\n| intra_pairTZA      |                    |                    |                    |                    |            2.222** |\n|                    |                    |                    |                    |                    |            (0.701) |\n| intra_pairURY      |                    |                    |                    |                    |             1.622* |\n|                    |                    |                    |                    |                    |            (0.711) |\n| intra_pairUSA      |                    |                    |                    |                    |           -3.413** |\n|                    |                    |                    |                    |                    |            (0.480) |\n| intra_pairZAF      |                    |                    |                    |                    |             -0.384 |\n|                    |                    |                    |                    |                    |            (0.568) |\n|                    |                    |                    |                    |                    |                    |\n| Fixed effects      |                    |                    |                    |                    |                    |\n| exp_year           |                Yes |                Yes |                Yes |                Yes |                Yes |\n| imp_year           |                Yes |                Yes |                Yes |                Yes |                Yes |\n|                    |                    |                    |                    |                    |                    |\n| N                  |             25,689 |             28,152 |             28,566 |             28,566 |             28,566 |\n| Pseudo R-squared   |              0.843 |              0.946 |              0.995 |              0.996 |              0.999 |\n\nStandard errors in parenthesis\nSignificance levels: ** p < 0.01; * p < 0.05; + p < 0.10\n```\n\n\n:::\n:::\n\n\n## Regional trade agreements effects\n\n### Preparing the data\n\nThis model specification includes gravity covariates, including importer-time and exporter-time fixed effects, as in the equation\n\n$$\n\\begin{align}\nX_{ij,t} =& \\:\\exp\\left[\\pi_{i,t} + \\chi_{i,t} + \\beta_1 \\log(DIST)_{i,j} + \\beta_2 CNTG_{i,j} + \\beta_3 LANG_{i,j} +\\right.\\\\\n\\text{ }& \\:\\left.\\beta_4 CLNY_{i,j} + \\beta_5 RTA_{ij,t}\\right] \\times \\varepsilon_{ij,t}.\n\\end{align}\n$$\n\nIn comparison to the previous examples, we need to create additional variables to include fixed effects that account for the observations where the exporter and the importer are the same. These variables are internal border, internal dyad and internal borders for different years.\n\nThe direct way of obtaining the desired variables is similar to what we did in the previous sections.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch1_application3 <- agtpa_applications |>\n  filter(year %in% seq(1986, 2006, 4)) |>\n  mutate(\n    exp_year = paste0(exporter, year),\n    imp_year = paste0(importer, year),\n    year = paste0(\"intl_border_\", year),\n    log_trade = log(trade),\n    log_dist = log(dist),\n    intl_brdr = ifelse(exporter == importer, pair_id, \"inter\"),\n    intl_brdr_2 = ifelse(exporter == importer, 0, 1),\n    pair_id_2 = ifelse(exporter == importer, \"0-intra\", pair_id)\n  ) |>\n  pivot_wider(names_from = year, values_from = intl_brdr_2, values_fill = 0)\n```\n:::\n\n\nNotice that we used \"0-intra\" and not just \"intra\" because the rest of the observations in the internal dyads are numbers 1, ..., N, and R internals shall consider \"0-intra\" as the reference factor for being the first item when it orders the unique observations alphabetically. Also, observe the order of the resulting table, the pivoting of the table will put \"0-intra\" as the first row for the first exporter-importer dyad. This makes the difference between the expected or other behaviours in the next chapter.\n\nIn addition, we need to create the variable containing the trade sum to filter the cases where the sum by dyad is zero.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nch1_application3 <- ch1_application3 |>\n  group_by(pair_id) |>\n  mutate(sum_trade = sum(trade)) |>\n  ungroup()\n```\n:::\n\n\n### OLS standard RTA estimates with international trade only\n\nThe gravity specification, which includes $\\pi_{i,t} + \\chi_{i,t}$, means that we need to do something very similar to what we did in the last section.\n\nWith the data from above, the model specification is straightforward.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_ols_rta <- felm(\n  log_trade ~ log_dist + cntg + lang + clny + rta | exp_year + imp_year | pair_id,\n  data = filter(ch1_application3, trade > 0, importer != exporter)\n)\n\nfit_ols_rta\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nFormula: log_trade ~ log_dist + cntg + lang + clny + rta | exp_year + \n    imp_year | pair_id\n\nEstimates:\n\n|          | Estimate | Std. Error | z value  | Pr(>|z|)  |\n|----------|----------|------------|----------|-----------|\n| log_dist |  -1.2159 |     0.0384 | -31.6974 | 0.0000 ** |\n| cntg     |   0.2230 |     0.1996 |   1.1173 | 0.2638    |\n| lang     |   0.6607 |     0.0808 |   8.1785 | 0.0000 ** |\n| clny     |   0.6705 |     0.1470 |   4.5614 | 0.0000 ** |\n| rta      |  -0.0044 |     0.0531 |  -0.0827 | 0.9341    |\n\nSignificance codes: ** p < 0.01; * p < 0.05; + p < 0.10\n\nR-squared     : 0.8432 \nAdj. R-squared: 0.838 \n\nNumber of observations: Full 25689; Missing 0; Perfect classification 0 \n```\n\n\n:::\n:::\n\n\n### PPML standard RTA estimates with international trade only\n\nThe model specification is very similar to OLS, and we only need to change the method specified in the function.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_ppml_rta <- fepoisson(\n  trade ~ log_dist + cntg + lang + clny + rta | exp_year + imp_year | pair_id,\n  data = filter(ch1_application3, importer != exporter)\n)\n\nfit_ppml_rta\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nFormula: trade ~ log_dist + cntg + lang + clny + rta | exp_year + imp_year | \n    pair_id\n\nFamily: Poisson\n\nEstimates:\n\n|          | Estimate | Std. Error | z value  | Pr(>|z|)  |\n|----------|----------|------------|----------|-----------|\n| log_dist |  -0.8216 |     0.0310 | -26.5189 | 0.0000 ** |\n| cntg     |   0.4155 |     0.0828 |   5.0189 | 0.0000 ** |\n| lang     |   0.2499 |     0.0767 |   3.2591 | 0.0011 ** |\n| clny     |  -0.2054 |     0.1143 |  -1.7972 | 0.0723 +  |\n| rta      |   0.1907 |     0.0658 |   2.8986 | 0.0037 ** |\n\nSignificance codes: ** p < 0.01; * p < 0.05; + p < 0.10\n\nPseudo R-squared: 0.946 \n\nNumber of observations: Full 28152; Missing 0; Perfect classification 0 \n\nNumber of Fisher Scoring iterations: 12 \n```\n\n\n:::\n:::\n\n\n### Addressing potential domestic trade diversion\n\nThe model specification is quite the same as PPML. We only need to add the international border variable but use the entire dataset instead of removing rows where the importer and the exporter are the same.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_intra_rta <- fepoisson(\n  trade ~ log_dist + cntg + lang + clny + rta | exp_year + imp_year +\n    intl_brdr | pair_id,\n  data = ch1_application3\n)\n\nfit_intra_rta\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nFormula: trade ~ log_dist + cntg + lang + clny + rta | exp_year + imp_year + \n    intl_brdr | pair_id\n\nFamily: Poisson\n\nEstimates:\n\n|          | Estimate | Std. Error | z value | Pr(>|z|)  |\n|----------|----------|------------|---------|-----------|\n| log_dist |  -0.5759 |     0.0691 | -8.3311 | 0.0000 ** |\n| cntg     |   0.7878 |     0.2852 |  2.7626 | 0.0057 ** |\n| lang     |   0.0294 |     0.1984 |  0.1481 | 0.8822    |\n| clny     |   0.0432 |     0.2587 |  0.1670 | 0.8674    |\n| rta      |   0.5916 |     0.3620 |  1.6344 | 0.1022    |\n\nSignificance codes: ** p < 0.01; * p < 0.05; + p < 0.10\n\nPseudo R-squared: 0.988 \n\nNumber of observations: Full 28566; Missing 0; Perfect classification 0 \n\nNumber of Fisher Scoring iterations: 16 \n```\n\n\n:::\n:::\n\n\n### Addressing potential endogeneity of RTAs\n\nThe model specification includes the RTA variable and the exporter-time, importer-time and internal dyad fixed effects to account for domestic trade.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_endg_rta <- fepoisson(\n  trade ~ rta | exp_year + imp_year + pair_id_2 | pair_id,\n  data = filter(ch1_application3, sum_trade > 0)\n)\n\nfit_endg_rta\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nFormula: trade ~ rta | exp_year + imp_year + pair_id_2 | pair_id\n\nFamily: Poisson\n\nEstimates:\n\n|     | Estimate | Std. Error | z value | Pr(>|z|)  |\n|-----|----------|------------|---------|-----------|\n| rta |   0.5572 |     0.1022 |  5.4500 | 0.0000 ** |\n\nSignificance codes: ** p < 0.01; * p < 0.05; + p < 0.10\n\nPseudo R-squared: 0.9988 \n\nNumber of observations: Full 28482; Missing 0; Perfect classification 0 \n\nNumber of Fisher Scoring iterations: 20 \n```\n\n\n:::\n:::\n\n\n### Testing for potential \"reverse causality\" between trade and RTAs\n\nWe need to modify the previous model to include the forward lagged RTA variable (by four years) and consider where the trade sum is larger than zero.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_lead_rta <- fepoisson(\n  trade ~ rta + rta_lead4 | exp_year + imp_year + pair_id_2 | pair_id,\n  data = filter(ch1_application3, sum_trade > 0)\n)\n\nfit_lead_rta\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nFormula: trade ~ rta + rta_lead4 | exp_year + imp_year + pair_id_2 | pair_id\n\nFamily: Poisson\n\nEstimates:\n\n|           | Estimate | Std. Error | z value | Pr(>|z|)  |\n|-----------|----------|------------|---------|-----------|\n| rta       |   0.5200 |     0.0859 |  6.0553 | 0.0000 ** |\n| rta_lead4 |   0.0774 |     0.0921 |  0.8405 | 0.4006    |\n\nSignificance codes: ** p < 0.01; * p < 0.05; + p < 0.10\n\nPseudo R-squared: 0.9988 \n\nNumber of observations: Full 28482; Missing 0; Perfect classification 0 \n\nNumber of Fisher Scoring iterations: 20 \n```\n\n\n:::\n\n```{.r .cell-code}\nbeta_rta <- fit_lead_rta$coef_table[, 1]\nbeta_sum <- sum(beta_rta)\n\nbeta_form <- paste(paste0(\"x\", seq_along(beta_rta)), collapse = \"+\")\nbeta_form <- paste0(\"~\", beta_form)\n\nbeta_std_err <- deltamethod(as.formula(beta_form), beta_rta, fit_lead_rta$vcov)\nbeta_tstat <- beta_sum / beta_std_err\nbeta_pval <- pnorm(-abs(beta_tstat)) + (1 - pnorm(abs(beta_tstat)))\n\nround(c(\n  \"sum_coef_rta\" = beta_sum,\n  \"std_err\" = beta_std_err,\n  \"p-value\" = beta_pval\n), 4)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nsum_coef_rta      std_err      p-value \n      0.5975       0.1380       0.0000 \n```\n\n\n:::\n:::\n\n\n### Addressing potential non-linear and phasing-in effects of RTAs\n\nInstead of future-lagged RTA variables, as in the previous model, we modify the previous model and include the RTA backwards lagged variables instead.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_phsng_rta <- fepoisson(\n  trade ~ rta + rta_lag4 + rta_lag8 + rta_lag12 | exp_year + imp_year + pair_id_2 | pair_id,\n  data = filter(ch1_application3, sum_trade > 0)\n)\n\nfit_phsng_rta\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nFormula: trade ~ rta + rta_lag4 + rta_lag8 + rta_lag12 | exp_year + imp_year + \n    pair_id_2 | pair_id\n\nFamily: Poisson\n\nEstimates:\n\n|           | Estimate | Std. Error | z value | Pr(>|z|)  |\n|-----------|----------|------------|---------|-----------|\n| rta       |   0.2914 |     0.0892 |  3.2680 | 0.0011 ** |\n| rta_lag4  |   0.4135 |     0.0672 |  6.1498 | 0.0000 ** |\n| rta_lag8  |   0.1687 |     0.0431 |  3.9117 | 0.0001 ** |\n| rta_lag12 |   0.1189 |     0.0301 |  3.9552 | 0.0001 ** |\n\nSignificance codes: ** p < 0.01; * p < 0.05; + p < 0.10\n\nPseudo R-squared: 0.999 \n\nNumber of observations: Full 28482; Missing 0; Perfect classification 0 \n\nNumber of Fisher Scoring iterations: 20 \n```\n\n\n:::\n\n```{.r .cell-code}\nbeta_rta <- fit_phsng_rta$coef_table[, 1]\nbeta_sum <- sum(beta_rta)\n\nbeta_form <- paste(paste0(\"x\", seq_along(beta_rta)), collapse = \"+\")\nbeta_form <- paste0(\"~\", beta_form)\n\nbeta_std_err <- deltamethod(as.formula(beta_form), beta_rta, fit_phsng_rta$vcov)\nbeta_tstat <- beta_sum / beta_std_err\nbeta_pval <- pnorm(-abs(beta_tstat)) + (1 - pnorm(abs(beta_tstat)))\n\nround(c(\n  \"sum_coef_rta\" = beta_sum,\n  \"std_err\" = beta_std_err,\n  \"p-value\" = beta_pval\n), 4)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nsum_coef_rta      std_err      p-value \n      0.9926       0.0943       0.0000 \n```\n\n\n:::\n:::\n\n\n### Addressing globalization effects\n\nIn addition to the previous model, we include the international borders on different years besides the lagged RTAs.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_glbzn_rta <- fepoisson(\n  trade ~ rta + rta_lag4 + rta_lag8 + rta_lag12 + intl_border_1986 +\n    intl_border_1990 + intl_border_1994 + intl_border_1998 + intl_border_2002 |\n    exp_year + imp_year + pair_id_2 | pair_id,\n  data = filter(ch1_application3, sum_trade > 0)\n)\n\nfit_glbzn_rta\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nFormula: trade ~ rta + rta_lag4 + rta_lag8 + rta_lag12 + intl_border_1986 + \n    intl_border_1990 + intl_border_1994 + intl_border_1998 + \n    intl_border_2002 | exp_year + imp_year + pair_id_2 | pair_id\n\nFamily: Poisson\n\nEstimates:\n\n|                  | Estimate | Std. Error | z value  | Pr(>|z|)  |\n|------------------|----------|------------|----------|-----------|\n| rta              |   0.1157 |     0.0867 |   1.3342 | 0.1822    |\n| rta_lag4         |   0.2877 |     0.0617 |   4.6666 | 0.0000 ** |\n| rta_lag8         |   0.0693 |     0.0482 |   1.4382 | 0.1504    |\n| rta_lag12        |   0.0024 |     0.0291 |   0.0809 | 0.9355    |\n| intl_border_1986 |  -0.7056 |     0.0478 | -14.7642 | 0.0000 ** |\n| intl_border_1990 |  -0.4803 |     0.0429 | -11.1830 | 0.0000 ** |\n| intl_border_1994 |  -0.3665 |     0.0335 | -10.9550 | 0.0000 ** |\n| intl_border_1998 |  -0.1581 |     0.0233 |  -6.7950 | 0.0000 ** |\n| intl_border_2002 |  -0.1409 |     0.0169 |  -8.3453 | 0.0000 ** |\n\nSignificance codes: ** p < 0.01; * p < 0.05; + p < 0.10\n\nPseudo R-squared: 0.9996 \n\nNumber of observations: Full 28482; Missing 0; Perfect classification 0 \n\nNumber of Fisher Scoring iterations: 20 \n```\n\n\n:::\n\n```{.r .cell-code}\nbeta_rta <- fit_glbzn_rta$coef_table[, 1][grep(\"rta\", rownames(fit_glbzn_rta$coef_table))]\nbeta_sum <- sum(beta_rta)\n\nbeta_form <- paste(paste0(\"x\", seq_along(beta_rta)), collapse = \"+\")\nbeta_form <- paste0(\"~\", beta_form)\n\nbeta_std_err <- deltamethod(as.formula(beta_form), beta_rta, fit_glbzn_rta$vcov[names(beta_rta), names(beta_rta)])\nbeta_tstat <- beta_sum / beta_std_err\nbeta_pval <- pnorm(-abs(beta_tstat)) + (1 - pnorm(abs(beta_tstat)))\n\nround(c(\n  \"sum_coef_rta\" = beta_sum,\n  \"std_err\" = beta_std_err,\n  \"p-value\" = beta_pval\n), 4)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nsum_coef_rta      std_err      p-value \n      0.4750       0.1095       0.0000 \n```\n\n\n:::\n:::\n\n\n### Presenting all models together\n\nAs it was done in the previous sections, we can use the `summary_table()` function to show all the models fitted in this section.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary_table(\n  fit_ols_rta,\n  fit_ppml_rta,\n  fit_intra_rta,\n  fit_endg_rta,\n  fit_lead_rta,\n  fit_phsng_rta,\n  fit_glbzn_rta\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n|      Variable      |        (1)         |        (2)         |        (3)         |        (4)        |        (5)        |        (6)        |        (7)         |\n|--------------------|--------------------|--------------------|--------------------|-------------------|-------------------|-------------------|--------------------|\n| log_dist           |           -1.216** |           -0.822** |           -0.576** |                   |                   |                   |                    |\n|                    |            (0.038) |            (0.031) |            (0.069) |                   |                   |                   |                    |\n| cntg               |              0.223 |            0.416** |            0.788** |                   |                   |                   |                    |\n|                    |            (0.200) |            (0.083) |            (0.285) |                   |                   |                   |                    |\n| lang               |            0.661** |            0.250** |              0.029 |                   |                   |                   |                    |\n|                    |            (0.081) |            (0.077) |            (0.198) |                   |                   |                   |                    |\n| clny               |            0.670** |            -0.205+ |              0.043 |                   |                   |                   |                    |\n|                    |            (0.147) |            (0.114) |            (0.259) |                   |                   |                   |                    |\n| rta                |             -0.004 |            0.191** |              0.592 |           0.557** |           0.520** |           0.291** |              0.116 |\n|                    |            (0.053) |            (0.066) |            (0.362) |           (0.102) |           (0.086) |           (0.089) |            (0.087) |\n| rta_lead4          |                    |                    |                    |                   |             0.077 |                   |                    |\n|                    |                    |                    |                    |                   |           (0.092) |                   |                    |\n| rta_lag4           |                    |                    |                    |                   |                   |           0.414** |            0.288** |\n|                    |                    |                    |                    |                   |                   |           (0.067) |            (0.062) |\n| rta_lag8           |                    |                    |                    |                   |                   |           0.169** |              0.069 |\n|                    |                    |                    |                    |                   |                   |           (0.043) |            (0.048) |\n| rta_lag12          |                    |                    |                    |                   |                   |           0.119** |              0.002 |\n|                    |                    |                    |                    |                   |                   |           (0.030) |            (0.029) |\n| intl_border_1986   |                    |                    |                    |                   |                   |                   |           -0.706** |\n|                    |                    |                    |                    |                   |                   |                   |            (0.048) |\n| intl_border_1990   |                    |                    |                    |                   |                   |                   |           -0.480** |\n|                    |                    |                    |                    |                   |                   |                   |            (0.043) |\n| intl_border_1994   |                    |                    |                    |                   |                   |                   |           -0.367** |\n|                    |                    |                    |                    |                   |                   |                   |            (0.033) |\n| intl_border_1998   |                    |                    |                    |                   |                   |                   |           -0.158** |\n|                    |                    |                    |                    |                   |                   |                   |            (0.023) |\n| intl_border_2002   |                    |                    |                    |                   |                   |                   |           -0.141** |\n|                    |                    |                    |                    |                   |                   |                   |            (0.017) |\n|                    |                    |                    |                    |                   |                   |                   |                    |\n| Fixed effects      |                    |                    |                    |                   |                   |                   |                    |\n| exp_year           |                Yes |                Yes |                Yes |               Yes |               Yes |               Yes |                Yes |\n| imp_year           |                Yes |                Yes |                Yes |               Yes |               Yes |               Yes |                Yes |\n| intl_brdr          |                 No |                 No |                Yes |                No |                No |                No |                 No |\n| pair_id_2          |                 No |                 No |                 No |               Yes |               Yes |               Yes |                Yes |\n|                    |                    |                    |                    |                   |                   |                   |                    |\n| N                  |             25,689 |             28,152 |             28,566 |            28,482 |            28,482 |            28,482 |             28,482 |\n| Pseudo R-squared   |              0.843 |              0.946 |              0.988 |             0.999 |             0.999 |             0.999 |              1.000 |\n\nStandard errors in parenthesis\nSignificance levels: ** p < 0.01; * p < 0.05; + p < 0.10\n```\n\n\n:::\n:::\n\n\n## References\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}