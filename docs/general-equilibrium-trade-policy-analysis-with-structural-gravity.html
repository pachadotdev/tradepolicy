<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 3 General equilibrium trade policy analysis with structural gravity | Solutions Manual for An Advanced Guide to Trade Policy Analysis</title>
  <meta name="description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 3 General equilibrium trade policy analysis with structural gravity | Solutions Manual for An Advanced Guide to Trade Policy Analysis" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 3 General equilibrium trade policy analysis with structural gravity | Solutions Manual for An Advanced Guide to Trade Policy Analysis" />
  
  <meta name="twitter:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="Mauricio “Pachá” Vargas Sepúlveda" />


<meta name="date" content="2021-01-02" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html"/>
<link rel="next" href="data.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Solutions Manual for An Advanced Guide to Trade Policy Analysis</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#welcome"><i class="fa fa-check"></i><b>1.1</b> Welcome</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#obtaining-the-datasets-and-functions"><i class="fa fa-check"></i><b>1.2</b> Obtaining the datasets and functions</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#getting-the-most-out-of-this-material"><i class="fa fa-check"></i><b>1.3</b> Getting the most out of this material</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html"><i class="fa fa-check"></i><b>2</b> Partial equilibrium trade policy analysis with structural gravity</a><ul>
<li class="chapter" data-level="2.1" data-path="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html#traditional-gravity-estimates"><i class="fa fa-check"></i><b>2.1</b> Traditional Gravity Estimates</a><ul>
<li class="chapter" data-level="2.1.1" data-path="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html#preparing-the-data"><i class="fa fa-check"></i><b>2.1.1</b> Preparing the data</a></li>
<li class="chapter" data-level="2.1.2" data-path="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html#ols-estimation-ignoring-multilateral-resistance-terms"><i class="fa fa-check"></i><b>2.1.2</b> OLS estimation ignoring multilateral resistance terms</a></li>
<li class="chapter" data-level="2.1.3" data-path="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html#ols-estimation-controlling-for-multilateral-resistance-terms-with-remote-indexes"><i class="fa fa-check"></i><b>2.1.3</b> OLS estimation controlling for multilateral resistance terms with remote indexes</a></li>
<li class="chapter" data-level="2.1.4" data-path="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html#ols-estimation-controlling-for-multilateral-resistance-terms-with-fixed-effects"><i class="fa fa-check"></i><b>2.1.4</b> OLS estimation controlling for multilateral resistance terms with fixed effects</a></li>
<li class="chapter" data-level="2.1.5" data-path="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html#ppml-estimation-controlling-for-multilateral-resistance-terms-with-fixed-effects"><i class="fa fa-check"></i><b>2.1.5</b> PPML estimation controlling for multilateral resistance terms with fixed effects</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html#the-distance-puzzle-resolved"><i class="fa fa-check"></i><b>2.2</b> The “distance puzzle” resolved</a><ul>
<li class="chapter" data-level="2.2.1" data-path="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html#preparing-the-data-1"><i class="fa fa-check"></i><b>2.2.1</b> Preparing the data</a></li>
<li class="chapter" data-level="2.2.2" data-path="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html#ols-solution-for-the-distance-puzzle"><i class="fa fa-check"></i><b>2.2.2</b> OLS solution for the “distance puzzle”</a></li>
<li class="chapter" data-level="2.2.3" data-path="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html#ppml-solution-for-the-distance-puzzle"><i class="fa fa-check"></i><b>2.2.3</b> PPML solution for the “distance puzzle”</a></li>
<li class="chapter" data-level="2.2.4" data-path="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html#internal-distance-solution-for-the-distance-puzzle"><i class="fa fa-check"></i><b>2.2.4</b> Internal distance solution for the “distance puzzle”</a></li>
<li class="chapter" data-level="2.2.5" data-path="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html#internal-distance-and-home-bias-solution-for-the-distance-puzzle"><i class="fa fa-check"></i><b>2.2.5</b> Internal distance and home bias solution for the “distance puzzle”</a></li>
<li class="chapter" data-level="2.2.6" data-path="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html#fixed-effects-solution-for-the-distance-puzzle"><i class="fa fa-check"></i><b>2.2.6</b> Fixed effects solution for the “distance puzzle”</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html#regional-trade-agreements-effects"><i class="fa fa-check"></i><b>2.3</b> Regional trade agreements effects</a><ul>
<li class="chapter" data-level="2.3.1" data-path="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html#preparing-the-data-2"><i class="fa fa-check"></i><b>2.3.1</b> Preparing the data</a></li>
<li class="chapter" data-level="2.3.2" data-path="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html#ols-standard-rta-estimates-with-international-trade-only"><i class="fa fa-check"></i><b>2.3.2</b> OLS standard RTA estimates with international trade only</a></li>
<li class="chapter" data-level="2.3.3" data-path="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html#ppml-standard-rta-estimates-with-international-trade-only"><i class="fa fa-check"></i><b>2.3.3</b> PPML standard RTA estimates with international trade only</a></li>
<li class="chapter" data-level="2.3.4" data-path="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html#addressing-potential-domestic-trade-diversion"><i class="fa fa-check"></i><b>2.3.4</b> Addressing potential domestic trade diversion</a></li>
<li class="chapter" data-level="2.3.5" data-path="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html#addressing-potential-endogeneity-of-rtas"><i class="fa fa-check"></i><b>2.3.5</b> Addressing potential endogeneity of RTAs</a></li>
<li class="chapter" data-level="2.3.6" data-path="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html#testing-for-potential-reverse-causality-between-trade-and-rtas"><i class="fa fa-check"></i><b>2.3.6</b> Testing for potential “reverse causality” between trade and RTAs</a></li>
<li class="chapter" data-level="2.3.7" data-path="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html#addressing-potential-non-linear-and-phasing-in-effects-of-rtas"><i class="fa fa-check"></i><b>2.3.7</b> Addressing potential non-linear and phasing-in effects of RTAs</a></li>
<li class="chapter" data-level="2.3.8" data-path="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html#addressing-globalization-effects"><i class="fa fa-check"></i><b>2.3.8</b> Addressing globalization effects</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="general-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="general-equilibrium-trade-policy-analysis-with-structural-gravity.html"><i class="fa fa-check"></i><b>3</b> General equilibrium trade policy analysis with structural gravity</a><ul>
<li class="chapter" data-level="3.1" data-path="general-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="general-equilibrium-trade-policy-analysis-with-structural-gravity.html#trade-without-borders"><i class="fa fa-check"></i><b>3.1</b> Trade without borders</a><ul>
<li class="chapter" data-level="3.1.1" data-path="general-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="general-equilibrium-trade-policy-analysis-with-structural-gravity.html#initial-data"><i class="fa fa-check"></i><b>3.1.1</b> Initial data</a></li>
<li class="chapter" data-level="3.1.2" data-path="general-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="general-equilibrium-trade-policy-analysis-with-structural-gravity.html#step-i-solve-the-baseline-model"><i class="fa fa-check"></i><b>3.1.2</b> Step I: Solve the baseline model</a></li>
<li class="chapter" data-level="3.1.3" data-path="general-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="general-equilibrium-trade-policy-analysis-with-structural-gravity.html#step-ii-define-a-counterfactual-scenario"><i class="fa fa-check"></i><b>3.1.3</b> Step II: Define a counterfactual scenario</a></li>
<li class="chapter" data-level="3.1.4" data-path="general-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="general-equilibrium-trade-policy-analysis-with-structural-gravity.html#step-iii-solve-the-counterfactual-model"><i class="fa fa-check"></i><b>3.1.4</b> Step III: Solve the counterfactual model</a></li>
<li class="chapter" data-level="3.1.5" data-path="general-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="general-equilibrium-trade-policy-analysis-with-structural-gravity.html#step-iv-collect-construct-and-report-indexes-of-interest"><i class="fa fa-check"></i><b>3.1.5</b> Step IV: Collect, construct, and report indexes of interest</a></li>
<li class="chapter" data-level="3.1.6" data-path="general-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="general-equilibrium-trade-policy-analysis-with-structural-gravity.html#figures-replication"><i class="fa fa-check"></i><b>3.1.6</b> Figures replication</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="general-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="general-equilibrium-trade-policy-analysis-with-structural-gravity.html#impact-of-regional-trade-agreements"><i class="fa fa-check"></i><b>3.2</b> Impact of regional trade agreements</a><ul>
<li class="chapter" data-level="3.2.1" data-path="general-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="general-equilibrium-trade-policy-analysis-with-structural-gravity.html#initial-data-1"><i class="fa fa-check"></i><b>3.2.1</b> Initial data</a></li>
<li class="chapter" data-level="3.2.2" data-path="general-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="general-equilibrium-trade-policy-analysis-with-structural-gravity.html#step-1-solve-the-baseline-gravity-model"><i class="fa fa-check"></i><b>3.2.2</b> Step 1: Solve the baseline gravity model</a></li>
<li class="chapter" data-level="3.2.3" data-path="general-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="general-equilibrium-trade-policy-analysis-with-structural-gravity.html#step-ii-define-a-counterfactual-scenario-1"><i class="fa fa-check"></i><b>3.2.3</b> Step II: Define a counterfactual scenario</a></li>
<li class="chapter" data-level="3.2.4" data-path="general-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="general-equilibrium-trade-policy-analysis-with-structural-gravity.html#step-iii-solve-the-counterfactual-model-1"><i class="fa fa-check"></i><b>3.2.4</b> Step III: Solve the counterfactual model</a></li>
<li class="chapter" data-level="3.2.5" data-path="general-equilibrium-trade-policy-analysis-with-structural-gravity.html"><a href="general-equilibrium-trade-policy-analysis-with-structural-gravity.html#step-iv-collect-construct-and-report-indexes-of-interest-1"><i class="fa fa-check"></i><b>3.2.5</b> Step IV: Collect, construct, and report indexes of interest</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="data.html"><a href="data.html"><i class="fa fa-check"></i><b>4</b> Appendix: Importing the original datasets</a><ul>
<li class="chapter" data-level="4.1" data-path="data.html"><a href="data.html#software"><i class="fa fa-check"></i><b>4.1</b> Software</a></li>
<li class="chapter" data-level="4.2" data-path="data.html"><a href="data.html#downloading-the-original-datasets"><i class="fa fa-check"></i><b>4.2</b> Downloading the original datasets</a></li>
<li class="chapter" data-level="4.3" data-path="data.html"><a href="data.html#converting-the-original-datasets"><i class="fa fa-check"></i><b>4.3</b> Converting the original datasets</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://www.unescap.org/" target="blank">UN ESCAP - Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Solutions Manual for An Advanced Guide to Trade Policy Analysis</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="general-equilibrium-trade-policy-analysis-with-structural-gravity" class="section level1">
<h1><span class="header-section-number">Chapter 3</span> General equilibrium trade policy analysis with structural gravity</h1>
<div id="trade-without-borders" class="section level2">
<h2><span class="header-section-number">3.1</span> Trade without borders</h2>
<div id="initial-data" class="section level3">
<h3><span class="header-section-number">3.1.1</span> Initial data</h3>
<p>Unlike the previous chapter, we shall proceed by alternating both data transforming and regressions. In the previous chapter it was possible to first process the datasets and then fit the regressions, but here we need the regressions’ output in order to create new variables. In any case we will follow quite similar steps to the last chapter.</p>
<p>To do what is shown in box #1 from page 104 in <span class="citation">Yotov et al. (<a href="#ref-yotov2016advanced">2016</a>)</span>, we need to convert “DEU” in both exporter and importer columns to “0-DEU”. We could have used “AAA”, the book uses “ZZZ” but in R “ZZZ” won’t be treated as the reference factor. It is important to mention that box #1 doesn’t show a previous step that is mentioned in page 103, which is to filter and keep observations for the year 2006 only.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb52-1" data-line-number="1">ch2_application1 &lt;-<span class="st"> </span><span class="kw">yotov_data</span>(<span class="st">&quot;ch2_application1&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb52-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">2006</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb52-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb52-4" data-line-number="4">    <span class="dt">log_dist =</span> <span class="kw">log</span>(dist),</a>
<a class="sourceLine" id="cb52-5" data-line-number="5">    <span class="dt">intl =</span> <span class="kw">ifelse</span>(exporter <span class="op">!=</span><span class="st"> </span>importer, <span class="dv">1</span>, <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb52-6" data-line-number="6">    <span class="dt">exporter =</span> <span class="kw">ifelse</span>(exporter <span class="op">==</span><span class="st"> &quot;DEU&quot;</span>, <span class="st">&quot;0-DEU&quot;</span>, exporter),</a>
<a class="sourceLine" id="cb52-7" data-line-number="7">    <span class="dt">importer =</span> <span class="kw">ifelse</span>(importer <span class="op">==</span><span class="st"> &quot;DEU&quot;</span>, <span class="st">&quot;0-DEU&quot;</span>, importer)</a>
<a class="sourceLine" id="cb52-8" data-line-number="8">  ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb52-9" data-line-number="9"><span class="st">  </span></a>
<a class="sourceLine" id="cb52-10" data-line-number="10"><span class="st">  </span><span class="co"># Create Yit</span></a>
<a class="sourceLine" id="cb52-11" data-line-number="11"><span class="st">  </span><span class="kw">group_by</span>(exporter, year) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb52-12" data-line-number="12"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">y =</span> <span class="kw">sum</span>(trade)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb52-13" data-line-number="13"><span class="st">  </span></a>
<a class="sourceLine" id="cb52-14" data-line-number="14"><span class="st">  </span><span class="co"># Create Eit</span></a>
<a class="sourceLine" id="cb52-15" data-line-number="15"><span class="st">  </span><span class="kw">group_by</span>(importer, year) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb52-16" data-line-number="16"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">e =</span> <span class="kw">sum</span>(trade)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb52-17" data-line-number="17"><span class="st">  </span></a>
<a class="sourceLine" id="cb52-18" data-line-number="18"><span class="st">  </span><span class="co"># Create Er</span></a>
<a class="sourceLine" id="cb52-19" data-line-number="19"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb52-20" data-line-number="20"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">e_r =</span> <span class="kw">max</span>(<span class="kw">ifelse</span>(importer <span class="op">==</span><span class="st"> &quot;0-DEU&quot;</span>, e, <span class="ot">NA</span>), <span class="dt">na.rm =</span> T))</a></code></pre></div>
</div>
<div id="step-i-solve-the-baseline-model" class="section level3">
<h3><span class="header-section-number">3.1.2</span> Step I: Solve the baseline model</h3>
<p>We start by fitting the next model:</p>
<p><span class="math display">\[
\begin{align}
X_{ij,t} =&amp; \:\exp\left[\pi_{i,t} + \chi_{i,t} + \beta_1 \log(DIST)_{i,j} + \beta_2 CNTG_{i,j} + \beta_3 INTL_{i,j}\right] \times \varepsilon_{ij,t}
\end{align}
\]</span></p>
<p>With the data from above, the model specification is straightforward:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb53-1" data-line-number="1">fit_baseline_app1 &lt;-<span class="st"> </span><span class="kw">glm</span>(</a>
<a class="sourceLine" id="cb53-2" data-line-number="2">  trade <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>log_dist <span class="op">+</span><span class="st"> </span>cntg <span class="op">+</span><span class="st"> </span>intl <span class="op">+</span><span class="st"> </span>exporter <span class="op">+</span><span class="st"> </span>importer,</a>
<a class="sourceLine" id="cb53-3" data-line-number="3">  <span class="dt">family =</span> <span class="kw">quasipoisson</span>(<span class="dt">link =</span> <span class="st">&quot;log&quot;</span>),</a>
<a class="sourceLine" id="cb53-4" data-line-number="4">  <span class="dt">data =</span> ch2_application1</a>
<a class="sourceLine" id="cb53-5" data-line-number="5">)</a></code></pre></div>
<p>For now, we will concentrate on the fitted values and shall ignore the clustered standard errors in the next paragraphs, but still we can show the robust estimation by using the <code>yotov_clustered_glm()</code> function:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb54-1" data-line-number="1"><span class="kw">yotov_clustered_glm</span>(fit_baseline_app1<span class="op">$</span>formula, ch2_application1)</a></code></pre></div>
<pre><code>## 
## z test of coefficients:
## 
##           Estimate Std. Error  z value  Pr(&gt;|z|)    
## log_dist -0.791288   0.061857 -12.7922 &lt; 2.2e-16 ***
## cntg      0.673646   0.137746   4.8905 1.006e-06 ***
## intl     -2.474450   0.147070 -16.8250 &lt; 2.2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>With the estimated model, we can proceed as in box #1 from page 105 in <span class="citation">Yotov et al. (<a href="#ref-yotov2016advanced">2016</a>)</span> in order to construct the variables for export and import fixed effects:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb56-1" data-line-number="1">ch2_application1 &lt;-<span class="st"> </span>ch2_application1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb56-2" data-line-number="2"><span class="st">  </span><span class="kw">left_join</span>(</a>
<a class="sourceLine" id="cb56-3" data-line-number="3">    <span class="kw">yotov_fixed_effects</span>(fit_baseline_app1),</a>
<a class="sourceLine" id="cb56-4" data-line-number="4">    <span class="kw">c</span>(<span class="st">&quot;exporter&quot;</span>, <span class="st">&quot;importer&quot;</span>)</a>
<a class="sourceLine" id="cb56-5" data-line-number="5">  )</a></code></pre></div>
<p>Still following box #1, we need to compute the variables of bilateral trade costs and multilateral resistances:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb57-1" data-line-number="1">ch2_application1 &lt;-<span class="st"> </span>ch2_application1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb57-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb57-3" data-line-number="3">    <span class="dt">tij_bln =</span> <span class="kw">exp</span>(fit_baseline_app1<span class="op">$</span>coefficients[<span class="st">&quot;log_dist&quot;</span>] <span class="op">*</span><span class="st"> </span>log_dist <span class="op">+</span></a>
<a class="sourceLine" id="cb57-4" data-line-number="4"><span class="st">                  </span>fit_baseline_app1<span class="op">$</span>coefficients[<span class="st">&quot;cntg&quot;</span>] <span class="op">*</span><span class="st"> </span>cntg <span class="op">+</span></a>
<a class="sourceLine" id="cb57-5" data-line-number="5"><span class="st">                  </span>fit_baseline_app1<span class="op">$</span>coefficients[<span class="st">&quot;intl&quot;</span>] <span class="op">*</span><span class="st"> </span>intl),</a>
<a class="sourceLine" id="cb57-6" data-line-number="6">  </a>
<a class="sourceLine" id="cb57-7" data-line-number="7">    <span class="co"># outward multilateral resistance (omr)</span></a>
<a class="sourceLine" id="cb57-8" data-line-number="8">    <span class="dt">omr_bln =</span> y <span class="op">*</span><span class="st"> </span>(e_r <span class="op">/</span><span class="st"> </span><span class="kw">exp</span>(fe_exporter)),</a>
<a class="sourceLine" id="cb57-9" data-line-number="9">    </a>
<a class="sourceLine" id="cb57-10" data-line-number="10">    <span class="co"># inward multilateral resistance (imr)</span></a>
<a class="sourceLine" id="cb57-11" data-line-number="11">    <span class="dt">imr_bln =</span> e <span class="op">/</span><span class="st"> </span>(<span class="kw">exp</span>(fe_importer) <span class="op">*</span><span class="st"> </span>e_r)</a>
<a class="sourceLine" id="cb57-12" data-line-number="12">  )</a></code></pre></div>
<p>To complete this stage of the estimation, we need to create a column with the estimated international trade for given output and expenditures. We start by adding a column, <code>tradehat_bln</code>, with the regression output, and then we group by exporter and summarise to obtain the required column <code>xi_bln</code>:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb58-1" data-line-number="1">ch2_application1 &lt;-<span class="st"> </span>ch2_application1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb58-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">tradehat_bln =</span> <span class="kw">predict</span>(fit_baseline_app1, ch2_application1, <span class="st">&quot;response&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb58-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(exporter) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb58-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">xi_bln =</span> <span class="kw">sum</span>(tradehat_bln <span class="op">*</span><span class="st"> </span>(exporter <span class="op">!=</span><span class="st"> </span>importer))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb58-5" data-line-number="5"><span class="st">  </span><span class="kw">ungroup</span>()</a></code></pre></div>
</div>
<div id="step-ii-define-a-counterfactual-scenario" class="section level3">
<h3><span class="header-section-number">3.1.3</span> Step II: Define a counterfactual scenario</h3>
<p>Box #2 from page 105 in <span class="citation">Yotov et al. (<a href="#ref-yotov2016advanced">2016</a>)</span> proposes two alternatives to define counterfactual scenario of removing international borders.</p>
<p>The first alternative is to eliminate the border variable and then generate the logged trade costs used in the constraint:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb59-1" data-line-number="1">ch2_application1 &lt;-<span class="st"> </span>ch2_application1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb59-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb59-3" data-line-number="3">    <span class="dt">tij_cfl =</span> <span class="kw">exp</span>(fit_baseline_app1<span class="op">$</span>coefficients[<span class="st">&quot;log_dist&quot;</span>] <span class="op">*</span><span class="st"> </span>log_dist <span class="op">+</span></a>
<a class="sourceLine" id="cb59-4" data-line-number="4"><span class="st">                  </span>fit_baseline_app1<span class="op">$</span>coefficients[<span class="st">&quot;cntg&quot;</span>] <span class="op">*</span><span class="st"> </span>cntg),</a>
<a class="sourceLine" id="cb59-5" data-line-number="5">    <span class="dt">log_tij_cfl =</span> <span class="kw">log</span>(tij_cfl)</a>
<a class="sourceLine" id="cb59-6" data-line-number="6">  )</a></code></pre></div>
<p>The second alternative is to define a new counterfactual border variable:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb60-1" data-line-number="1">ch2_application1 &lt;-<span class="st"> </span>ch2_application1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb60-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb60-3" data-line-number="3">    <span class="dt">intl_cfl =</span> <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb60-4" data-line-number="4">    <span class="dt">tij_bln =</span> <span class="kw">exp</span>(fit_baseline_app1<span class="op">$</span>coefficients[<span class="st">&quot;log_dist&quot;</span>] <span class="op">*</span><span class="st"> </span>log_dist <span class="op">+</span></a>
<a class="sourceLine" id="cb60-5" data-line-number="5"><span class="st">                  </span>fit_baseline_app1<span class="op">$</span>coefficients[<span class="st">&quot;cntg&quot;</span>] <span class="op">*</span><span class="st"> </span>cntg <span class="op">+</span></a>
<a class="sourceLine" id="cb60-6" data-line-number="6"><span class="st">                  </span>fit_baseline_app1<span class="op">$</span>coefficients[<span class="st">&quot;intl&quot;</span>] <span class="op">*</span><span class="st"> </span>intl_cfl),</a>
<a class="sourceLine" id="cb60-7" data-line-number="7">    <span class="dt">log_tij_cfl =</span> <span class="kw">log</span>(tij_cfl)</a>
<a class="sourceLine" id="cb60-8" data-line-number="8">  )</a></code></pre></div>
</div>
<div id="step-iii-solve-the-counterfactual-model" class="section level3">
<h3><span class="header-section-number">3.1.4</span> Step III: Solve the counterfactual model</h3>
<p>We need to fit a model similar to the model from step I, the constrained gravity model, where <span class="math inline">\(\pi_{j,t}\)</span> and <span class="math inline">\(\chi_{j,t}\)</span> are altered:</p>
<p><span class="math display">\[
\begin{align}
X_{ij,t} =&amp; \:\exp\left[\pi_{i,t}^{CFL} + \chi_{i,t}^{CFL} + \beta_1 \log(DIST)_{i,j} + \beta_2 CNTG_{i,j} + \beta_3 INTL_{i,j}\right] \times \varepsilon_{ij,t}
\end{align}
\]</span></p>
<p>Box #1 from page 106 in <span class="citation">Yotov et al. (<a href="#ref-yotov2016advanced">2016</a>)</span> estimates the constrained gravity model with the PPML estimator by using an offset argument, and this is straightforward in R:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb61-1" data-line-number="1">fit_counterfactual_app1 &lt;-<span class="st"> </span><span class="kw">glm</span>(</a>
<a class="sourceLine" id="cb61-2" data-line-number="2">  trade <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>exporter <span class="op">+</span><span class="st"> </span>importer <span class="op">+</span><span class="st"> </span><span class="kw">offset</span>(log_tij_cfl),</a>
<a class="sourceLine" id="cb61-3" data-line-number="3">  <span class="dt">family =</span> <span class="kw">quasipoisson</span>(<span class="dt">link =</span> <span class="st">&quot;log&quot;</span>),</a>
<a class="sourceLine" id="cb61-4" data-line-number="4">  <span class="dt">data =</span> ch2_application1</a>
<a class="sourceLine" id="cb61-5" data-line-number="5">)</a></code></pre></div>
<p>Unlike step I, to construct the variables for export and import fixed effects, we’ll obtain the variables <code>fe_exporter.x</code> and <code>fe_exporter.y</code> because we already added an <code>fe_exporter</code> column to the dataset after obtaining the baseline model.</p>
<p><code>dplyr</code> is wise enough to rename the two <code>fe_exporter</code> columns (the same applies to the imports) but we need to specify that we want to join by exporter and importer instead of all columns with shared names. In any case, it is better to rename those columns and provide informative names:</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb62-1" data-line-number="1">ch2_application1 &lt;-<span class="st"> </span>ch2_application1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb62-2" data-line-number="2"><span class="st">  </span><span class="kw">left_join</span>(</a>
<a class="sourceLine" id="cb62-3" data-line-number="3">    <span class="kw">yotov_fixed_effects</span>(fit_counterfactual_app1),</a>
<a class="sourceLine" id="cb62-4" data-line-number="4">    <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;exporter&quot;</span>, <span class="st">&quot;importer&quot;</span>)</a>
<a class="sourceLine" id="cb62-5" data-line-number="5">  ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb62-6" data-line-number="6"><span class="st">  </span><span class="kw">rename</span>(</a>
<a class="sourceLine" id="cb62-7" data-line-number="7">    <span class="dt">fe_exporter_bln =</span> fe_exporter.x,</a>
<a class="sourceLine" id="cb62-8" data-line-number="8">    <span class="dt">fe_exporter_cfl =</span> fe_exporter.y,</a>
<a class="sourceLine" id="cb62-9" data-line-number="9">    <span class="dt">fe_importer_bln =</span> fe_importer.x,</a>
<a class="sourceLine" id="cb62-10" data-line-number="10">    <span class="dt">fe_importer_cfl =</span> fe_importer.y</a>
<a class="sourceLine" id="cb62-11" data-line-number="11">  )</a></code></pre></div>
<p>Now we go for Box #2 from page 106 in <span class="citation">Yotov et al. (<a href="#ref-yotov2016advanced">2016</a>)</span> where the variables of bilateral trade costs and multilateral resistances are obtained:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb63-1" data-line-number="1">ch2_application1 &lt;-<span class="st"> </span>ch2_application1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb63-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb63-3" data-line-number="3">    <span class="co"># outward multilateral resistance (omr)</span></a>
<a class="sourceLine" id="cb63-4" data-line-number="4">    <span class="dt">omr_cfl =</span> y <span class="op">*</span><span class="st"> </span>(e_r <span class="op">/</span><span class="st"> </span><span class="kw">exp</span>(fe_exporter_cfl)),</a>
<a class="sourceLine" id="cb63-5" data-line-number="5"></a>
<a class="sourceLine" id="cb63-6" data-line-number="6">    <span class="co"># inward multilateral resistance (imr)</span></a>
<a class="sourceLine" id="cb63-7" data-line-number="7">    <span class="dt">imr_cfl =</span> e <span class="op">/</span><span class="st"> </span>(<span class="kw">exp</span>(fe_importer_cfl) <span class="op">*</span><span class="st"> </span>e_r)</a>
<a class="sourceLine" id="cb63-8" data-line-number="8">  )</a></code></pre></div>
<p>Box #2 also shows how to compute the conditional general equilibrium effects of trade. This is very similar to what we did in step I:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb64-1" data-line-number="1">ch2_application1 &lt;-<span class="st"> </span>ch2_application1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb64-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">tradehat_cfl =</span> <span class="kw">predict</span>(fit_counterfactual_app1, ch2_application1, <span class="st">&quot;response&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb64-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(exporter) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb64-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">xi_cfl =</span> <span class="kw">sum</span>(tradehat_cfl <span class="op">*</span><span class="st"> </span>(exporter <span class="op">!=</span><span class="st"> </span>importer))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb64-5" data-line-number="5"><span class="st">  </span><span class="kw">ungroup</span>()</a></code></pre></div>
<p>Box #1 from page 107 in <span class="citation">Yotov et al. (<a href="#ref-yotov2016advanced">2016</a>)</span> can be considerably simplified with R code. To construct the iterative procedure to converge to full endowment general equilibrium effects, we start by creating the required columns and parameters, so we will deviate from the original approach.</p>
<p>We start computing change in bilateral trade costs (<code>change_tij</code>) and trade deficit or surplus (<code>phi</code>):</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb65-1" data-line-number="1"><span class="co"># set the criteria of convergence</span></a>
<a class="sourceLine" id="cb65-2" data-line-number="2"><span class="co"># taken from the literature (see the Stata code)</span></a>
<a class="sourceLine" id="cb65-3" data-line-number="3">sigma &lt;-<span class="st"> </span><span class="dv">7</span></a>
<a class="sourceLine" id="cb65-4" data-line-number="4"></a>
<a class="sourceLine" id="cb65-5" data-line-number="5">ch2_application1 &lt;-<span class="st"> </span>ch2_application1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb65-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb65-7" data-line-number="7">    <span class="dt">change_tij =</span> tij_cfl <span class="op">/</span><span class="st"> </span>tij_bln,</a>
<a class="sourceLine" id="cb65-8" data-line-number="8">    <span class="dt">phi =</span> <span class="kw">ifelse</span>(importer <span class="op">==</span><span class="st"> </span>exporter, e <span class="op">/</span><span class="st"> </span>y, <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb65-9" data-line-number="9">  ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb65-10" data-line-number="10"><span class="st">  </span><span class="kw">group_by</span>(exporter) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb65-11" data-line-number="11"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">phi =</span> <span class="kw">max</span>(phi)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb65-12" data-line-number="12"><span class="st">  </span><span class="kw">ungroup</span>()</a></code></pre></div>
<p>Now we compute change in prices for exporters (<code>change_p_i</code>) and importers (<code>change_p_j</code>):</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb66-1" data-line-number="1">ch2_application1 &lt;-<span class="st"> </span>ch2_application1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb66-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(exporter) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb66-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">change_p_i =</span> ((<span class="kw">exp</span>(fe_exporter_cfl) <span class="op">/</span><span class="st"> </span>e_r) <span class="op">/</span><span class="st"> </span>(<span class="kw">exp</span>(fe_exporter_bln) <span class="op">/</span><span class="st"> </span>e_r))<span class="op">^</span>(<span class="dv">1</span> <span class="op">/</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>sigma))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb66-4" data-line-number="4"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb66-5" data-line-number="5"><span class="st">  </span></a>
<a class="sourceLine" id="cb66-6" data-line-number="6"><span class="st">  </span><span class="kw">group_by</span>(importer) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb66-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb66-8" data-line-number="8">    <span class="dt">change_p_j =</span> <span class="kw">ifelse</span>(importer <span class="op">==</span><span class="st"> </span>exporter, change_p_i, <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb66-9" data-line-number="9">    <span class="dt">change_p_j =</span> <span class="kw">max</span>(change_p_j)</a>
<a class="sourceLine" id="cb66-10" data-line-number="10">  ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb66-11" data-line-number="11"><span class="st">  </span><span class="kw">ungroup</span>()</a></code></pre></div>
<p>Next, we need to compute the counterfactual trade flows (<code>trade_cfl</code>):</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb67-1" data-line-number="1">ch2_application1 &lt;-<span class="st"> </span>ch2_application1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb67-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">trade_cfl =</span> tradehat_cfl <span class="op">*</span><span class="st"> </span>change_p_i <span class="op">*</span><span class="st"> </span>change_p_j)</a></code></pre></div>
<p>To conclude the steps from Box #1 we need a <code>while()</code> loop and iterate until a convergence is reached.
We need to duplicate some columns under new names for the loop operations, because we will overwrite them when using the iterative steps:</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb68-1" data-line-number="1">ch2_application1 &lt;-<span class="st"> </span>ch2_application1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb68-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb68-3" data-line-number="3">    <span class="dt">omr_cfl_0 =</span> omr_cfl,</a>
<a class="sourceLine" id="cb68-4" data-line-number="4">    <span class="dt">imr_cfl_0 =</span> imr_cfl,</a>
<a class="sourceLine" id="cb68-5" data-line-number="5">    <span class="dt">change_imr_full_0 =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb68-6" data-line-number="6">    <span class="dt">change_omr_full_0 =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb68-7" data-line-number="7">    <span class="dt">change_p_i_0 =</span> change_p_i,</a>
<a class="sourceLine" id="cb68-8" data-line-number="8">    <span class="dt">change_p_j_0 =</span> change_p_j,</a>
<a class="sourceLine" id="cb68-9" data-line-number="9">    <span class="dt">fe_exporter_cfl_0 =</span> fe_exporter_cfl,</a>
<a class="sourceLine" id="cb68-10" data-line-number="10">    <span class="dt">fe_importer_cfl_0 =</span> fe_importer_cfl,</a>
<a class="sourceLine" id="cb68-11" data-line-number="11">    <span class="dt">tradehat_0 =</span> tradehat_cfl,</a>
<a class="sourceLine" id="cb68-12" data-line-number="12">    <span class="dt">e_r_cfl_0 =</span> e_r</a>
<a class="sourceLine" id="cb68-13" data-line-number="13">  )</a></code></pre></div>
<p>And now we run the loop, which cannot be divided into smaller pieces because the step <span class="math inline">\(N\)</span> depends on the step <span class="math inline">\(N-1\)</span>:</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb69-1" data-line-number="1"><span class="co"># set parameters</span></a>
<a class="sourceLine" id="cb69-2" data-line-number="2">max_dif &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb69-3" data-line-number="3">sd_dif &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb69-4" data-line-number="4">change_price_i_old &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb69-5" data-line-number="5"></a>
<a class="sourceLine" id="cb69-6" data-line-number="6">i &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb69-7" data-line-number="7"><span class="cf">while</span>(sd_dif <span class="op">&gt;</span><span class="st"> </span><span class="fl">1e-5</span> <span class="op">|</span><span class="st"> </span>max_dif <span class="op">&gt;</span><span class="st"> </span><span class="fl">1e-5</span>) {</a>
<a class="sourceLine" id="cb69-8" data-line-number="8">  ch2_application1 &lt;-<span class="st"> </span>ch2_application1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb69-9" data-line-number="9"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">trade_1 =</span> tradehat_<span class="dv">0</span> <span class="op">*</span><span class="st"> </span>change_p_i_<span class="dv">0</span> <span class="op">*</span><span class="st"> </span>change_p_j_<span class="dv">0</span> <span class="op">/</span><span class="st"> </span>(change_omr_full_<span class="dv">0</span> <span class="op">*</span><span class="st"> </span>change_imr_full_<span class="dv">0</span>))</a>
<a class="sourceLine" id="cb69-10" data-line-number="10">  </a>
<a class="sourceLine" id="cb69-11" data-line-number="11">  <span class="co"># repeat the counterfactual model</span></a>
<a class="sourceLine" id="cb69-12" data-line-number="12">  fit_counterfactual_app1_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw">glm</span>(</a>
<a class="sourceLine" id="cb69-13" data-line-number="13">    trade_<span class="dv">1</span> <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>exporter <span class="op">+</span><span class="st"> </span>importer <span class="op">+</span><span class="st"> </span><span class="kw">offset</span>(log_tij_cfl),</a>
<a class="sourceLine" id="cb69-14" data-line-number="14">    <span class="dt">family =</span> <span class="kw">quasipoisson</span>(<span class="dt">link =</span> <span class="st">&quot;log&quot;</span>),</a>
<a class="sourceLine" id="cb69-15" data-line-number="15">    <span class="dt">data =</span> ch2_application1</a>
<a class="sourceLine" id="cb69-16" data-line-number="16">  )</a>
<a class="sourceLine" id="cb69-17" data-line-number="17">  </a>
<a class="sourceLine" id="cb69-18" data-line-number="18">  ch2_application1 &lt;-<span class="st"> </span>ch2_application1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb69-19" data-line-number="19"><span class="st">    </span><span class="kw">left_join</span>(</a>
<a class="sourceLine" id="cb69-20" data-line-number="20">      <span class="kw">yotov_fixed_effects</span>(fit_counterfactual_app1_<span class="dv">2</span>),</a>
<a class="sourceLine" id="cb69-21" data-line-number="21">      <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;exporter&quot;</span>, <span class="st">&quot;importer&quot;</span>)</a>
<a class="sourceLine" id="cb69-22" data-line-number="22">    )</a>
<a class="sourceLine" id="cb69-23" data-line-number="23">  </a>
<a class="sourceLine" id="cb69-24" data-line-number="24">  <span class="co"># compute the conditional general equilibrium effects of trade</span></a>
<a class="sourceLine" id="cb69-25" data-line-number="25">  ch2_application1 &lt;-<span class="st"> </span>ch2_application1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb69-26" data-line-number="26"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">tradehat_1 =</span> <span class="kw">predict</span>(fit_counterfactual_app1_<span class="dv">2</span>, ch2_application1, <span class="st">&quot;response&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb69-27" data-line-number="27"><span class="st">    </span><span class="kw">group_by</span>(exporter) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb69-28" data-line-number="28"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">y_cfl_1 =</span> <span class="kw">sum</span>(tradehat_<span class="dv">1</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb69-29" data-line-number="29"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb69-30" data-line-number="30"><span class="st">    </span></a>
<a class="sourceLine" id="cb69-31" data-line-number="31"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">e_cfl_1 =</span> <span class="kw">ifelse</span>(importer <span class="op">==</span><span class="st"> </span>exporter, phi <span class="op">*</span><span class="st"> </span>y_cfl_<span class="dv">1</span>, <span class="dv">0</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb69-32" data-line-number="32"><span class="st">    </span><span class="kw">group_by</span>(importer) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb69-33" data-line-number="33"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">e_cfl_1 =</span> <span class="kw">max</span>(e_cfl_<span class="dv">1</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb69-34" data-line-number="34"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb69-35" data-line-number="35"><span class="st">    </span></a>
<a class="sourceLine" id="cb69-36" data-line-number="36"><span class="st">    </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb69-37" data-line-number="37">      <span class="dt">e_r_cfl_1 =</span> <span class="kw">ifelse</span>(importer <span class="op">==</span><span class="st"> &quot;0-DEU&quot;</span>, e_cfl_<span class="dv">1</span>, <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb69-38" data-line-number="38">      <span class="dt">e_r_cfl_1 =</span> <span class="kw">max</span>(e_r_cfl_<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb69-39" data-line-number="39">    )</a>
<a class="sourceLine" id="cb69-40" data-line-number="40">  </a>
<a class="sourceLine" id="cb69-41" data-line-number="41">  <span class="co"># compute the change in prices for exporters and importers</span></a>
<a class="sourceLine" id="cb69-42" data-line-number="42">  ch2_application1 &lt;-<span class="st"> </span>ch2_application1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb69-43" data-line-number="43"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">change_p_i_1 =</span> ((<span class="kw">exp</span>(fe_exporter) <span class="op">/</span><span class="st"> </span>e_r_cfl_<span class="dv">1</span>) <span class="op">/</span><span class="st"> </span></a>
<a class="sourceLine" id="cb69-44" data-line-number="44"><span class="st">      </span>(<span class="kw">exp</span>(fe_exporter_cfl_<span class="dv">0</span>) <span class="op">/</span><span class="st"> </span>e_r_cfl_<span class="dv">0</span>))<span class="op">^</span>(<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>sigma)))</a>
<a class="sourceLine" id="cb69-45" data-line-number="45">  </a>
<a class="sourceLine" id="cb69-46" data-line-number="46">  <span class="co"># compute the change in prices for exporters and importers</span></a>
<a class="sourceLine" id="cb69-47" data-line-number="47">  ch2_application1 &lt;-<span class="st"> </span>ch2_application1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb69-48" data-line-number="48"><span class="st">    </span><span class="kw">group_by</span>(importer) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb69-49" data-line-number="49"><span class="st">    </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb69-50" data-line-number="50">      <span class="dt">change_p_j_1 =</span> <span class="kw">ifelse</span>(importer <span class="op">==</span><span class="st"> </span>exporter, change_p_i_<span class="dv">1</span>, <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb69-51" data-line-number="51">      <span class="dt">change_p_j_1 =</span> <span class="kw">max</span>(change_p_j_<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb69-52" data-line-number="52">    ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb69-53" data-line-number="53"><span class="st">    </span><span class="kw">ungroup</span>()</a>
<a class="sourceLine" id="cb69-54" data-line-number="54">  </a>
<a class="sourceLine" id="cb69-55" data-line-number="55">  <span class="co"># compute both outward and inward multilateral resistance</span></a>
<a class="sourceLine" id="cb69-56" data-line-number="56">  ch2_application1 &lt;-<span class="st"> </span>ch2_application1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb69-57" data-line-number="57"><span class="st">    </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb69-58" data-line-number="58">      <span class="dt">omr_cfl_1 =</span> (y_cfl_<span class="dv">1</span> <span class="op">*</span><span class="st"> </span>e_r_cfl_<span class="dv">1</span>) <span class="op">/</span><span class="st"> </span><span class="kw">exp</span>(fe_exporter),</a>
<a class="sourceLine" id="cb69-59" data-line-number="59">      <span class="dt">imr_cfl_1 =</span> e_cfl_<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="kw">exp</span>(fe_importer) <span class="op">*</span><span class="st"> </span>e_r_cfl_<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb69-60" data-line-number="60">    )</a>
<a class="sourceLine" id="cb69-61" data-line-number="61">  </a>
<a class="sourceLine" id="cb69-62" data-line-number="62">  <span class="co"># update the differences</span></a>
<a class="sourceLine" id="cb69-63" data-line-number="63">  max_dif &lt;-<span class="st"> </span><span class="kw">abs</span>(<span class="kw">max</span>(ch2_application1<span class="op">$</span>change_p_i_<span class="dv">0</span> <span class="op">-</span><span class="st"> </span>change_price_i_old))</a>
<a class="sourceLine" id="cb69-64" data-line-number="64">  sd_dif &lt;-<span class="st"> </span><span class="kw">sd</span>(ch2_application1<span class="op">$</span>change_p_i_<span class="dv">0</span> <span class="op">-</span><span class="st"> </span>change_price_i_old)</a>
<a class="sourceLine" id="cb69-65" data-line-number="65">  change_price_i_old &lt;-<span class="st"> </span>ch2_application1<span class="op">$</span>change_p_i_<span class="dv">0</span></a>
<a class="sourceLine" id="cb69-66" data-line-number="66">  </a>
<a class="sourceLine" id="cb69-67" data-line-number="67">  <span class="co"># compute changes in outward and inward multilateral resistance</span></a>
<a class="sourceLine" id="cb69-68" data-line-number="68">  ch2_application1 &lt;-<span class="st"> </span>ch2_application1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb69-69" data-line-number="69"><span class="st">    </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb69-70" data-line-number="70">      <span class="dt">change_omr_full_1 =</span> omr_cfl_<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>omr_cfl_<span class="dv">0</span>,</a>
<a class="sourceLine" id="cb69-71" data-line-number="71">      <span class="dt">change_imr_full_1 =</span> imr_cfl_<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>imr_cfl_<span class="dv">0</span>,</a>
<a class="sourceLine" id="cb69-72" data-line-number="72">      <span class="dt">omr_cfl_0 =</span> omr_cfl_<span class="dv">1</span>,</a>
<a class="sourceLine" id="cb69-73" data-line-number="73">      <span class="dt">imr_cfl_0 =</span> imr_cfl_<span class="dv">1</span>,</a>
<a class="sourceLine" id="cb69-74" data-line-number="74">      <span class="dt">change_omr_full_0 =</span> change_omr_full_<span class="dv">1</span>,</a>
<a class="sourceLine" id="cb69-75" data-line-number="75">      <span class="dt">change_imr_full_0 =</span> change_imr_full_<span class="dv">1</span>,</a>
<a class="sourceLine" id="cb69-76" data-line-number="76">      <span class="dt">change_p_i_0 =</span> change_p_i_<span class="dv">1</span>,</a>
<a class="sourceLine" id="cb69-77" data-line-number="77">      <span class="dt">change_p_j_0 =</span> change_p_j_<span class="dv">1</span>,</a>
<a class="sourceLine" id="cb69-78" data-line-number="78">      <span class="dt">fe_exporter_cfl_0 =</span> fe_exporter,</a>
<a class="sourceLine" id="cb69-79" data-line-number="79">      <span class="dt">fe_importer_cfl_0 =</span> fe_importer,</a>
<a class="sourceLine" id="cb69-80" data-line-number="80">      <span class="dt">tradehat_0 =</span> tradehat_<span class="dv">1</span>,</a>
<a class="sourceLine" id="cb69-81" data-line-number="81">      <span class="dt">e_r_cfl_0 =</span> e_r_cfl_<span class="dv">1</span></a>
<a class="sourceLine" id="cb69-82" data-line-number="82">    ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb69-83" data-line-number="83"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>fe_exporter, <span class="op">-</span>fe_importer)</a>
<a class="sourceLine" id="cb69-84" data-line-number="84">  </a>
<a class="sourceLine" id="cb69-85" data-line-number="85">  i &lt;-<span class="st"> </span>i <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb69-86" data-line-number="86">}</a></code></pre></div>
<p>Box #1 from page 108 in <span class="citation">Yotov et al. (<a href="#ref-yotov2016advanced">2016</a>)</span> shows the steps to obtain different endowments, which can be divided into smaller pieces.</p>
<p>We start computing the full endowment general equilibrium of factory-gate price (<code>change_p_i_full</code> and <code>change_p_j_full</code>) and the full endowment general equilibrium of output (<code>y_full</code>):</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb70-1" data-line-number="1">ch2_application1 &lt;-<span class="st"> </span>ch2_application1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb70-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb70-3" data-line-number="3">    <span class="dt">change_p_i_full =</span> ((<span class="kw">exp</span>(fe_exporter_cfl_<span class="dv">0</span>) <span class="op">/</span><span class="st"> </span>e_r_cfl_<span class="dv">0</span>) <span class="op">/</span></a>
<a class="sourceLine" id="cb70-4" data-line-number="4"><span class="st">                         </span>(<span class="kw">exp</span>(fe_exporter_bln) <span class="op">/</span><span class="st"> </span>e_r))<span class="op">^</span>(<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>sigma)),</a>
<a class="sourceLine" id="cb70-5" data-line-number="5">    <span class="dt">change_p_j_full =</span> change_p_i_full <span class="op">*</span><span class="st"> </span>(exporter <span class="op">==</span><span class="st"> </span>importer)</a>
<a class="sourceLine" id="cb70-6" data-line-number="6">  ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb70-7" data-line-number="7"><span class="st">  </span><span class="kw">group_by</span>(importer) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb70-8" data-line-number="8"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">change_p_j_full =</span> <span class="kw">max</span>(change_p_j_full)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb70-9" data-line-number="9"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb70-10" data-line-number="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">y_full =</span> change_p_i_full <span class="op">*</span><span class="st"> </span>y)</a></code></pre></div>
<p>Now we compute the full endowment general equilibrium of aggregate expenditures (<code>e_full</code> and <code>e_full_r</code>):</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb71-1" data-line-number="1">ch2_application1 &lt;-<span class="st"> </span>ch2_application1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb71-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">e_full =</span> change_p_j_full <span class="op">*</span><span class="st"> </span>e <span class="op">*</span><span class="st"> </span>(exporter <span class="op">==</span><span class="st"> </span>importer)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb71-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(importer) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb71-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">e_full =</span> <span class="kw">max</span>(e_full, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb71-5" data-line-number="5"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb71-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb71-7" data-line-number="7">    <span class="dt">e_full_r =</span> e_full <span class="op">*</span><span class="st"> </span>(importer <span class="op">==</span><span class="st"> &quot;0-DEU&quot;</span>),</a>
<a class="sourceLine" id="cb71-8" data-line-number="8">    <span class="dt">e_full_r =</span> <span class="kw">max</span>(e_full_r)</a>
<a class="sourceLine" id="cb71-9" data-line-number="9">  )</a></code></pre></div>
<p>With the aggregate expenditure we proceed to obtain the full endowment general equilibrium of the outward multilateral resistance (<code>omr_full</code>) and inward multilateral resistance (<code>imr_full</code>):</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb72-1" data-line-number="1">ch2_application1 &lt;-<span class="st"> </span>ch2_application1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb72-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb72-3" data-line-number="3">    <span class="dt">omr_full =</span> y_full <span class="op">*</span><span class="st"> </span>e_r_cfl_<span class="dv">0</span> <span class="op">/</span><span class="st"> </span><span class="kw">exp</span>(fe_exporter_cfl_<span class="dv">0</span>),</a>
<a class="sourceLine" id="cb72-4" data-line-number="4">    <span class="dt">imr_full =</span> e_full <span class="op">/</span><span class="st"> </span>(<span class="kw">exp</span>(fe_importer_cfl_<span class="dv">0</span>) <span class="op">*</span><span class="st"> </span>e_full_r)</a>
<a class="sourceLine" id="cb72-5" data-line-number="5">  )</a></code></pre></div>
<p>Finally we proceed to compute the full endowment general equilibrium of trade (<code>xi_full</code>):</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb73-1" data-line-number="1">ch2_application1 &lt;-<span class="st"> </span>ch2_application1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb73-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">x_full =</span> (y_full <span class="op">*</span><span class="st"> </span>e_full <span class="op">*</span><span class="st"> </span>tij_cfl) <span class="op">/</span><span class="st"> </span>(imr_full <span class="op">*</span><span class="st"> </span>omr_full)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb73-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(exporter) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb73-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">xi_full =</span> <span class="kw">sum</span>(x_full <span class="op">*</span><span class="st"> </span>(importer <span class="op">!=</span><span class="st"> </span>exporter))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb73-5" data-line-number="5"><span class="st">  </span><span class="kw">ungroup</span>()</a></code></pre></div>
</div>
<div id="step-iv-collect-construct-and-report-indexes-of-interest" class="section level3">
<h3><span class="header-section-number">3.1.5</span> Step IV: Collect, construct, and report indexes of interest</h3>
<p>Box #1 from page 108 in <span class="citation">Yotov et al. (<a href="#ref-yotov2016advanced">2016</a>)</span> consists in to construct the percentage change of the general equilibrium indexes. The steps are direct, we need to compute the change in full endowment general equilibrium factory-gate price on export side (<code>change_price_full</code>), the change in conditional and full general equilibrium outward multilateral resistances (<code>change_omr_*</code>), and the change in conditional and full general equilibrium international trade (<code>change_xi_*</code>):</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb74-1" data-line-number="1">ch2_application1 &lt;-<span class="st"> </span>ch2_application1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb74-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb74-3" data-line-number="3">    <span class="dt">change_price_full =</span> (change_p_i_full <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb74-4" data-line-number="4">    <span class="dt">change_omr_cfl =</span> (omr_cfl<span class="op">^</span>(<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>sigma)) <span class="op">/</span><span class="st"> </span>omr_bln<span class="op">^</span>(<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>sigma)) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb74-5" data-line-number="5">    <span class="dt">change_omr_full =</span> (omr_full<span class="op">^</span>(<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>sigma)) <span class="op">/</span><span class="st"> </span>omr_bln<span class="op">^</span>(<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>sigma)) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb74-6" data-line-number="6">    <span class="dt">change_xi_cfl =</span> (xi_cfl <span class="op">/</span><span class="st"> </span>xi_bln  <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb74-7" data-line-number="7">    <span class="dt">change_xi_full =</span> (xi_full <span class="op">/</span><span class="st"> </span>xi_bln <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb74-8" data-line-number="8">  )</a></code></pre></div>
<p>In addition to this, we need to something very similar for importers, in order to be able to recreate figure 7 later:</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb75-1" data-line-number="1">ch2_application1 &lt;-<span class="st"> </span>ch2_application1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb75-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb75-3" data-line-number="3">    <span class="dt">change_imr_full =</span> <span class="op">-</span>(imr_full<span class="op">^</span>(<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>sigma)) <span class="op">/</span><span class="st"> </span>imr_bln<span class="op">^</span>(<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>sigma)) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb75-4" data-line-number="4">    <span class="dt">rgdp =</span> ((y_full <span class="op">/</span><span class="st"> </span>imr_full<span class="op">^</span>(<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>sigma))) <span class="op">/</span><span class="st"> </span>(y <span class="op">/</span><span class="st"> </span>imr_bln<span class="op">^</span>(<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>sigma))) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb75-5" data-line-number="5">  )</a></code></pre></div>
</div>
<div id="figures-replication" class="section level3">
<h3><span class="header-section-number">3.1.6</span> Figures replication</h3>
<p>With all of the steps above, we are ready to create the plots from page 110. in <span class="citation">Yotov et al. (<a href="#ref-yotov2016advanced">2016</a>)</span>.</p>
<p>Figure 6 removes the observations where both the importer and the exporter are different, this can be seen in the original Stata code provided with the book.</p>
<p>We need to filter rows and to obtain <code>log(y)</code>:</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb76-1" data-line-number="1">ch2_application1 &lt;-<span class="st"> </span>ch2_application1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb76-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(exporter <span class="op">==</span><span class="st"> </span>importer) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb76-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(exporter, importer, y, change_xi_cfl, change_xi_full, rgdp, </a>
<a class="sourceLine" id="cb76-4" data-line-number="4">         change_price_full, change_imr_full) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb76-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">log_y =</span> <span class="kw">log</span>(y))</a></code></pre></div>
<p>In addition, the original code removes Hong Kong for visualization scale purposes:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb77-1" data-line-number="1"><span class="kw">ggplot</span>(<span class="dt">data =</span> ch2_application1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb77-2" data-line-number="2"><span class="st">         </span><span class="kw">filter</span>(exporter <span class="op">!=</span><span class="st"> &quot;HKG&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb77-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> log_y, <span class="dt">y =</span> change_xi_cfl, <span class="dt">color =</span> <span class="st">&quot;1&quot;</span>)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb77-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> log_y, <span class="dt">y =</span> change_xi_full, <span class="dt">color =</span> <span class="st">&quot;2&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb77-5" data-line-number="5"><span class="st">  </span><span class="kw">labs</span>(</a>
<a class="sourceLine" id="cb77-6" data-line-number="6">    <span class="dt">x =</span> <span class="st">&quot;Log value of output&quot;</span>,</a>
<a class="sourceLine" id="cb77-7" data-line-number="7">    <span class="dt">y =</span> <span class="st">&quot;Percent change of exports&quot;</span>,</a>
<a class="sourceLine" id="cb77-8" data-line-number="8">    <span class="dt">title =</span> <span class="st">&quot;Figure 6: Effects of abolishing international borders on exports&quot;</span>,</a>
<a class="sourceLine" id="cb77-9" data-line-number="9">    <span class="dt">caption =</span> <span class="st">&quot;Source: Authors&#39; calculations&quot;</span>,</a>
<a class="sourceLine" id="cb77-10" data-line-number="10">    <span class="dt">color =</span> <span class="st">&quot;&quot;</span></a>
<a class="sourceLine" id="cb77-11" data-line-number="11">  ) <span class="op">+</span></a>
<a class="sourceLine" id="cb77-12" data-line-number="12"><span class="st">  </span><span class="kw">theme_minimal</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb77-13" data-line-number="13"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb77-14" data-line-number="14"><span class="st">  </span><span class="kw">scale_color_manual</span>(</a>
<a class="sourceLine" id="cb77-15" data-line-number="15">    <span class="dt">labels =</span> <span class="kw">c</span>(</a>
<a class="sourceLine" id="cb77-16" data-line-number="16">      <span class="st">&quot;Conditional general equilibrium&quot;</span>,</a>
<a class="sourceLine" id="cb77-17" data-line-number="17">      <span class="st">&quot;Full endowment general equilibrium&quot;</span></a>
<a class="sourceLine" id="cb77-18" data-line-number="18">    ),</a>
<a class="sourceLine" id="cb77-19" data-line-number="19">    <span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;#b6b8dd&quot;</span>,<span class="st">&quot;#232958&quot;</span>)</a>
<a class="sourceLine" id="cb77-20" data-line-number="20">  )</a></code></pre></div>
<p><img src="yotover_files/figure-html/ch2_app1_figures_2-1.png" width="672" /></p>
<p>To create figure 7, we proceed in the same way as we did with figure 6:</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb78-1" data-line-number="1"><span class="kw">ggplot</span>(<span class="dt">data =</span> ch2_application1 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(exporter <span class="op">!=</span><span class="st"> &quot;HKG&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb78-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> log_y, <span class="dt">y =</span> change_imr_full, <span class="dt">color =</span> <span class="st">&quot;1&quot;</span>)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb78-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> log_y, <span class="dt">y =</span> change_price_full, <span class="dt">color =</span> <span class="st">&quot;2&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb78-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> log_y, <span class="dt">y =</span> rgdp, <span class="dt">color =</span> <span class="st">&quot;3&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb78-5" data-line-number="5"><span class="st">  </span><span class="kw">labs</span>(</a>
<a class="sourceLine" id="cb78-6" data-line-number="6">    <span class="dt">x =</span> <span class="st">&quot;Log value of output&quot;</span>,</a>
<a class="sourceLine" id="cb78-7" data-line-number="7">    <span class="dt">y =</span> <span class="st">&quot;Percent changes&quot;</span>,</a>
<a class="sourceLine" id="cb78-8" data-line-number="8">    <span class="dt">title =</span> <span class="st">&quot;Figure 7: Effects of abolishing international borders on real GDP&quot;</span>,</a>
<a class="sourceLine" id="cb78-9" data-line-number="9">    <span class="dt">caption =</span> <span class="st">&quot;Note: The inward multilateral resistances have been reformulated by multiplying their value by minus one.</span><span class="ch">\n</span><span class="st">Source: Authors&#39; calculations&quot;</span>,</a>
<a class="sourceLine" id="cb78-10" data-line-number="10">    <span class="dt">color =</span> <span class="st">&quot;&quot;</span></a>
<a class="sourceLine" id="cb78-11" data-line-number="11">  ) <span class="op">+</span></a>
<a class="sourceLine" id="cb78-12" data-line-number="12"><span class="st">  </span><span class="kw">theme_minimal</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb78-13" data-line-number="13"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb78-14" data-line-number="14"><span class="st">  </span><span class="kw">scale_color_manual</span>(</a>
<a class="sourceLine" id="cb78-15" data-line-number="15">    <span class="dt">labels =</span> <span class="kw">c</span>(</a>
<a class="sourceLine" id="cb78-16" data-line-number="16">      <span class="st">&quot;-(inward multilateral resistances)&quot;</span>,</a>
<a class="sourceLine" id="cb78-17" data-line-number="17">      <span class="st">&quot;Factory-gate price&quot;</span>,</a>
<a class="sourceLine" id="cb78-18" data-line-number="18">      <span class="st">&quot;Real GDP&quot;</span></a>
<a class="sourceLine" id="cb78-19" data-line-number="19">    ),</a>
<a class="sourceLine" id="cb78-20" data-line-number="20">    <span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;#3bade3&quot;</span>, <span class="st">&quot;#b6b8dd&quot;</span>, <span class="st">&quot;#232958&quot;</span>)</a>
<a class="sourceLine" id="cb78-21" data-line-number="21">  )</a></code></pre></div>
<p><img src="yotover_files/figure-html/ch2_app1_figures_3-1.png" width="672" /></p>
</div>
</div>
<div id="impact-of-regional-trade-agreements" class="section level2">
<h2><span class="header-section-number">3.2</span> Impact of regional trade agreements</h2>
<div id="initial-data-1" class="section level3">
<h3><span class="header-section-number">3.2.1</span> Initial data</h3>
<p>As in the previous application, we shall proceed by alternating both data transforming and regressions. Before doing what is shown in box #1 from page 112 in <span class="citation">Yotov et al. (<a href="#ref-yotov2016advanced">2016</a>)</span>, we need to convert “DEU” in both exporter and importer columns to “0-DEU”, just as in the last section, but we shall keep panel dimension of the dataset in order to identify the effects of RTAs and to comprehensively capture the impact of all time-invariant trade costs with the use of pair fixed effects:</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb79-1" data-line-number="1">ch2_application2 &lt;-<span class="st"> </span><span class="kw">yotov_data</span>(<span class="st">&quot;ch2_application2&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb79-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(year <span class="op">%in%</span><span class="st"> </span><span class="kw">seq</span>(<span class="dv">1986</span>, <span class="dv">2006</span>, <span class="dv">4</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb79-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb79-4" data-line-number="4">    <span class="dt">log_dist =</span> <span class="kw">log</span>(dist),</a>
<a class="sourceLine" id="cb79-5" data-line-number="5">    <span class="dt">intl =</span> <span class="kw">ifelse</span>(exporter <span class="op">!=</span><span class="st"> </span>importer, <span class="dv">1</span>, <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb79-6" data-line-number="6">    <span class="dt">exporter =</span> <span class="kw">ifelse</span>(exporter <span class="op">==</span><span class="st"> &quot;DEU&quot;</span>, <span class="st">&quot;0-DEU&quot;</span>, exporter),</a>
<a class="sourceLine" id="cb79-7" data-line-number="7">    <span class="dt">importer =</span> <span class="kw">ifelse</span>(importer <span class="op">==</span><span class="st"> &quot;DEU&quot;</span>, <span class="st">&quot;0-DEU&quot;</span>, importer)</a>
<a class="sourceLine" id="cb79-8" data-line-number="8">  ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb79-9" data-line-number="9"><span class="st">  </span></a>
<a class="sourceLine" id="cb79-10" data-line-number="10"><span class="st">  </span><span class="co"># Create Yit</span></a>
<a class="sourceLine" id="cb79-11" data-line-number="11"><span class="st">  </span><span class="kw">group_by</span>(exporter, year) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb79-12" data-line-number="12"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">y =</span> <span class="kw">sum</span>(trade)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb79-13" data-line-number="13"><span class="st">  </span></a>
<a class="sourceLine" id="cb79-14" data-line-number="14"><span class="st">  </span><span class="co"># Create Eit</span></a>
<a class="sourceLine" id="cb79-15" data-line-number="15"><span class="st">  </span><span class="kw">group_by</span>(importer, year) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb79-16" data-line-number="16"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">e =</span> <span class="kw">sum</span>(trade)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb79-17" data-line-number="17"><span class="st">  </span></a>
<a class="sourceLine" id="cb79-18" data-line-number="18"><span class="st">  </span><span class="co"># Create Er</span></a>
<a class="sourceLine" id="cb79-19" data-line-number="19"><span class="st">  </span><span class="kw">group_by</span>(year) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb79-20" data-line-number="20"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">e_r =</span> <span class="kw">max</span>(<span class="kw">ifelse</span>(importer <span class="op">==</span><span class="st"> &quot;0-DEU&quot;</span>, e, <span class="ot">NA</span>), <span class="dt">na.rm =</span> T))</a></code></pre></div>
<p>Because of the panel dimension, we proceed as we did in the previous chapter, by creating columns to combine exporter/importer and year (<code>exp_year</code> and <code>imp_year</code>) for the fixed effects, and a pairing variable <code>pair_id_2</code>:</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb80-1" data-line-number="1">ch2_application2 &lt;-<span class="st"> </span>ch2_application2 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb80-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb80-3" data-line-number="3">    <span class="dt">exp_year =</span> <span class="kw">paste0</span>(exporter, year),</a>
<a class="sourceLine" id="cb80-4" data-line-number="4">    <span class="dt">imp_year =</span> <span class="kw">paste0</span>(importer, year),</a>
<a class="sourceLine" id="cb80-5" data-line-number="5">    <span class="dt">pair_id_2 =</span> <span class="kw">ifelse</span>(exporter <span class="op">==</span><span class="st"> </span>importer, <span class="st">&quot;0-intra&quot;</span>, pair_id)</a>
<a class="sourceLine" id="cb80-6" data-line-number="6">  )</a></code></pre></div>
<p>In addition, we need to create the variable <code>sum_trade</code> to filter the cases where the sum by <code>pair_id</code> is zero:</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb81-1" data-line-number="1">ch2_application2 &lt;-<span class="st"> </span>ch2_application2 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb81-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(pair_id) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb81-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">sum_trade =</span> <span class="kw">sum</span>(trade)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb81-4" data-line-number="4"><span class="st">  </span><span class="kw">ungroup</span>()</a></code></pre></div>
</div>
<div id="step-1-solve-the-baseline-gravity-model" class="section level3">
<h3><span class="header-section-number">3.2.2</span> Step 1: Solve the baseline gravity model</h3>
<div id="stage-1-obtain-the-estimates-of-pair-fixed-effects-and-the-effects-of-rtas" class="section level4">
<h4><span class="header-section-number">3.2.2.1</span> Stage 1: Obtain the estimates of pair fixed effects and the effects of RTAs</h4>
<p>With the steps done before, it is straightforward to obtain the PPML regression shown in box #1 from page 112 in <span class="citation">Yotov et al. (<a href="#ref-yotov2016advanced">2016</a>)</span>:</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb82-1" data-line-number="1">fit_baseline_app2 &lt;-<span class="st"> </span><span class="kw">glm</span>(</a>
<a class="sourceLine" id="cb82-2" data-line-number="2">  trade <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>rta <span class="op">+</span><span class="st"> </span>exp_year <span class="op">+</span><span class="st"> </span>imp_year <span class="op">+</span><span class="st"> </span>pair_id_<span class="dv">2</span>,</a>
<a class="sourceLine" id="cb82-3" data-line-number="3">  <span class="dt">family =</span> <span class="kw">quasipoisson</span>(<span class="dt">link =</span> <span class="st">&quot;log&quot;</span>),</a>
<a class="sourceLine" id="cb82-4" data-line-number="4">  <span class="dt">data =</span> <span class="kw">filter</span>(ch2_application2, sum_trade <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb82-5" data-line-number="5">)</a></code></pre></div>
<p>With the estimated model, we can construct the variables for export (<code>exp_year</code>), import (<code>imp_year</code>) and pair (<code>pair_id_2</code>) fixed effects:</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb83-1" data-line-number="1">ch2_application2 &lt;-<span class="st"> </span>ch2_application2 <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb83-2" data-line-number="2"><span class="st">  </span><span class="kw">left_join</span>(</a>
<a class="sourceLine" id="cb83-3" data-line-number="3">    <span class="kw">yotov_fixed_effects</span>(fit_baseline_app2),</a>
<a class="sourceLine" id="cb83-4" data-line-number="4">    <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;exp_year&quot;</span>, <span class="st">&quot;imp_year&quot;</span>, <span class="st">&quot;pair_id_2&quot;</span>)</a>
<a class="sourceLine" id="cb83-5" data-line-number="5">  )</a></code></pre></div>
</div>
<div id="stage-2-regress-the-estimates-of-pair-fixed-effects-on-gravity-variables-and-country-fixed-effects" class="section level4">
<h4><span class="header-section-number">3.2.2.2</span> Stage 2: Regress the estimates of pair fixed effects on gravity variables and country fixed effects</h4>
<p>Box #1 from page 113 in <span class="citation">Yotov et al. (<a href="#ref-yotov2016advanced">2016</a>)</span> can be divided in smaller chunks.</p>
<p>We start by filtering to keep the observation from 1994, and then we compute the trade costs (<code>tij_bar</code> and <code>tijn_bln</code>) from the <code>fe_pair_id_2</code> fixed effects and the estimated RTA coefficient:</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb84-1" data-line-number="1">ch2_application2 &lt;-<span class="st"> </span>ch2_application2 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb84-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb84-3" data-line-number="3">    <span class="dt">tij_bar =</span> <span class="kw">exp</span>(fe_pair_id_<span class="dv">2</span>),</a>
<a class="sourceLine" id="cb84-4" data-line-number="4">    <span class="dt">tij_bln =</span> <span class="kw">exp</span>(fe_pair_id_<span class="dv">2</span> <span class="op">+</span><span class="st"> </span>fit_baseline_app2<span class="op">$</span>coefficients[<span class="st">&quot;rta&quot;</span>] <span class="op">*</span><span class="st"> </span>rta)</a>
<a class="sourceLine" id="cb84-5" data-line-number="5">  )</a></code></pre></div>
<p>Now we need to create a table for the year 1994 which will be used to predict the trade costs for the observations with zero trade flows. The reason to create a sub-table, instead of filtering observations in the regression function, is that is eases posterior work to predict the costs.</p>
<p>To start the cost estimation we start with:</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb85-1" data-line-number="1">ch2_application2_<span class="dv">1994</span> &lt;-<span class="st"> </span>ch2_application2 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb85-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">1994</span>, exporter <span class="op">!=</span><span class="st"> </span>importer)</a></code></pre></div>
<p>Now, unlike the book, which duplicates <code>tij_bar</code> by creating <code>tij</code>, we can fit a regression to estimate the costs:</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb86-1" data-line-number="1">fit_costs_app2 &lt;-<span class="st"> </span><span class="kw">glm</span>(</a>
<a class="sourceLine" id="cb86-2" data-line-number="2">  tij_bar <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>log_dist <span class="op">+</span><span class="st"> </span>cntg <span class="op">+</span><span class="st"> </span>lang <span class="op">+</span><span class="st"> </span>clny <span class="op">+</span><span class="st"> </span>exporter <span class="op">+</span><span class="st"> </span>importer,</a>
<a class="sourceLine" id="cb86-3" data-line-number="3">  <span class="dt">family =</span> <span class="kw">quasipoisson</span>(<span class="dt">link =</span> <span class="st">&quot;log&quot;</span>),</a>
<a class="sourceLine" id="cb86-4" data-line-number="4">  <span class="dt">data =</span> ch2_application2_<span class="dv">1994</span></a>
<a class="sourceLine" id="cb86-5" data-line-number="5">)</a></code></pre></div>
<p>With the regression we add the fitted values to the sub-table:</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb87-1" data-line-number="1">ch2_application2_<span class="dv">1994</span> &lt;-<span class="st"> </span>ch2_application2_<span class="dv">1994</span> <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb87-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">tij_no_rta =</span> <span class="kw">predict</span>(fit_costs_app2, ch2_application2_<span class="dv">1994</span>, <span class="st">&quot;response&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb87-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(exporter, importer, tij_no_rta)</a></code></pre></div>
<p>The final step is to keep the observations for the year 1994 in the original table and replace the missing costs with the predicted values:</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb88-1" data-line-number="1">ch2_application2 &lt;-<span class="st"> </span>ch2_application2 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb88-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">1994</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb88-3" data-line-number="3"><span class="st">  </span><span class="kw">left_join</span>(ch2_application2_<span class="dv">1994</span>, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;exporter&quot;</span>, <span class="st">&quot;importer&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb88-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb88-5" data-line-number="5">    <span class="dt">tij_bar =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(tij_bar), tij_no_rta, tij_bar),</a>
<a class="sourceLine" id="cb88-6" data-line-number="6">    <span class="dt">tij_bln =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(tij_bln), tij_bar <span class="op">*</span><span class="st"> </span><span class="kw">exp</span>(fit_baseline_app2<span class="op">$</span>coefficients[<span class="st">&quot;rta&quot;</span>] <span class="op">*</span><span class="st"> </span>rta), tij_bln)</a>
<a class="sourceLine" id="cb88-7" data-line-number="7">  ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb88-8" data-line-number="8"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>tij_no_rta) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb88-9" data-line-number="9"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">log_tij_bln =</span> <span class="kw">log</span>(tij_bln))</a></code></pre></div>
<p>Box #2 from page 113 in <span class="citation">Yotov et al. (<a href="#ref-yotov2016advanced">2016</a>)</span> is more straightforward.</p>
<p>The first part to complete Box #2 consists in solving the constrained baseline gravity model:</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb89-1" data-line-number="1">fit_constrained_app2 &lt;-<span class="st"> </span><span class="kw">glm</span>(</a>
<a class="sourceLine" id="cb89-2" data-line-number="2">  trade <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>exporter <span class="op">+</span><span class="st"> </span>importer <span class="op">+</span><span class="st"> </span><span class="kw">offset</span>(log_tij_bln),</a>
<a class="sourceLine" id="cb89-3" data-line-number="3">  <span class="dt">family =</span> <span class="kw">quasipoisson</span>(<span class="dt">link =</span> <span class="st">&quot;log&quot;</span>),</a>
<a class="sourceLine" id="cb89-4" data-line-number="4">  <span class="dt">data =</span> ch2_application2</a>
<a class="sourceLine" id="cb89-5" data-line-number="5">)</a></code></pre></div>
<p>With the fitted model we can add the prediction and the <code>xi_bln</code> column:</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb90-1" data-line-number="1">ch2_application2 &lt;-<span class="st"> </span>ch2_application2 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb90-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">tradehat_bln =</span> <span class="kw">predict</span>(fit_constrained_app2, ch2_application2, <span class="st">&quot;response&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb90-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(exporter) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb90-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">xi_bln =</span> <span class="kw">sum</span>(tradehat_bln <span class="op">*</span><span class="st"> </span>(exporter <span class="op">!=</span><span class="st"> </span>importer))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb90-5" data-line-number="5"><span class="st">  </span><span class="kw">ungroup</span>()</a></code></pre></div>
<p>The book specifies that all other baseline indexes of interest can be obtained by applying the exact same procedure as described in the previous application. Here we’ll obtain the multilateral resistances terms (<code>omr_bln</code> and <code>imr_bln</code>) by adding the fixed effects from the constrained model to the data:</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb91-1" data-line-number="1">ch2_application2 &lt;-<span class="st"> </span>ch2_application2 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb91-2" data-line-number="2"><span class="st">  </span><span class="kw">left_join</span>(<span class="kw">yotov_fixed_effects</span>(fit_constrained_app2), <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;exporter&quot;</span>,<span class="st">&quot;importer&quot;</span>))</a>
<a class="sourceLine" id="cb91-3" data-line-number="3"></a>
<a class="sourceLine" id="cb91-4" data-line-number="4">ch2_application2 &lt;-<span class="st"> </span>ch2_application2 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb91-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb91-6" data-line-number="6">    <span class="dt">omr_bln =</span> y <span class="op">*</span><span class="st"> </span>e_r<span class="op">/</span><span class="st"> </span><span class="kw">exp</span>(fe_exporter),</a>
<a class="sourceLine" id="cb91-7" data-line-number="7">    <span class="dt">imr_bln =</span> e <span class="op">/</span><span class="st"> </span>(<span class="kw">exp</span>(fe_importer) <span class="op">*</span><span class="st"> </span>e_r)</a>
<a class="sourceLine" id="cb91-8" data-line-number="8">  )</a></code></pre></div>
</div>
</div>
<div id="step-ii-define-a-counterfactual-scenario-1" class="section level3">
<h3><span class="header-section-number">3.2.3</span> Step II: Define a counterfactual scenario</h3>
<p>Box #1 from page 114 in <span class="citation">Yotov et al. (<a href="#ref-yotov2016advanced">2016</a>)</span> is direct and consists in replacing the RTA values by zero if the pairs of countries are NAFTA members:</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb92-1" data-line-number="1">nafta &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;MEX&quot;</span>, <span class="st">&quot;USA&quot;</span>, <span class="st">&quot;CAN&quot;</span>)</a>
<a class="sourceLine" id="cb92-2" data-line-number="2"></a>
<a class="sourceLine" id="cb92-3" data-line-number="3">ch2_application2 &lt;-<span class="st"> </span>ch2_application2 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb92-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb92-5" data-line-number="5">    <span class="dt">rta_no_nafta =</span> <span class="kw">ifelse</span>(exporter <span class="op">%in%</span><span class="st"> </span>nafta <span class="op">&amp;</span><span class="st"> </span>importer <span class="op">%in%</span><span class="st"> </span>nafta, <span class="dv">0</span>, rta),</a>
<a class="sourceLine" id="cb92-6" data-line-number="6">    <span class="dt">tij_cfl =</span> tij_bar <span class="op">*</span><span class="st"> </span><span class="kw">exp</span>(fit_baseline_app2<span class="op">$</span>coefficients[<span class="st">&quot;rta&quot;</span>] <span class="op">*</span><span class="st"> </span>rta_no_nafta),</a>
<a class="sourceLine" id="cb92-7" data-line-number="7">    <span class="dt">log_tij_cfl =</span> <span class="kw">log</span>(tij_cfl)</a>
<a class="sourceLine" id="cb92-8" data-line-number="8">  )</a></code></pre></div>
</div>
<div id="step-iii-solve-the-counterfactual-model-1" class="section level3">
<h3><span class="header-section-number">3.2.4</span> Step III: Solve the counterfactual model</h3>
<p>The exact same procedure from the previous section applies to obtain the conditional general equilibrium effects and then to compute the full endowment general equilibrium effects.</p>
<p>We start by fitting a counterfactual model:</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb93-1" data-line-number="1">fit_counterfactual_app2 &lt;-<span class="st"> </span><span class="kw">glm</span>(</a>
<a class="sourceLine" id="cb93-2" data-line-number="2">  trade <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>exporter <span class="op">+</span><span class="st"> </span>importer <span class="op">+</span><span class="st"> </span><span class="kw">offset</span>(log_tij_cfl),</a>
<a class="sourceLine" id="cb93-3" data-line-number="3">  <span class="dt">family =</span> <span class="kw">quasipoisson</span>(<span class="dt">link =</span> <span class="st">&quot;log&quot;</span>),</a>
<a class="sourceLine" id="cb93-4" data-line-number="4">  <span class="dt">data =</span> ch2_application2</a>
<a class="sourceLine" id="cb93-5" data-line-number="5">)</a></code></pre></div>
<p>With the fitted model we add the fixed effects:</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb94-1" data-line-number="1">ch2_application2 &lt;-<span class="st"> </span>ch2_application2 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb94-2" data-line-number="2"><span class="st">  </span><span class="kw">left_join</span>(<span class="kw">yotov_fixed_effects</span>(fit_counterfactual_app2), <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;exporter&quot;</span>,<span class="st">&quot;importer&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb94-3" data-line-number="3"><span class="st">  </span><span class="kw">rename</span>(</a>
<a class="sourceLine" id="cb94-4" data-line-number="4">    <span class="dt">fe_exporter_bln =</span> fe_exporter.x,</a>
<a class="sourceLine" id="cb94-5" data-line-number="5">    <span class="dt">fe_exporter_cfl =</span> fe_exporter.y,</a>
<a class="sourceLine" id="cb94-6" data-line-number="6">    <span class="dt">fe_importer_bln =</span> fe_importer.x,</a>
<a class="sourceLine" id="cb94-7" data-line-number="7">    <span class="dt">fe_importer_cfl =</span> fe_importer.y</a>
<a class="sourceLine" id="cb94-8" data-line-number="8">  )</a></code></pre></div>
<p>As we did in stage 2, we compute the multilateral resistance terms:</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb95-1" data-line-number="1">ch2_application2 &lt;-<span class="st"> </span>ch2_application2 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb95-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb95-3" data-line-number="3">    <span class="dt">omr_cfl =</span> y <span class="op">*</span><span class="st"> </span>e_r <span class="op">/</span><span class="st"> </span><span class="kw">exp</span>(fe_exporter_cfl),</a>
<a class="sourceLine" id="cb95-4" data-line-number="4">    <span class="dt">imr_cfl =</span> e <span class="op">/</span><span class="st"> </span>(<span class="kw">exp</span>(fe_importer_cfl) <span class="op">*</span><span class="st"> </span>e_r)</a>
<a class="sourceLine" id="cb95-5" data-line-number="5">  )</a></code></pre></div>
<p>Up to this point we are ready to compute the conditional general equilibrium effects of trade:</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb96-1" data-line-number="1">ch2_application2 &lt;-<span class="st"> </span>ch2_application2 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb96-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">tradehat_cfl =</span> <span class="kw">predict</span>(fit_counterfactual_app2, ch2_application2, <span class="st">&quot;response&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb96-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(exporter) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb96-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">xi_cfl =</span> <span class="kw">sum</span>(tradehat_cfl <span class="op">*</span><span class="st"> </span>(exporter <span class="op">!=</span><span class="st"> </span>importer))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb96-5" data-line-number="5"><span class="st">  </span><span class="kw">ungroup</span>()</a></code></pre></div>
<p>Now we are going to compute the full endowment general equilibrium effects. We start by repeating the steps to obtain <code>change_tij</code> and <code>phi</code> from the last section:</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb97-1" data-line-number="1"><span class="co"># set the criteria of convergence</span></a>
<a class="sourceLine" id="cb97-2" data-line-number="2"><span class="co"># taken from the literature (see the Stata code)</span></a>
<a class="sourceLine" id="cb97-3" data-line-number="3">sigma &lt;-<span class="st"> </span><span class="dv">7</span></a>
<a class="sourceLine" id="cb97-4" data-line-number="4"></a>
<a class="sourceLine" id="cb97-5" data-line-number="5">ch2_application2 &lt;-<span class="st"> </span>ch2_application2 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb97-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb97-7" data-line-number="7">    <span class="dt">change_tij =</span> tij_cfl <span class="op">/</span><span class="st"> </span>tij_bln,</a>
<a class="sourceLine" id="cb97-8" data-line-number="8">    <span class="dt">phi =</span> <span class="kw">ifelse</span>(importer <span class="op">==</span><span class="st"> </span>exporter, e <span class="op">/</span><span class="st"> </span>y, <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb97-9" data-line-number="9">  ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb97-10" data-line-number="10"><span class="st">  </span><span class="kw">group_by</span>(exporter) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb97-11" data-line-number="11"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">phi =</span> <span class="kw">max</span>(phi)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb97-12" data-line-number="12"><span class="st">  </span><span class="kw">ungroup</span>()</a></code></pre></div>
<p>Now we compute <code>change_p_i</code>, <code>change_p_j</code> and <code>trade_cfl</code>. Again, this is just a repetition of the previous steps with some adaptation:</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb98-1" data-line-number="1">ch2_application2 &lt;-<span class="st"> </span>ch2_application2 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb98-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(exporter) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb98-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">change_p_i =</span> ((<span class="kw">exp</span>(fe_exporter_cfl) <span class="op">/</span><span class="st"> </span>e_r) <span class="op">/</span><span class="st"> </span>(<span class="kw">exp</span>(fe_exporter_bln) <span class="op">/</span><span class="st"> </span>e_r))<span class="op">^</span>(<span class="dv">1</span> <span class="op">/</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>sigma))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb98-4" data-line-number="4"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb98-5" data-line-number="5"><span class="st">  </span></a>
<a class="sourceLine" id="cb98-6" data-line-number="6"><span class="st">  </span><span class="kw">group_by</span>(importer) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb98-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb98-8" data-line-number="8">    <span class="dt">change_p_j =</span> <span class="kw">ifelse</span>(importer <span class="op">==</span><span class="st"> </span>exporter, change_p_i, <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb98-9" data-line-number="9">    <span class="dt">change_p_j =</span> <span class="kw">max</span>(change_p_j)</a>
<a class="sourceLine" id="cb98-10" data-line-number="10">  ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb98-11" data-line-number="11"><span class="st">  </span><span class="kw">ungroup</span>()</a>
<a class="sourceLine" id="cb98-12" data-line-number="12"></a>
<a class="sourceLine" id="cb98-13" data-line-number="13">ch2_application2 &lt;-<span class="st"> </span>ch2_application2 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb98-14" data-line-number="14"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">trade_cfl =</span> tradehat_cfl <span class="op">*</span><span class="st"> </span>change_p_i <span class="op">*</span><span class="st"> </span>change_p_j)</a></code></pre></div>
<p>Then we need a <code>while()</code> loop, but before we need to duplicate some columns under new names for the loop operations:</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb99-1" data-line-number="1">ch2_application2 &lt;-<span class="st"> </span>ch2_application2 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb99-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb99-3" data-line-number="3">    <span class="dt">omr_cfl_0 =</span> omr_cfl,</a>
<a class="sourceLine" id="cb99-4" data-line-number="4">    <span class="dt">imr_cfl_0 =</span> imr_cfl,</a>
<a class="sourceLine" id="cb99-5" data-line-number="5">    <span class="dt">change_imr_full_0 =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb99-6" data-line-number="6">    <span class="dt">change_omr_full_0 =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb99-7" data-line-number="7">    <span class="dt">change_p_i_0 =</span> change_p_i,</a>
<a class="sourceLine" id="cb99-8" data-line-number="8">    <span class="dt">change_p_j_0 =</span> change_p_j,</a>
<a class="sourceLine" id="cb99-9" data-line-number="9">    <span class="dt">fe_exporter_cfl_0 =</span> fe_exporter_cfl,</a>
<a class="sourceLine" id="cb99-10" data-line-number="10">    <span class="dt">fe_importer_cfl_0 =</span> fe_importer_cfl,</a>
<a class="sourceLine" id="cb99-11" data-line-number="11">    <span class="dt">tradehat_0 =</span> tradehat_cfl,</a>
<a class="sourceLine" id="cb99-12" data-line-number="12">    <span class="dt">e_r_cfl_0 =</span> e_r</a>
<a class="sourceLine" id="cb99-13" data-line-number="13">  )</a></code></pre></div>
<p>And now we run the loop, where the step <span class="math inline">\(N\)</span> depends on the step <span class="math inline">\(N-1\)</span> as in the previous section:</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb100-1" data-line-number="1"><span class="co"># set parameters</span></a>
<a class="sourceLine" id="cb100-2" data-line-number="2">max_dif &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb100-3" data-line-number="3">sd_dif &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb100-4" data-line-number="4">change_price_i_old &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb100-5" data-line-number="5"></a>
<a class="sourceLine" id="cb100-6" data-line-number="6">i2 &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb100-7" data-line-number="7"><span class="cf">while</span>(sd_dif <span class="op">&gt;</span><span class="st"> </span><span class="fl">1e-3</span> <span class="op">|</span><span class="st"> </span>max_dif <span class="op">&gt;</span><span class="st"> </span><span class="fl">1e-3</span>) {</a>
<a class="sourceLine" id="cb100-8" data-line-number="8">  ch2_application2 &lt;-<span class="st"> </span>ch2_application2 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb100-9" data-line-number="9"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">trade_1 =</span> tradehat_<span class="dv">0</span> <span class="op">*</span><span class="st"> </span>change_p_i_<span class="dv">0</span> <span class="op">*</span><span class="st"> </span>change_p_j_<span class="dv">0</span> <span class="op">/</span><span class="st"> </span>(change_omr_full_<span class="dv">0</span> <span class="op">*</span><span class="st"> </span>change_imr_full_<span class="dv">0</span>))</a>
<a class="sourceLine" id="cb100-10" data-line-number="10">  </a>
<a class="sourceLine" id="cb100-11" data-line-number="11">  <span class="co"># repeat the counterfactual model</span></a>
<a class="sourceLine" id="cb100-12" data-line-number="12">  fit_counterfactual_app2_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw">glm</span>(</a>
<a class="sourceLine" id="cb100-13" data-line-number="13">    trade_<span class="dv">1</span> <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>exporter <span class="op">+</span><span class="st"> </span>importer <span class="op">+</span><span class="st"> </span><span class="kw">offset</span>(log_tij_cfl),</a>
<a class="sourceLine" id="cb100-14" data-line-number="14">    <span class="dt">family =</span> <span class="kw">quasipoisson</span>(<span class="dt">link =</span> <span class="st">&quot;log&quot;</span>),</a>
<a class="sourceLine" id="cb100-15" data-line-number="15">    <span class="dt">data =</span> ch2_application2</a>
<a class="sourceLine" id="cb100-16" data-line-number="16">  )</a>
<a class="sourceLine" id="cb100-17" data-line-number="17">  </a>
<a class="sourceLine" id="cb100-18" data-line-number="18">  ch2_application2 &lt;-<span class="st"> </span>ch2_application2 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb100-19" data-line-number="19"><span class="st">    </span><span class="kw">left_join</span>(</a>
<a class="sourceLine" id="cb100-20" data-line-number="20">      <span class="kw">yotov_fixed_effects</span>(fit_counterfactual_app2_<span class="dv">2</span>),</a>
<a class="sourceLine" id="cb100-21" data-line-number="21">      <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;exporter&quot;</span>, <span class="st">&quot;importer&quot;</span>)</a>
<a class="sourceLine" id="cb100-22" data-line-number="22">    )</a>
<a class="sourceLine" id="cb100-23" data-line-number="23">  </a>
<a class="sourceLine" id="cb100-24" data-line-number="24">  <span class="co"># compute the conditional general equilibrium effects of trade</span></a>
<a class="sourceLine" id="cb100-25" data-line-number="25">  ch2_application2 &lt;-<span class="st"> </span>ch2_application2 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb100-26" data-line-number="26"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">tradehat_1 =</span> <span class="kw">predict</span>(fit_counterfactual_app2_<span class="dv">2</span>, ch2_application2, <span class="st">&quot;response&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb100-27" data-line-number="27"><span class="st">    </span><span class="kw">group_by</span>(exporter) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb100-28" data-line-number="28"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">y_cfl_1 =</span> <span class="kw">sum</span>(tradehat_<span class="dv">1</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb100-29" data-line-number="29"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb100-30" data-line-number="30"><span class="st">    </span></a>
<a class="sourceLine" id="cb100-31" data-line-number="31"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">e_cfl_1 =</span> <span class="kw">ifelse</span>(importer <span class="op">==</span><span class="st"> </span>exporter, phi <span class="op">*</span><span class="st"> </span>y_cfl_<span class="dv">1</span>, <span class="dv">0</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb100-32" data-line-number="32"><span class="st">    </span><span class="kw">group_by</span>(importer) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb100-33" data-line-number="33"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">e_cfl_1 =</span> <span class="kw">max</span>(e_cfl_<span class="dv">1</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb100-34" data-line-number="34"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb100-35" data-line-number="35"><span class="st">    </span></a>
<a class="sourceLine" id="cb100-36" data-line-number="36"><span class="st">    </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb100-37" data-line-number="37">      <span class="dt">e_r_cfl_1 =</span> <span class="kw">ifelse</span>(importer <span class="op">==</span><span class="st"> &quot;0-DEU&quot;</span>, e_cfl_<span class="dv">1</span>, <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb100-38" data-line-number="38">      <span class="dt">e_r_cfl_1 =</span> <span class="kw">max</span>(e_r_cfl_<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb100-39" data-line-number="39">    )</a>
<a class="sourceLine" id="cb100-40" data-line-number="40">  </a>
<a class="sourceLine" id="cb100-41" data-line-number="41">  <span class="co"># compute the change in prices for exporters and importers</span></a>
<a class="sourceLine" id="cb100-42" data-line-number="42">  ch2_application2 &lt;-<span class="st"> </span>ch2_application2 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb100-43" data-line-number="43"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">change_p_i_1 =</span> ((<span class="kw">exp</span>(fe_exporter) <span class="op">/</span><span class="st"> </span>e_r_cfl_<span class="dv">1</span>) <span class="op">/</span><span class="st"> </span></a>
<a class="sourceLine" id="cb100-44" data-line-number="44"><span class="st">      </span>(<span class="kw">exp</span>(fe_exporter_cfl_<span class="dv">0</span>) <span class="op">/</span><span class="st"> </span>e_r_cfl_<span class="dv">0</span>))<span class="op">^</span>(<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>sigma)))</a>
<a class="sourceLine" id="cb100-45" data-line-number="45">  </a>
<a class="sourceLine" id="cb100-46" data-line-number="46">  <span class="co"># compute the change in prices for exporters and importers</span></a>
<a class="sourceLine" id="cb100-47" data-line-number="47">  ch2_application2 &lt;-<span class="st"> </span>ch2_application2 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb100-48" data-line-number="48"><span class="st">    </span><span class="kw">group_by</span>(importer) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb100-49" data-line-number="49"><span class="st">    </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb100-50" data-line-number="50">      <span class="dt">change_p_j_1 =</span> <span class="kw">ifelse</span>(importer <span class="op">==</span><span class="st"> </span>exporter, change_p_i_<span class="dv">1</span>, <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb100-51" data-line-number="51">      <span class="dt">change_p_j_1 =</span> <span class="kw">max</span>(change_p_j_<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb100-52" data-line-number="52">    ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb100-53" data-line-number="53"><span class="st">    </span><span class="kw">ungroup</span>()</a>
<a class="sourceLine" id="cb100-54" data-line-number="54">  </a>
<a class="sourceLine" id="cb100-55" data-line-number="55">  <span class="co"># compute both outward and inward multilateral resistance</span></a>
<a class="sourceLine" id="cb100-56" data-line-number="56">  ch2_application2 &lt;-<span class="st"> </span>ch2_application2 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb100-57" data-line-number="57"><span class="st">    </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb100-58" data-line-number="58">      <span class="dt">omr_cfl_1 =</span> (y_cfl_<span class="dv">1</span> <span class="op">*</span><span class="st"> </span>e_r_cfl_<span class="dv">1</span>) <span class="op">/</span><span class="st"> </span><span class="kw">exp</span>(fe_exporter),</a>
<a class="sourceLine" id="cb100-59" data-line-number="59">      <span class="dt">imr_cfl_1 =</span> e_cfl_<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="kw">exp</span>(fe_importer) <span class="op">*</span><span class="st"> </span>e_r_cfl_<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb100-60" data-line-number="60">    )</a>
<a class="sourceLine" id="cb100-61" data-line-number="61">  </a>
<a class="sourceLine" id="cb100-62" data-line-number="62">  <span class="co"># update the differences</span></a>
<a class="sourceLine" id="cb100-63" data-line-number="63">  max_dif &lt;-<span class="st"> </span><span class="kw">abs</span>(<span class="kw">max</span>(ch2_application2<span class="op">$</span>change_p_i_<span class="dv">0</span> <span class="op">-</span><span class="st"> </span>change_price_i_old))</a>
<a class="sourceLine" id="cb100-64" data-line-number="64">  sd_dif &lt;-<span class="st"> </span><span class="kw">sd</span>(ch2_application2<span class="op">$</span>change_p_i_<span class="dv">0</span> <span class="op">-</span><span class="st"> </span>change_price_i_old)</a>
<a class="sourceLine" id="cb100-65" data-line-number="65">  change_price_i_old &lt;-<span class="st"> </span>ch2_application2<span class="op">$</span>change_p_i_<span class="dv">0</span></a>
<a class="sourceLine" id="cb100-66" data-line-number="66">  </a>
<a class="sourceLine" id="cb100-67" data-line-number="67">  <span class="co"># compute changes in outward and inward multilateral resistance</span></a>
<a class="sourceLine" id="cb100-68" data-line-number="68">  ch2_application2 &lt;-<span class="st"> </span>ch2_application2 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb100-69" data-line-number="69"><span class="st">    </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb100-70" data-line-number="70">      <span class="dt">change_omr_full_1 =</span> omr_cfl_<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>omr_cfl_<span class="dv">0</span>,</a>
<a class="sourceLine" id="cb100-71" data-line-number="71">      <span class="dt">change_imr_full_1 =</span> imr_cfl_<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>imr_cfl_<span class="dv">0</span>,</a>
<a class="sourceLine" id="cb100-72" data-line-number="72">      <span class="dt">omr_cfl_0 =</span> omr_cfl_<span class="dv">1</span>,</a>
<a class="sourceLine" id="cb100-73" data-line-number="73">      <span class="dt">imr_cfl_0 =</span> imr_cfl_<span class="dv">1</span>,</a>
<a class="sourceLine" id="cb100-74" data-line-number="74">      <span class="dt">change_omr_full_0 =</span> change_omr_full_<span class="dv">1</span>,</a>
<a class="sourceLine" id="cb100-75" data-line-number="75">      <span class="dt">change_imr_full_0 =</span> change_imr_full_<span class="dv">1</span>,</a>
<a class="sourceLine" id="cb100-76" data-line-number="76">      <span class="dt">change_p_i_0 =</span> change_p_i_<span class="dv">1</span>,</a>
<a class="sourceLine" id="cb100-77" data-line-number="77">      <span class="dt">change_p_j_0 =</span> change_p_j_<span class="dv">1</span>,</a>
<a class="sourceLine" id="cb100-78" data-line-number="78">      <span class="dt">fe_exporter_cfl_0 =</span> fe_exporter,</a>
<a class="sourceLine" id="cb100-79" data-line-number="79">      <span class="dt">fe_importer_cfl_0 =</span> fe_importer,</a>
<a class="sourceLine" id="cb100-80" data-line-number="80">      <span class="dt">tradehat_0 =</span> tradehat_<span class="dv">1</span>,</a>
<a class="sourceLine" id="cb100-81" data-line-number="81">      <span class="dt">e_r_cfl_0 =</span> e_r_cfl_<span class="dv">1</span></a>
<a class="sourceLine" id="cb100-82" data-line-number="82">    ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb100-83" data-line-number="83"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>fe_exporter, <span class="op">-</span>fe_importer)</a>
<a class="sourceLine" id="cb100-84" data-line-number="84">  </a>
<a class="sourceLine" id="cb100-85" data-line-number="85">  i2 &lt;-<span class="st"> </span>i2 <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb100-86" data-line-number="86">}</a></code></pre></div>
<p>The last loop allows us to obtain <code>change_p_i_full</code>, <code>change_p_j_full</code> and <code>y_full</code>:</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb101-1" data-line-number="1">ch2_application2 &lt;-<span class="st"> </span>ch2_application2 <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb101-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb101-3" data-line-number="3">    <span class="dt">change_p_i_full =</span> ((<span class="kw">exp</span>(fe_exporter_cfl_<span class="dv">0</span>) <span class="op">/</span><span class="st"> </span>e_r_cfl_<span class="dv">0</span>) <span class="op">/</span></a>
<a class="sourceLine" id="cb101-4" data-line-number="4"><span class="st">                         </span>(<span class="kw">exp</span>(fe_exporter_bln) <span class="op">/</span><span class="st"> </span>e_r))<span class="op">^</span>(<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>sigma)),</a>
<a class="sourceLine" id="cb101-5" data-line-number="5">    <span class="dt">change_p_j_full =</span> change_p_i_full <span class="op">*</span><span class="st"> </span>(exporter <span class="op">==</span><span class="st"> </span>importer)</a>
<a class="sourceLine" id="cb101-6" data-line-number="6">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb101-7" data-line-number="7"><span class="st">  </span><span class="kw">group_by</span>(importer) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb101-8" data-line-number="8"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">change_p_j_full =</span> <span class="kw">max</span>(change_p_j_full)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb101-9" data-line-number="9"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb101-10" data-line-number="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">y_full =</span> change_p_i_full <span class="op">*</span><span class="st"> </span>y)</a></code></pre></div>
<p>Now we compute <code>e_full</code> and <code>e_full_r</code>:</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb102-1" data-line-number="1">ch2_application2 &lt;-<span class="st"> </span>ch2_application2 <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">e_full =</span> change_p_j_full <span class="op">*</span><span class="st"> </span>e <span class="op">*</span><span class="st"> </span>(exporter <span class="op">==</span><span class="st"> </span>importer)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(importer) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">e_full =</span> <span class="kw">max</span>(e_full, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-5" data-line-number="5"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb102-7" data-line-number="7">    <span class="dt">e_full_r =</span> e_full <span class="op">*</span><span class="st"> </span>(importer <span class="op">==</span><span class="st"> &quot;0-DEU&quot;</span>),</a>
<a class="sourceLine" id="cb102-8" data-line-number="8">    <span class="dt">e_full_r =</span> <span class="kw">max</span>(e_full_r)</a>
<a class="sourceLine" id="cb102-9" data-line-number="9">  )</a></code></pre></div>
<p>We also need <code>omr_full</code> and <code>imr_full</code>. This part of the code needs <em>attention</em> because the IMR full term is computed in a different way compared to the previous section, please see the script <code>RTAsEffects.do</code>. The way to replicate the original Stata code is:</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb103-1" data-line-number="1">ch2_application2 &lt;-<span class="st"> </span>ch2_application2 <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb103-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb103-3" data-line-number="3">    <span class="dt">omr_full =</span> y_full <span class="op">*</span><span class="st"> </span>e_r_cfl_<span class="dv">0</span> <span class="op">/</span><span class="st"> </span><span class="kw">exp</span>(fe_exporter_cfl_<span class="dv">0</span>),</a>
<a class="sourceLine" id="cb103-4" data-line-number="4">    <span class="dt">imr_full =</span> e_cfl_<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="kw">exp</span>(fe_importer_cfl_<span class="dv">0</span>) <span class="op">*</span><span class="st"> </span>e_r_cfl_<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb103-5" data-line-number="5">  )</a></code></pre></div>
<p>To complete this step, we compute <code>xi_full</code>:</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb104-1" data-line-number="1">ch2_application2 &lt;-<span class="st"> </span>ch2_application2 <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb104-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">x_full =</span> (y_full <span class="op">*</span><span class="st"> </span>e_full <span class="op">*</span><span class="st"> </span>tij_cfl) <span class="op">/</span><span class="st"> </span>(imr_full <span class="op">*</span><span class="st"> </span>omr_full)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb104-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(exporter) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb104-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">xi_full =</span> <span class="kw">sum</span>(x_full <span class="op">*</span><span class="st"> </span>(importer <span class="op">!=</span><span class="st"> </span>exporter))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb104-5" data-line-number="5"><span class="st">  </span><span class="kw">ungroup</span>()</a></code></pre></div>
</div>
<div id="step-iv-collect-construct-and-report-indexes-of-interest-1" class="section level3">
<h3><span class="header-section-number">3.2.5</span> Step IV: Collect, construct, and report indexes of interest</h3>
<p>The goal of this step is to reproduce the table from page 116 in <span class="citation">Yotov et al. (<a href="#ref-yotov2016advanced">2016</a>)</span>.</p>
<p>To ease the task of creating the table from the book, we divide between exporter and importer indexes:</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb105-1" data-line-number="1">exporter_indexes &lt;-<span class="st"> </span>ch2_application2 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb105-2" data-line-number="2"><span class="st">  </span><span class="kw">select</span>(</a>
<a class="sourceLine" id="cb105-3" data-line-number="3">    exporter, <span class="kw">starts_with</span>(<span class="st">&quot;omr_&quot;</span>), change_p_i_full,</a>
<a class="sourceLine" id="cb105-4" data-line-number="4">    <span class="kw">starts_with</span>(<span class="st">&quot;xi_&quot;</span>), y, y_full</a>
<a class="sourceLine" id="cb105-5" data-line-number="5">  ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb105-6" data-line-number="6"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb105-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">exporter =</span> <span class="kw">ifelse</span>(exporter <span class="op">==</span><span class="st"> &quot;0-DEU&quot;</span>, <span class="st">&quot;DEU&quot;</span>, exporter)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb105-8" data-line-number="8"><span class="st">  </span><span class="kw">arrange</span>(exporter) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb105-9" data-line-number="9"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb105-10" data-line-number="10">    <span class="dt">change_p_i_full =</span> (<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>change_p_i_full) <span class="op">*</span><span class="st"> </span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb105-11" data-line-number="11">    <span class="dt">change_omr_cfl =</span> ((omr_bln <span class="op">/</span><span class="st"> </span>omr_cfl)<span class="op">^</span>(<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span><span class="op">-</span>sigma)) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb105-12" data-line-number="12">    <span class="dt">change_omr_full =</span> ((omr_bln <span class="op">/</span><span class="st"> </span>omr_full)<span class="op">^</span>(<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span><span class="op">-</span>sigma)) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb105-13" data-line-number="13">    <span class="dt">change_xi_cfl =</span> (xi_bln <span class="op">/</span><span class="st"> </span>xi_cfl <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb105-14" data-line-number="14">    <span class="dt">change_xi_full =</span> (xi_bln <span class="op">/</span><span class="st"> </span>xi_full <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb105-15" data-line-number="15">  ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb105-16" data-line-number="16"><span class="st"> </span><span class="kw">select</span>(exporter, <span class="kw">starts_with</span>(<span class="st">&quot;change&quot;</span>), <span class="kw">starts_with</span>(<span class="st">&quot;y&quot;</span>))</a>
<a class="sourceLine" id="cb105-17" data-line-number="17">  </a>
<a class="sourceLine" id="cb105-18" data-line-number="18">importer_indexes &lt;-<span class="st"> </span>ch2_application2 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb105-19" data-line-number="19"><span class="st">  </span><span class="kw">select</span>(importer, imr_bln, imr_cfl, imr_full) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb105-20" data-line-number="20"><span class="st">  </span><span class="kw">ungroup</span>()  <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb105-21" data-line-number="21"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb105-22" data-line-number="22"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">importer =</span> <span class="kw">ifelse</span>(importer <span class="op">==</span><span class="st"> &quot;0-DEU&quot;</span>, <span class="st">&quot;DEU&quot;</span>, importer)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb105-23" data-line-number="23"><span class="st">  </span><span class="kw">arrange</span>(importer) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb105-24" data-line-number="24"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb105-25" data-line-number="25">    <span class="dt">change_imr_cfl =</span> ((imr_bln <span class="op">/</span><span class="st"> </span>imr_cfl)<span class="op">^</span>(<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>sigma)) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb105-26" data-line-number="26">    <span class="dt">change_imr_full =</span> ((imr_bln <span class="op">/</span><span class="st"> </span>imr_full)<span class="op">^</span>(<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>sigma)) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb105-27" data-line-number="27">  )</a></code></pre></div>
<p>Finally, we can replicate the table that we wanted to:</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb106-1" data-line-number="1">indexes_final &lt;-<span class="st"> </span>exporter_indexes <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb106-2" data-line-number="2"><span class="st">  </span><span class="kw">left_join</span>(importer_indexes, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;exporter&quot;</span> =<span class="st"> &quot;importer&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb106-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb106-4" data-line-number="4">    <span class="dt">rgdp_bln =</span> y <span class="op">/</span><span class="st"> </span>(imr_bln<span class="op">^</span>(<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>sigma))),</a>
<a class="sourceLine" id="cb106-5" data-line-number="5">    <span class="dt">rgdp_full =</span> y_full <span class="op">/</span><span class="st"> </span>(imr_full<span class="op">^</span>(<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>sigma))),</a>
<a class="sourceLine" id="cb106-6" data-line-number="6">    <span class="dt">change_rgdp_full =</span> (rgdp_bln <span class="op">/</span><span class="st"> </span>rgdp_full <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb106-7" data-line-number="7">  ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb106-8" data-line-number="8"><span class="st">  </span><span class="kw">select</span>(exporter, change_xi_cfl, change_xi_full, </a>
<a class="sourceLine" id="cb106-9" data-line-number="9">         change_rgdp_full, change_imr_full, change_omr_full, change_p_i_full)</a>
<a class="sourceLine" id="cb106-10" data-line-number="10"></a>
<a class="sourceLine" id="cb106-11" data-line-number="11">indexes_final <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb106-12" data-line-number="12"><span class="st">  </span><span class="kw">mutate_if</span>(is.numeric, <span class="cf">function</span>(x) <span class="kw">round</span>(x, <span class="dv">2</span>))</a></code></pre></div>
<pre><code>## # A tibble: 69 x 7
##    exporter change_xi_cfl change_xi_full change_rgdp_full change_imr_full change_omr_full change_p_i_full
##    &lt;chr&gt;            &lt;dbl&gt;          &lt;dbl&gt;            &lt;dbl&gt;           &lt;dbl&gt;           &lt;dbl&gt;           &lt;dbl&gt;
##  1 ARG              -0.66          -0.69            -0.01            0.01            0               0   
##  2 AUS              -0.49          -0.51            -0.01            0.02           -0.01            0.01
##  3 AUT              -0.07          -0.1             -0.01            0               0.01           -0.01
##  4 BEL              -0.09          -0.12             0               0               0               0   
##  5 BGR              -0.05          -0.07             0               0               0               0   
##  6 BOL              -0.47          -0.48            -0.02            0.03           -0.01            0.01
##  7 BRA              -0.65          -0.69            -0.01           -0.01            0.02           -0.02
##  8 CAN              35.0           37.5              3.4            -1.48           -2.14            1.84
##  9 CHE              -0.14          -0.17            -0.01            0               0.01           -0.01
## 10 CHL              -0.81          -0.83            -0.03            0.01            0.03           -0.03
## # … with 59 more rows</code></pre>

</div>
</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-yotov2016advanced">
<p>Yotov, Yoto V, Roberta Piermartini, José-Antonio Monteiro, and Mario Larch. 2016. <em>An Advanced Guide to Trade Policy Analysis: The Structural Gravity Model</em>. World Trade Organization Geneva.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="partial-equilibrium-trade-policy-analysis-with-structural-gravity.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="data.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
