<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.33">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>3&nbsp; General equilibrium trade policy analysis with structural gravity – Solutions Manual for An Advanced Guide to Trade Policy Analysis in R (4th Edition)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./01-traditional-gravity.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-ea385d0e468b0dd5ea5bf0780b1290d9.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-ffd282cb318059e0bcb130885a47f5dc.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link href="site_libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="site_libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="site_libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="site_libs/datatables-binding-0.34.0/datatables.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="site_libs/dt-core-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="site_libs/dt-core-1.13.6/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="site_libs/dt-core-1.13.6/js/jquery.dataTables.min.js"></script>
<link href="site_libs/crosstalk-1.2.2/css/crosstalk.min.css" rel="stylesheet">
<script src="site_libs/crosstalk-1.2.2/js/crosstalk.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./02-general-equilibrium.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">General equilibrium trade policy analysis with structural gravity</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Solutions Manual for An Advanced Guide to Trade Policy Analysis in R (4th Edition)</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-traditional-gravity.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Partial equilibrium trade policy analysis with structural gravity</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-general-equilibrium.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">General equilibrium trade policy analysis with structural gravity</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#trade-without-borders" id="toc-trade-without-borders" class="nav-link active" data-scroll-target="#trade-without-borders"><span class="header-section-number">3.1</span> Trade without borders</a>
  <ul class="collapse">
  <li><a href="#initial-data" id="toc-initial-data" class="nav-link" data-scroll-target="#initial-data"><span class="header-section-number">3.1.1</span> Initial data</a></li>
  <li><a href="#step-i-solve-the-baseline-model" id="toc-step-i-solve-the-baseline-model" class="nav-link" data-scroll-target="#step-i-solve-the-baseline-model"><span class="header-section-number">3.1.2</span> Step I: Solve the baseline model</a></li>
  <li><a href="#step-ii-define-a-counterfactual-scenario" id="toc-step-ii-define-a-counterfactual-scenario" class="nav-link" data-scroll-target="#step-ii-define-a-counterfactual-scenario"><span class="header-section-number">3.1.3</span> Step II: Define a counterfactual scenario</a></li>
  <li><a href="#step-iii-solve-the-counterfactual-model" id="toc-step-iii-solve-the-counterfactual-model" class="nav-link" data-scroll-target="#step-iii-solve-the-counterfactual-model"><span class="header-section-number">3.1.4</span> Step III: Solve the counterfactual model</a></li>
  <li><a href="#step-iv-collect-construct-and-report-indexes-of-interest" id="toc-step-iv-collect-construct-and-report-indexes-of-interest" class="nav-link" data-scroll-target="#step-iv-collect-construct-and-report-indexes-of-interest"><span class="header-section-number">3.1.5</span> Step IV: Collect, construct, and report indexes of interest</a></li>
  <li><a href="#figures-replication" id="toc-figures-replication" class="nav-link" data-scroll-target="#figures-replication"><span class="header-section-number">3.1.6</span> Figures replication</a></li>
  </ul></li>
  <li><a href="#impact-of-regional-trade-agreements" id="toc-impact-of-regional-trade-agreements" class="nav-link" data-scroll-target="#impact-of-regional-trade-agreements"><span class="header-section-number">3.2</span> Impact of regional trade agreements</a>
  <ul class="collapse">
  <li><a href="#initial-data-1" id="toc-initial-data-1" class="nav-link" data-scroll-target="#initial-data-1"><span class="header-section-number">3.2.1</span> Initial data</a></li>
  <li><a href="#step-1-solve-the-baseline-gravity-model" id="toc-step-1-solve-the-baseline-gravity-model" class="nav-link" data-scroll-target="#step-1-solve-the-baseline-gravity-model"><span class="header-section-number">3.2.2</span> Step 1: Solve the baseline gravity model</a></li>
  <li><a href="#step-ii-define-a-counterfactual-scenario-1" id="toc-step-ii-define-a-counterfactual-scenario-1" class="nav-link" data-scroll-target="#step-ii-define-a-counterfactual-scenario-1"><span class="header-section-number">3.2.3</span> Step II: Define a counterfactual scenario</a></li>
  <li><a href="#step-iii-solve-the-counterfactual-model-1" id="toc-step-iii-solve-the-counterfactual-model-1" class="nav-link" data-scroll-target="#step-iii-solve-the-counterfactual-model-1"><span class="header-section-number">3.2.4</span> Step III: Solve the counterfactual model</a></li>
  <li><a href="#step-iv-collect-construct-and-report-indexes-of-interest-1" id="toc-step-iv-collect-construct-and-report-indexes-of-interest-1" class="nav-link" data-scroll-target="#step-iv-collect-construct-and-report-indexes-of-interest-1"><span class="header-section-number">3.2.5</span> Step IV: Collect, construct, and report indexes of interest</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references"><span class="header-section-number">3.3</span> References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">General equilibrium trade policy analysis with structural gravity</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="trade-without-borders" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="trade-without-borders"><span class="header-section-number">3.1</span> Trade without borders</h2>
<section id="initial-data" class="level3" data-number="3.1.1">
<h3 data-number="3.1.1" class="anchored" data-anchor-id="initial-data"><span class="header-section-number">3.1.1</span> Initial data</h3>
<p>Unlike the previous chapter, we shall proceed by alternating both data transforming and regressions. In the previous chapter, it was possible first to process the datasets and then fit the regressions, but here we need the regressions’ output to create new variables. In any case, we will follow quite similar steps to the last chapter.</p>
<p>To do what is shown in box #1 from page 104 in <span class="citation" data-cites="yotov2016advanced">Yotov et al. (<a href="#ref-yotov2016advanced" role="doc-biblioref">2016</a>)</span>, we need to convert “DEU” in both exporter and importer columns to “0-DEU” so that the software sets it as the reference factor (i.e., “0-DEU” will be listed before any text string starting with a letter). The book uses “ZZZ,” but in R, “ZZZ” will not be treated as the reference factor, for which case we could have used “AAA.” It is important to mention that box #1 does not show a previous step to filter observations for 2006, which is mentioned on page 103.</p>
<p>Before conducting any data filtering or regression, we need to load the required packages.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># dataset</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tradepolicy)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># data transformation</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># regression</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(capybara)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># plots</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We start by defining some parameters to simplify the code. The value for the elasticity of substitution, <span class="math inline">\(\sigma = 7\)</span>, used to set the convergence criteria is taken from the literature. There is an explanation in the original Stata code.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>ref_country <span class="ot">&lt;-</span> <span class="st">"DEU"</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>ref_country0 <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"0-"</span>, ref_country)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>sigma <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>max_dif <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>sd_dif <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>change_price_i_old <span class="ot">&lt;-</span> <span class="dv">0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It is imperative to arrange the table by importers. Otherwise, there is a difference in the estimated fixed effects that changes the factory prices in the last figure from this section, and here the aim is to fully replicate the two figures from this section in the book. We mentioned this in the RTA effects section from the previous chapter.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>ch2_application1 <span class="ot">&lt;-</span> agtpa_applications <span class="sc">|&gt;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(exporter, importer, pair_id, year, trade, dist, cntg, lang, clny) <span class="sc">|&gt;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2006</span>) <span class="sc">|&gt;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_dist =</span> <span class="fu">log</span>(dist),</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">intl =</span> <span class="fu">ifelse</span>(exporter <span class="sc">!=</span> importer, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">exporter =</span> <span class="fu">ifelse</span>(exporter <span class="sc">==</span> ref_country, ref_country0, exporter),</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">importer =</span> <span class="fu">ifelse</span>(importer <span class="sc">==</span> ref_country, ref_country0, importer)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(importer) <span class="sc">|&gt;</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create Yit</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(exporter) <span class="sc">|&gt;</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y =</span> <span class="fu">sum</span>(trade, <span class="at">na.rm =</span> T)) <span class="sc">|&gt;</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create Eit</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(importer) <span class="sc">|&gt;</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">e =</span> <span class="fu">sum</span>(trade, <span class="at">na.rm =</span> T)) <span class="sc">|&gt;</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create Er</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">e_r =</span> <span class="fu">max</span>(<span class="fu">ifelse</span>(importer <span class="sc">==</span> ref_country0, e, <span class="cn">NA</span>), <span class="at">na.rm =</span> T))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-i-solve-the-baseline-model" class="level3" data-number="3.1.2">
<h3 data-number="3.1.2" class="anchored" data-anchor-id="step-i-solve-the-baseline-model"><span class="header-section-number">3.1.2</span> Step I: Solve the baseline model</h3>
<p>We start by fitting the model</p>
<p><span class="math display">\[
\begin{align}
X_{ij,t} =&amp; \:\exp\left[\pi_{i,t} + \chi_{i,t} + \beta_1 \log(DIST)_{i,j} + \beta_2 CNTG_{i,j} + \beta_3 INTL_{i,j}\right] \times \varepsilon_{ij,t}.
\end{align}
\]</span></p>
<p>With the data from above, the model specification is straightforward.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>fit_baseline_app1 <span class="ot">&lt;-</span> <span class="fu">fepoisson</span>(</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  trade <span class="sc">~</span> log_dist <span class="sc">+</span> cntg <span class="sc">+</span> intl <span class="sc">|</span> exporter <span class="sc">+</span> importer,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> ch2_application1,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">list</span>(<span class="at">iter_max =</span> <span class="dv">500</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With the estimated model, we can proceed as in box #1 from page 105 in <span class="citation" data-cites="yotov2016advanced">Yotov et al. (<a href="#ref-yotov2016advanced" role="doc-biblioref">2016</a>)</span> to construct the variables for exporter and importer fixed effects. This step is very different compared to Stata.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>fe_exporter_bln <span class="ot">&lt;-</span> fit_baseline_app1<span class="sc">$</span>fixed_effects<span class="sc">$</span>exporter <span class="sc">|&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">enframe</span>(<span class="at">name =</span> <span class="st">"exporter"</span>, <span class="at">value =</span> <span class="st">"fe_exporter_bln"</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>fe_importer_bln <span class="ot">&lt;-</span> fit_baseline_app1<span class="sc">$</span>fixed_effects<span class="sc">$</span>importer <span class="sc">|&gt;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">enframe</span>(<span class="at">name =</span> <span class="st">"importer"</span>, <span class="at">value =</span> <span class="st">"fe_importer_bln"</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>ch2_application1 <span class="ot">&lt;-</span> ch2_application1 <span class="sc">|&gt;</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(fe_exporter_bln, <span class="at">by =</span> <span class="st">"exporter"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(fe_importer_bln, <span class="at">by =</span> <span class="st">"importer"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Still following box #1, we need to compute the variables of bilateral trade costs and multilateral resistances.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>ch2_application1 <span class="ot">&lt;-</span> ch2_application1 <span class="sc">|&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">tij_bln =</span> <span class="fu">exp</span>(fit_baseline_app1<span class="sc">$</span>coef_table[<span class="st">"log_dist"</span>, <span class="dv">1</span>] <span class="sc">*</span> log_dist <span class="sc">+</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>      fit_baseline_app1<span class="sc">$</span>coef_table[<span class="st">"cntg"</span>, <span class="dv">1</span>] <span class="sc">*</span> cntg <span class="sc">+</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>      fit_baseline_app1<span class="sc">$</span>coef_table[<span class="st">"intl"</span>, <span class="dv">1</span>] <span class="sc">*</span> intl),</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># outward multilateral resistance (omr)</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">omr_bln =</span> y <span class="sc">*</span> (e_r <span class="sc">/</span> <span class="fu">exp</span>(fe_exporter_bln)),</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># inward multilateral resistance (imr)</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">imr_bln =</span> e <span class="sc">/</span> (<span class="fu">exp</span>(fe_importer_bln) <span class="sc">*</span> e_r)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To complete this estimation stage, we need to create a column with the estimated international trade for given output and expenditures. We start by adding a column with the estimated trade for the baseline model, and then we group by the exporter and summarise to obtain the required column <span class="math inline">\(\xi\)</span>-baseline.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>ch2_application1 <span class="ot">&lt;-</span> ch2_application1 <span class="sc">|&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tradehat_bln =</span> <span class="fu">predict</span>(fit_baseline_app1, ch2_application1)) <span class="sc">|&gt;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(exporter) <span class="sc">|&gt;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">xi_bln =</span> <span class="fu">sum</span>(tradehat_bln <span class="sc">*</span> (exporter <span class="sc">!=</span> importer), <span class="at">na.rm =</span> T)) <span class="sc">|&gt;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-ii-define-a-counterfactual-scenario" class="level3" data-number="3.1.3">
<h3 data-number="3.1.3" class="anchored" data-anchor-id="step-ii-define-a-counterfactual-scenario"><span class="header-section-number">3.1.3</span> Step II: Define a counterfactual scenario</h3>
<p>Box #2 from page 105 in <span class="citation" data-cites="yotov2016advanced">Yotov et al. (<a href="#ref-yotov2016advanced" role="doc-biblioref">2016</a>)</span> proposes two alternatives to define the counterfactual scenario of removing international borders. The first alternative is to eliminate the border variable and generate the logged trade costs used in the constraint.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>ch2_application1 <span class="ot">&lt;-</span> ch2_application1 <span class="sc">|&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">tij_cfl =</span> <span class="fu">exp</span>(fit_baseline_app1<span class="sc">$</span>coef_table[<span class="st">"log_dist"</span>, <span class="dv">1</span>] <span class="sc">*</span> log_dist <span class="sc">+</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>      fit_baseline_app1<span class="sc">$</span>coef_table[<span class="st">"cntg"</span>, <span class="dv">1</span>] <span class="sc">*</span> cntg)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The second alternative is to define a new counterfactual border variable. We only show this equivalent case without computation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>ch2_application1 <span class="ot">&lt;-</span> ch2_application1 <span class="sc">|&gt;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">intl_cfl =</span> <span class="dv">0</span>,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">tij_bln =</span> <span class="fu">exp</span>(fit_baseline_app1<span class="sc">$</span>coef_table[<span class="st">"log_dist"</span>, <span class="dv">1</span>] <span class="sc">*</span> log_dist <span class="sc">+</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>      fit_baseline_app1<span class="sc">$</span>coef_table[<span class="st">"cntg"</span>, <span class="dv">1</span>] <span class="sc">*</span> cntg <span class="sc">+</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>      fit_baseline_app1<span class="sc">$</span>coef_table[<span class="st">"intl"</span>, <span class="dv">1</span>] <span class="sc">*</span> intl_cfl)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-iii-solve-the-counterfactual-model" class="level3" data-number="3.1.4">
<h3 data-number="3.1.4" class="anchored" data-anchor-id="step-iii-solve-the-counterfactual-model"><span class="header-section-number">3.1.4</span> Step III: Solve the counterfactual model</h3>
<p>We need to fit a model similar to the model from step I, the constrained gravity model, where <span class="math inline">\(\pi_{j,t}\)</span> and <span class="math inline">\(\chi_{j,t}\)</span> are altered as in the equation</p>
<p><span class="math display">\[
\begin{align}
X_{ij,t} =&amp; \:\exp\left[\pi_{i,t}^{CFL} + \chi_{i,t}^{CFL} + \beta_1 \log(DIST)_{i,j} + \beta_2 CNTG_{i,j} + \beta_3 INTL_{i,j}\right] \times \varepsilon_{ij,t}.
\end{align}
\]</span></p>
<p>Box #1 from page 106 in <span class="citation" data-cites="yotov2016advanced">Yotov et al. (<a href="#ref-yotov2016advanced" role="doc-biblioref">2016</a>)</span> estimates the constrained gravity model with the PPML estimator using an offset argument, which is straightforward in R.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>fit_counterfactual_app1 <span class="ot">&lt;-</span> <span class="fu">fepoisson</span>(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  trade <span class="sc">~</span> <span class="dv">0</span> <span class="sc">|</span> exporter <span class="sc">+</span> importer,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> ch2_application1,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">offset =</span> <span class="sc">~</span> <span class="fu">log</span>(tij_cfl),</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">list</span>(<span class="at">iter_max =</span> <span class="dv">500</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As in the previous chapter, we need to extract the fixed effects.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>fe_exporter_cfl <span class="ot">&lt;-</span> fit_counterfactual_app1<span class="sc">$</span>fixed_effects<span class="sc">$</span>exporter <span class="sc">|&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">enframe</span>(<span class="at">name =</span> <span class="st">"exporter"</span>, <span class="at">value =</span> <span class="st">"fe_exporter_cfl"</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>fe_importer_cfl <span class="ot">&lt;-</span> fit_counterfactual_app1<span class="sc">$</span>fixed_effects<span class="sc">$</span>importer <span class="sc">|&gt;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">enframe</span>(<span class="at">name =</span> <span class="st">"importer"</span>, <span class="at">value =</span> <span class="st">"fe_importer_cfl"</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>ch2_application1 <span class="ot">&lt;-</span> ch2_application1 <span class="sc">|&gt;</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(fe_exporter_cfl, <span class="at">by =</span> <span class="st">"exporter"</span>) <span class="sc">|&gt;</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(fe_importer_cfl, <span class="at">by =</span> <span class="st">"importer"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we go for Box #2 from page 106 in <span class="citation" data-cites="yotov2016advanced">Yotov et al. (<a href="#ref-yotov2016advanced" role="doc-biblioref">2016</a>)</span>, where the authors obtain the bilateral trade costs and multilateral resistances variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>ch2_application1 <span class="ot">&lt;-</span> ch2_application1 <span class="sc">|&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># outward multilateral resistance (omr)</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">omr_cfl =</span> y <span class="sc">*</span> (e_r <span class="sc">/</span> <span class="fu">exp</span>(fe_exporter_cfl)),</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># inward multilateral resistance (imr)</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">imr_cfl =</span> e <span class="sc">/</span> (<span class="fu">exp</span>(fe_importer_cfl) <span class="sc">*</span> e_r)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Box #2 also shows how to compute trade’s conditional general equilibrium effects, similar to what we did in step I.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>ch2_application1 <span class="ot">&lt;-</span> ch2_application1 <span class="sc">|&gt;</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tradehat_cfl =</span> <span class="fu">predict</span>(fit_counterfactual_app1, ch2_application1)) <span class="sc">|&gt;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(exporter) <span class="sc">|&gt;</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">xi_cfl =</span> <span class="fu">sum</span>(tradehat_cfl <span class="sc">*</span> (exporter <span class="sc">!=</span> importer), <span class="at">na.rm =</span> T)) <span class="sc">|&gt;</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Box #1 from page 107 in <span class="citation" data-cites="yotov2016advanced">Yotov et al. (<a href="#ref-yotov2016advanced" role="doc-biblioref">2016</a>)</span> can be simplified with R code. To construct the iterative procedure to converge to full endowment general equilibrium effects, we start by creating the required columns and parameters so that we will deviate from the original approach.</p>
<p>We start computing the change in bilateral trade costs (changes in <span class="math inline">\(t_{ij}\)</span>) and trade deficit or surplus (<span class="math inline">\(\phi\)</span>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>ch2_application1 <span class="ot">&lt;-</span> ch2_application1 <span class="sc">|&gt;</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">change_tij =</span> tij_cfl <span class="sc">/</span> tij_bln,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">phi =</span> <span class="fu">ifelse</span>(importer <span class="sc">==</span> exporter, e <span class="sc">/</span> y, <span class="dv">0</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(exporter) <span class="sc">|&gt;</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">phi =</span> <span class="fu">max</span>(phi, <span class="at">na.rm =</span> T)) <span class="sc">|&gt;</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We compute the change in prices for exporters (changes in <span class="math inline">\(p_i\)</span>) and importers (changes in <span class="math inline">\(p_j\)</span>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>ch2_application1 <span class="ot">&lt;-</span> ch2_application1 <span class="sc">|&gt;</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(exporter) <span class="sc">|&gt;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">change_p_i =</span> ((<span class="fu">exp</span>(fe_exporter_cfl) <span class="sc">/</span> e_r) <span class="sc">/</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    (<span class="fu">exp</span>(fe_exporter_bln) <span class="sc">/</span> e_r))<span class="sc">^</span>(<span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> sigma))) <span class="sc">|&gt;</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(importer) <span class="sc">|&gt;</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">change_p_j =</span> <span class="fu">ifelse</span>(importer <span class="sc">==</span> exporter, change_p_i, <span class="dv">0</span>),</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">change_p_j =</span> <span class="fu">max</span>(change_p_j, <span class="at">na.rm =</span> T)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we need to compute the counterfactual trade flows.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>ch2_application1 <span class="ot">&lt;-</span> ch2_application1 <span class="sc">|&gt;</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">trade_cfl =</span> tradehat_cfl <span class="sc">*</span> change_p_i <span class="sc">*</span> change_p_j)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To conclude the steps from Box #1 we need a <code>while()</code> loop and iterate until convergence is reached. We need to duplicate some columns under new names for the loop operations because we will overwrite them using the iterative steps.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>ch2_application1 <span class="ot">&lt;-</span> ch2_application1 <span class="sc">|&gt;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">omr_cfl_0 =</span> omr_cfl,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">imr_cfl_0 =</span> imr_cfl,</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">change_imr_full_0 =</span> <span class="dv">1</span>,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">change_omr_full_0 =</span> <span class="dv">1</span>,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">change_p_i_0 =</span> change_p_i,</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">change_p_j_0 =</span> change_p_j,</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">fe_exporter_cfl_0 =</span> fe_exporter_cfl,</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">fe_importer_cfl_0 =</span> fe_importer_cfl,</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">tradehat_0 =</span> tradehat_cfl,</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">e_r_cfl_0 =</span> e_r</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We run the loop, which cannot be divided into smaller pieces because the step <span class="math inline">\(N\)</span> depends on the step <span class="math inline">\(N-1\)</span>. As in the previous application, the idea is for the stopping criteria in this iteration is that the model converges when prices stop changing.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>i <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> (sd_dif <span class="sc">&gt;</span> <span class="fl">1e-5</span> <span class="sc">|</span> max_dif <span class="sc">&gt;</span> <span class="fl">1e-5</span>) {</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  ch2_application1 <span class="ot">&lt;-</span> ch2_application1 <span class="sc">|&gt;</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">trade_1 =</span> tradehat_0 <span class="sc">*</span> change_p_i_0 <span class="sc">*</span> change_p_j_0 <span class="sc">/</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>      (change_omr_full_0 <span class="sc">*</span> change_imr_full_0))</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># repeat the counterfactual model</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  fit_counterfactual_app1_2 <span class="ot">&lt;-</span> <span class="fu">fepoisson</span>(</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    trade_1 <span class="sc">~</span> <span class="dv">0</span> <span class="sc">|</span> exporter <span class="sc">+</span> importer,</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> ch2_application1,</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">offset =</span> <span class="sc">~</span> <span class="fu">log</span>(tij_cfl),</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">list</span>(<span class="at">iter_max =</span> <span class="dv">500</span>)</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>  fe_exporter_cfl_1 <span class="ot">&lt;-</span> fit_counterfactual_app1_2<span class="sc">$</span>fixed_effects<span class="sc">$</span>exporter <span class="sc">|&gt;</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    tibble<span class="sc">::</span><span class="fu">enframe</span>(<span class="at">name =</span> <span class="st">"exporter"</span>, <span class="at">value =</span> <span class="st">"fe_exporter_cfl_1"</span>)</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>  fe_importer_cfl_1 <span class="ot">&lt;-</span> fit_counterfactual_app1_2<span class="sc">$</span>fixed_effects<span class="sc">$</span>importer <span class="sc">|&gt;</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    tibble<span class="sc">::</span><span class="fu">enframe</span>(<span class="at">name =</span> <span class="st">"importer"</span>, <span class="at">value =</span> <span class="st">"fe_importer_cfl_1"</span>)</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>  ch2_application1<span class="sc">$</span>fe_exporter_cfl_1 <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>  ch2_application1<span class="sc">$</span>fe_importer_cfl_1 <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>  ch2_application1 <span class="ot">&lt;-</span> ch2_application1 <span class="sc">|&gt;</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(fe_exporter_cfl_1, <span class="at">by =</span> <span class="st">"exporter"</span>) <span class="sc">|&gt;</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(fe_importer_cfl_1, <span class="at">by =</span> <span class="st">"importer"</span>)</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># compute the conditional general equilibrium effects of trade</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>  ch2_application1 <span class="ot">&lt;-</span> ch2_application1 <span class="sc">|&gt;</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">tradehat_1 =</span> <span class="fu">predict</span>(fit_counterfactual_app1_2, ch2_application1)) <span class="sc">|&gt;</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(exporter) <span class="sc">|&gt;</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">y_cfl_1 =</span> <span class="fu">sum</span>(tradehat_1, <span class="at">na.rm =</span> T)) <span class="sc">|&gt;</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">e_cfl_1 =</span> <span class="fu">ifelse</span>(importer <span class="sc">==</span> exporter, phi <span class="sc">*</span> y_cfl_1, <span class="dv">0</span>)) <span class="sc">|&gt;</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(importer) <span class="sc">|&gt;</span></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">e_cfl_1 =</span> <span class="fu">max</span>(e_cfl_1, <span class="at">na.rm =</span> T)) <span class="sc">|&gt;</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">e_r_cfl_1 =</span> <span class="fu">ifelse</span>(importer <span class="sc">==</span> <span class="fu">paste0</span>(<span class="st">"0-"</span>, ref_country), e_cfl_1, <span class="dv">0</span>),</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">e_r_cfl_1 =</span> <span class="fu">max</span>(e_r_cfl_1, <span class="at">na.rm =</span> T)</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># compute the change in prices for exporters and importers</span></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>  ch2_application1 <span class="ot">&lt;-</span> ch2_application1 <span class="sc">|&gt;</span></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">change_p_i_1 =</span> ((<span class="fu">exp</span>(fe_exporter_cfl_1) <span class="sc">/</span> e_r_cfl_1) <span class="sc">/</span></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>      (<span class="fu">exp</span>(fe_exporter_cfl_0) <span class="sc">/</span> e_r_cfl_0))<span class="sc">^</span>(<span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> sigma)))</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># compute the change in prices for exporters and importers</span></span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>  ch2_application1 <span class="ot">&lt;-</span> ch2_application1 <span class="sc">|&gt;</span></span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(importer) <span class="sc">|&gt;</span></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>      <span class="at">change_p_j_1 =</span> <span class="fu">ifelse</span>(importer <span class="sc">==</span> exporter, change_p_i_1, <span class="dv">0</span>),</span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>      <span class="at">change_p_j_1 =</span> <span class="fu">max</span>(change_p_j_1, <span class="at">na.rm =</span> T)</span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># compute both outward and inward multilateral resistance</span></span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>  ch2_application1 <span class="ot">&lt;-</span> ch2_application1 <span class="sc">|&gt;</span></span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a>      <span class="at">omr_cfl_1 =</span> (y_cfl_1 <span class="sc">*</span> e_r_cfl_1) <span class="sc">/</span> <span class="fu">exp</span>(fe_exporter_cfl_1),</span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>      <span class="at">imr_cfl_1 =</span> e_cfl_1 <span class="sc">/</span> (<span class="fu">exp</span>(fe_importer_cfl_1) <span class="sc">*</span> e_r_cfl_1)</span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a>  <span class="co"># update the differences</span></span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a>  max_dif <span class="ot">&lt;-</span> <span class="fu">abs</span>(<span class="fu">max</span>(ch2_application1<span class="sc">$</span>change_p_i_0 <span class="sc">-</span> change_price_i_old))</span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a>  sd_dif <span class="ot">&lt;-</span> <span class="fu">sd</span>(ch2_application1<span class="sc">$</span>change_p_i_0 <span class="sc">-</span> change_price_i_old)</span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a>  change_price_i_old <span class="ot">&lt;-</span> ch2_application1<span class="sc">$</span>change_p_i_0</span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a>  <span class="co"># compute changes in outward and inward multilateral resistance</span></span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a>  ch2_application1 <span class="ot">&lt;-</span> ch2_application1 <span class="sc">|&gt;</span></span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a>      <span class="at">change_omr_full_1 =</span> omr_cfl_1 <span class="sc">/</span> omr_cfl_0,</span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a>      <span class="at">change_imr_full_1 =</span> imr_cfl_1 <span class="sc">/</span> imr_cfl_0,</span>
<span id="cb18-74"><a href="#cb18-74" aria-hidden="true" tabindex="-1"></a>      <span class="at">omr_cfl_0 =</span> omr_cfl_1,</span>
<span id="cb18-75"><a href="#cb18-75" aria-hidden="true" tabindex="-1"></a>      <span class="at">imr_cfl_0 =</span> imr_cfl_1,</span>
<span id="cb18-76"><a href="#cb18-76" aria-hidden="true" tabindex="-1"></a>      <span class="at">change_omr_full_0 =</span> change_omr_full_1,</span>
<span id="cb18-77"><a href="#cb18-77" aria-hidden="true" tabindex="-1"></a>      <span class="at">change_imr_full_0 =</span> change_imr_full_1,</span>
<span id="cb18-78"><a href="#cb18-78" aria-hidden="true" tabindex="-1"></a>      <span class="at">change_p_i_0 =</span> change_p_i_1,</span>
<span id="cb18-79"><a href="#cb18-79" aria-hidden="true" tabindex="-1"></a>      <span class="at">change_p_j_0 =</span> change_p_j_1,</span>
<span id="cb18-80"><a href="#cb18-80" aria-hidden="true" tabindex="-1"></a>      <span class="at">fe_exporter_cfl_0 =</span> fe_exporter_cfl_1,</span>
<span id="cb18-81"><a href="#cb18-81" aria-hidden="true" tabindex="-1"></a>      <span class="at">fe_importer_cfl_0 =</span> fe_importer_cfl_1,</span>
<span id="cb18-82"><a href="#cb18-82" aria-hidden="true" tabindex="-1"></a>      <span class="at">tradehat_0 =</span> tradehat_1,</span>
<span id="cb18-83"><a href="#cb18-83" aria-hidden="true" tabindex="-1"></a>      <span class="at">e_r_cfl_0 =</span> e_r_cfl_1</span>
<span id="cb18-84"><a href="#cb18-84" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb18-85"><a href="#cb18-85" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(fe_exporter_cfl_1, fe_importer_cfl_1))</span>
<span id="cb18-86"><a href="#cb18-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-87"><a href="#cb18-87" aria-hidden="true" tabindex="-1"></a>  i <span class="ot">&lt;-</span> i <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb18-88"><a href="#cb18-88" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Box #1 from page 108 in <span class="citation" data-cites="yotov2016advanced">Yotov et al. (<a href="#ref-yotov2016advanced" role="doc-biblioref">2016</a>)</span> shows the steps to obtain different endowments, which can be divided into smaller pieces. We start computing the full endowment general equilibrium of factory-gate price (changes in <span class="math inline">\(p_i^{full}\)</span> and <span class="math inline">\(p_j^{full}\)</span>) and the full endowment general equilibrium of output (<span class="math inline">\(y^{full}\)</span>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>ch2_application1 <span class="ot">&lt;-</span> ch2_application1 <span class="sc">|&gt;</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">change_p_i_full =</span> ((<span class="fu">exp</span>(fe_exporter_cfl_0) <span class="sc">/</span> e_r_cfl_0) <span class="sc">/</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>      (<span class="fu">exp</span>(fe_exporter_bln) <span class="sc">/</span> e_r))<span class="sc">^</span>(<span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> sigma)),</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">change_p_j_full =</span> change_p_i_full <span class="sc">*</span> (exporter <span class="sc">==</span> importer)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(importer) <span class="sc">|&gt;</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">change_p_j_full =</span> <span class="fu">max</span>(change_p_j_full, <span class="at">na.rm =</span> T)) <span class="sc">|&gt;</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y_full =</span> change_p_i_full <span class="sc">*</span> y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We compute the full endowment general equilibrium of aggregate expenditures (<span class="math inline">\(e^{full}\)</span> and <span class="math inline">\(e_r^{full}\)</span>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>ch2_application1 <span class="ot">&lt;-</span> ch2_application1 <span class="sc">|&gt;</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">e_full =</span> change_p_j_full <span class="sc">*</span> e <span class="sc">*</span> (exporter <span class="sc">==</span> importer)) <span class="sc">|&gt;</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(importer) <span class="sc">|&gt;</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">e_full =</span> <span class="fu">max</span>(e_full, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">e_full_r =</span> e_full <span class="sc">*</span> (importer <span class="sc">==</span> ref_country0),</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">e_full_r =</span> <span class="fu">max</span>(e_full_r, <span class="at">na.rm =</span> T)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With the aggregate expenditure, we proceed to obtain the full endowment general equilibrium of the outward multilateral resistance (<span class="math inline">\(OMR^{full}\)</span>) and inward multilateral resistance (<span class="math inline">\(IMR^{full}\)</span>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>ch2_application1 <span class="ot">&lt;-</span> ch2_application1 <span class="sc">|&gt;</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">omr_full =</span> y_full <span class="sc">*</span> e_r_cfl_0 <span class="sc">/</span> <span class="fu">exp</span>(fe_exporter_cfl_0),</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">imr_full =</span> e_full <span class="sc">/</span> (<span class="fu">exp</span>(fe_importer_cfl_0) <span class="sc">*</span> e_full_r)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we proceed to compute the full endowment general equilibrium of trade (<span class="math inline">\(\xi^{full}\)</span>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>ch2_application1 <span class="ot">&lt;-</span> ch2_application1 <span class="sc">|&gt;</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">x_full =</span> (y_full <span class="sc">*</span> e_full <span class="sc">*</span> tij_cfl) <span class="sc">/</span> (imr_full <span class="sc">*</span> omr_full)) <span class="sc">|&gt;</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(exporter) <span class="sc">|&gt;</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">xi_full =</span> <span class="fu">sum</span>(x_full <span class="sc">*</span> (importer <span class="sc">!=</span> exporter), <span class="at">na.rm =</span> T)) <span class="sc">|&gt;</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-iv-collect-construct-and-report-indexes-of-interest" class="level3" data-number="3.1.5">
<h3 data-number="3.1.5" class="anchored" data-anchor-id="step-iv-collect-construct-and-report-indexes-of-interest"><span class="header-section-number">3.1.5</span> Step IV: Collect, construct, and report indexes of interest</h3>
<p>Box #1 from page 108 in <span class="citation" data-cites="yotov2016advanced">Yotov et al. (<a href="#ref-yotov2016advanced" role="doc-biblioref">2016</a>)</span> consists of constructing the percentage change of the general equilibrium indexes. The steps are direct, we need to compute the change in full endowment general equilibrium factory-gate price on the export side (changes in <span class="math inline">\(p_i^{full}\)</span>), the change in conditional and full general equilibrium outward multilateral resistances (changes in <span class="math inline">\(OMR^{CFL}\)</span> and <span class="math inline">\(OMR^{full}\)</span>), and the change in conditional and full general equilibrium international trade (changes in <span class="math inline">\(\xi^{CFL}\)</span> and <span class="math inline">\(\xi^{full}\)</span>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>ch2_application1 <span class="ot">&lt;-</span> ch2_application1 <span class="sc">|&gt;</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">change_price_full =</span> (change_p_i_full <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">change_omr_cfl =</span> (omr_cfl<span class="sc">^</span>(<span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> sigma)) <span class="sc">/</span> omr_bln<span class="sc">^</span>(<span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> sigma)) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">change_omr_full =</span> (omr_full<span class="sc">^</span>(<span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> sigma)) <span class="sc">/</span> omr_bln<span class="sc">^</span>(<span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> sigma)) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">change_xi_cfl =</span> (xi_cfl <span class="sc">/</span> xi_bln <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">change_xi_full =</span> (xi_full <span class="sc">/</span> xi_bln <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We also need to do something very similar for the importers in order to be able to recreate figure 7 later.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>ch2_application1 <span class="ot">&lt;-</span> ch2_application1 <span class="sc">|&gt;</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">change_imr_full =</span> <span class="sc">-</span>(imr_full<span class="sc">^</span>(<span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> sigma)) <span class="sc">/</span> imr_bln<span class="sc">^</span>(<span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> sigma)) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">rgdp =</span> ((y_full <span class="sc">/</span> imr_full<span class="sc">^</span>(<span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> sigma))) <span class="sc">/</span> (y <span class="sc">/</span> imr_bln<span class="sc">^</span>(<span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> sigma))) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="figures-replication" class="level3" data-number="3.1.6">
<h3 data-number="3.1.6" class="anchored" data-anchor-id="figures-replication"><span class="header-section-number">3.1.6</span> Figures replication</h3>
<p>With all of the steps above, we are ready to create the plots from page 110. in <span class="citation" data-cites="yotov2016advanced">Yotov et al. (<a href="#ref-yotov2016advanced" role="doc-biblioref">2016</a>)</span>. Figure 6 removes the observations where both the importer and the exporter are different, and this can be seen in the original Stata code provided with the book.</p>
<p>We need to filter rows and to obtain <span class="math inline">\(\log(y)\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>ch2_application1 <span class="ot">&lt;-</span> ch2_application1 <span class="sc">|&gt;</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(exporter <span class="sc">==</span> importer) <span class="sc">|&gt;</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    exporter, importer, y, change_xi_cfl, change_xi_full, rgdp,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    change_price_full, change_imr_full</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">log_y =</span> <span class="fu">log</span>(y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In addition, the original code removes Hong Kong for visualization scale purposes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>data_figure_6 <span class="ot">&lt;-</span> ch2_application1 <span class="sc">|&gt;</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(exporter <span class="sc">!=</span> <span class="st">"HKG"</span>) <span class="sc">|&gt;</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">x =</span> log_y, change_xi_cfl, change_xi_full) <span class="sc">|&gt;</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">names_to =</span> <span class="st">"change"</span>, <span class="at">values_to =</span> <span class="st">"y"</span>, <span class="sc">-</span>x) <span class="sc">|&gt;</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">change =</span> <span class="fu">case_when</span>(</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>      change <span class="sc">==</span> <span class="st">"change_xi_cfl"</span> <span class="sc">~</span> <span class="st">"Conditional general equilibrium"</span>,</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Full endowment general equilibrium"</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>DT<span class="sc">::</span><span class="fu">datatable</span>(</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  ch2_application1 <span class="sc">|&gt;</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(exporter <span class="sc">!=</span> <span class="st">"HKG"</span>) <span class="sc">|&gt;</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(exporter, log_y, change_xi_cfl, change_xi_full)</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-decf9d87dec39e3c1eee" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-decf9d87dec39e3c1eee">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68"],["0-DEU","ARG","AUS","AUT","BEL","BGR","BOL","BRA","CAN","CHE","CHL","CHN","CMR","COL","CRI","CYP","DNK","ECU","EGY","ESP","FIN","FRA","GBR","GRC","HUN","IDN","IND","IRL","IRN","ISL","ISR","ITA","JOR","JPN","KEN","KOR","KWT","LKA","MAC","MAR","MEX","MLT","MMR","MUS","MWI","MYS","NER","NGA","NLD","NOR","NPL","PAN","PHL","POL","PRT","QAT","ROM","SEN","SGP","SWE","THA","TTO","TUN","TUR","TZA","URY","USA","ZAF"],[14.51255025933853,10.99476332329066,12.63066370015108,12.04605981951315,13.54406951697332,10.11392696312086,8.328442270026345,13.22246502426961,13.09191085778309,12.84938975209422,11.56762642486734,15.12702537161587,8.142149128757358,10.85905148856411,9.742713845635695,9.395181704999173,11.63205421786272,9.503197822730067,10.39602299168585,13.32185360433921,11.86891204212935,13.89414647237568,13.73823868829244,11.40953215673082,11.56310459308899,12.33909221060346,13.21497345625378,12.05742105979283,11.26404437484492,9.123344766668035,11.64068703724784,13.93496694517064,10.19636122947261,14.79566676919525,8.985910060025754,13.86947764174263,9.957216489764729,10.50724522443006,8.298637631810479,10.36228624755637,12.84351378761215,8.638632764898947,10.36623234449581,8.162755543154901,7.314413082860949,12.62943675524799,5.87692199833775,11.50663991384777,13.03625193954884,11.52093503221388,8.344199885749697,8.61135089909534,11.50632188272803,12.33857595808454,11.42591989865071,9.617680909556487,11.10191573926805,8.008967352186341,12.70629175001187,12.41894467191328,12.43984877106244,9.678842081652475,10.00025121685518,12.53486295584056,7.574686482334182,9.125859371502532,15.42893323354374,12.15729898185088],[133.388722378753,65.52422347823803,229.5592287014495,59.21193392169089,156.9112444865022,24.21949310089089,13.53877787975715,172.5608129819121,80.82462218363504,92.99682531052773,105.173618777733,175.4955670857313,7.642831434320119,83.65363590161547,84.90941033902904,59.06468586258982,65.93324656392008,65.89396318539866,61.86244197053523,149.7786848492594,77.92298518752001,118.7129694776871,214.111058040602,112.2068973781648,66.5230965109117,108.1167844281605,145.9798761798207,64.46514353896069,70.78749529306896,38.93250182417536,141.1148883740217,143.8764205611836,76.26535854712139,220.7947157825578,35.23423203046379,210.1790078125917,180.0894430099179,88.35515566590921,104.9588228139301,42.99750427775236,114.5538446873004,78.08919386435372,28.54912449306506,94.50401846773413,8.23107302645807,101.6251022074907,0.8675407701613347,109.7259320576228,120.0913423325301,59.36231627239672,6.9452300075451,74.93967509947055,80.43665885134052,83.15828452721452,72.99745727988886,169.6904037832924,52.90943408420365,24.2972942043729,230.0552826832303,76.56170728178842,139.5064154774308,93.8957196291627,31.71276139885715,113.063039953225,8.304922220961931,33.44034159378082,359.9822940248227,164.1128479322317],[190.7955321580687,118.1196389815866,300.2236182372143,111.2234974533151,218.83428987426,69.10148177440954,58.17657600405695,233.6008172664824,138.0842186488909,148.9324510092187,161.4873668756107,238.2471126834258,50.54671579242105,138.110476627673,138.9940566991052,110.0806876568311,119.3384417860523,118.0746332739106,113.6107390199007,209.4984645129293,131.4239595998478,177.2901773136845,279.7979960411885,168.6201646945292,117.8611581520297,169.1476124688376,212.4446096248983,116.4320550250545,124.5402578830023,88.08760326731151,199.4573437794229,202.6437314437403,129.9097413567621,293.4316699469062,83.90044801096512,287.5306949155801,243.4583262413056,146.04971709681,157.313183108072,91.87732423227008,174.7345383150857,131.4288807709416,80.29825669126913,151.8307001969996,52.08621208975315,162.9036595227966,42.25892244806582,167.082396763609,179.9548206121115,110.8055905534827,53.43152931943649,128.0069634541151,139.3158028354152,138.47544300258,125.4000231022343,232.8819045908769,102.8085642509636,70.72935703117005,303.7104788125687,129.5473484539944,203.1058660883007,149.5293654013504,78.93811030846798,169.6513722267887,51.99264382645694,81.04099544634167,440.9557409177688,226.9022521037473]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>exporter<\/th>\n      <th>log_y<\/th>\n      <th>change_xi_cfl<\/th>\n      <th>change_xi_full<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,4]},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"exporter","targets":1},{"name":"log_y","targets":2},{"name":"change_xi_cfl","targets":3},{"name":"change_xi_full","targets":4}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> data_figure_6) <span class="sc">+</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">color =</span> change)) <span class="sc">+</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Log value of output"</span>,</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Percent change of exports"</span>,</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Figure 6: Effects of abolishing international borders on exports"</span>,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Source: Authors' calculations"</span>,</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">""</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#b6b8dd"</span>, <span class="st">"#232958"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02-general-equilibrium_files/figure-html/ch2_app1_figures_2-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>To create Figure 7, we proceed in the same way as Figure 6.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>data_figure_7 <span class="ot">&lt;-</span> ch2_application1 <span class="sc">|&gt;</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(exporter <span class="sc">!=</span> <span class="st">"HKG"</span>) <span class="sc">|&gt;</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">x =</span> log_y, change_imr_full, change_price_full, rgdp) <span class="sc">|&gt;</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">names_to =</span> <span class="st">"change"</span>, <span class="at">values_to =</span> <span class="st">"y"</span>, <span class="sc">-</span>x) <span class="sc">|&gt;</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">change =</span> <span class="fu">case_when</span>(</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>      change <span class="sc">==</span> <span class="st">"change_imr_full"</span> <span class="sc">~</span> <span class="st">"-(inward multilateral resistances)"</span>,</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>      change <span class="sc">==</span> <span class="st">"change_price_full"</span> <span class="sc">~</span> <span class="st">"Factory-gate price"</span>,</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Real GDP"</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>DT<span class="sc">::</span><span class="fu">datatable</span>(</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>  ch2_application1 <span class="sc">|&gt;</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(exporter <span class="sc">!=</span> <span class="st">"HKG"</span>) <span class="sc">|&gt;</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(exporter, log_y, change_imr_full, change_price_full, rgdp)</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-7b0542b57f1b261b0fde" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-7b0542b57f1b261b0fde">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68"],["0-DEU","ARG","AUS","AUT","BEL","BGR","BOL","BRA","CAN","CHE","CHL","CHN","CMR","COL","CRI","CYP","DNK","ECU","EGY","ESP","FIN","FRA","GBR","GRC","HUN","IDN","IND","IRL","IRN","ISL","ISR","ITA","JOR","JPN","KEN","KOR","KWT","LKA","MAC","MAR","MEX","MLT","MMR","MUS","MWI","MYS","NER","NGA","NLD","NOR","NPL","PAN","PHL","POL","PRT","QAT","ROM","SEN","SGP","SWE","THA","TTO","TUN","TUR","TZA","URY","USA","ZAF"],[14.51255025933853,10.99476332329066,12.63066370015108,12.04605981951315,13.54406951697332,10.11392696312086,8.328442270026345,13.22246502426961,13.09191085778309,12.84938975209422,11.56762642486734,15.12702537161587,8.142149128757358,10.85905148856411,9.742713845635695,9.395181704999173,11.63205421786272,9.503197822730067,10.39602299168585,13.32185360433921,11.86891204212935,13.89414647237568,13.73823868829244,11.40953215673082,11.56310459308899,12.33909221060346,13.21497345625378,12.05742105979283,11.26404437484492,9.123344766668035,11.64068703724784,13.93496694517064,10.19636122947261,14.79566676919525,8.985910060025754,13.86947764174263,9.957216489764729,10.50724522443006,8.298637631810479,10.36228624755637,12.84351378761215,8.638632764898947,10.36623234449581,8.162755543154901,7.314413082860949,12.62943675524799,5.87692199833775,11.50663991384777,13.03625193954884,11.52093503221388,8.344199885749697,8.61135089909534,11.50632188272803,12.33857595808454,11.42591989865071,9.617680909556487,11.10191573926805,8.008967352186341,12.70629175001187,12.41894467191328,12.43984877106244,9.678842081652475,10.00025121685518,12.53486295584056,7.574686482334182,9.125859371502532,15.42893323354374,12.15729898185088],[-0,11.29871718072581,5.639705763045644,10.81643810443929,2.947816872148001,14.51280984673479,17.29613710653453,2.09641594978921,14.20730368580315,7.51522421555072,6.726509091495458,-7.769146186675391,16.90951319020281,12.74455312260652,11.44541403932193,13.39841649062059,10.69448944171394,14.80407395911966,12.42985425588471,6.407175322528724,7.999405056674691,6.5327851766524,3.25206134945536,10.32492959265742,9.724029646159815,6.158178562181361,4.840956106008687,6.266233249214714,11.99659559513657,14.81740515190281,3.022948662541591,2.777213870054607,10.95428148234569,-9.21921180795926,15.15370720956514,-5.330775646529773,7.336298487351211,9.268745207519435,11.35612781074627,13.89536549574563,11.54085669263207,11.97536677984041,14.33875883182325,11.3372883353392,16.90595633088701,4.864231007109387,17.61745497051012,9.270772471887057,5.930337322895118,11.99136010415862,16.76368546467648,17.3035006093255,7.777995330685838,9.51991290560178,11.50068558143887,10.65377900474155,12.47603926992839,16.62602592187382,-10.97257226741544,7.544731017903894,1.247951978979056,8.205215851514536,14.27968571724499,7.804232218341378,17.11213765500766,14.42659977078664,-0.335024077964996,4.686721574025221],[24.3613280359277,32.15179189017672,21.3567955994197,32.96091495509867,23.98171123381618,36.27016874534845,39.41489189827207,22.59134562237908,32.36253871023522,29.2926997133733,27.9672924888305,23.23883844232364,39.91361612989992,30.10273911461967,29.77106677982622,32.31477502669624,32.50669016523,31.8109567088785,32.24785377388535,23.86402899411899,30.40451049437394,27.07877992345104,20.1127300305878,26.72635885246961,31.08337016538776,29.78408965329928,27.43833007799697,32.12547602769513,31.7805268869451,35.62719269285041,24.07326691036005,23.90099768688936,30.73182352769881,22.73827057538416,36.19179717383323,25.63293745417734,22.45597128354177,31.02014337083303,26.18869643371626,34.42865913133115,29.00086242062478,30.21584593644901,40.45455855207683,29.80515512517297,40.58188451220992,30.95850960129645,41.12555612885362,27.68598164588865,27.5454409130983,32.55301873478346,43.52165478137098,30.64861294920924,33.18398636594632,30.52841302776081,30.6106795316615,23.40122045906696,32.87014909197177,37.51401224927579,20.58729657809653,30.33828720486704,26.9138563753349,29.31726028696842,36.04750018584492,26.74321092356035,40.39801390764994,35.88781210364842,10.97237729216705,23.94159772030246],[24.3613280359277,48.98520933392976,28.61002244723046,49.08679596224679,27.74747279047654,59.4041967001574,68.57119730653767,25.21640225091959,54.28182630545449,39.79890053981514,37.19577903903952,14.35447231701361,68.38704586022803,49.10557881553552,46.54358706781143,52.78563008304098,48.37459562895427,54.71509358983955,51.01933729826229,32.34350968780439,41.74311652517726,35.96080739500911,24.15016971517836,41.31726719234698,45.20294786264982,38.30090642400486,33.92140658744458,40.95824867359039,49.74480564488524,59.21937214369801,27.94085322166879,27.44028701387613,46.81427215591476,12.37791277160611,60.51590787851935,19.27467227221207,32.15096017595012,44.40464167557337,42.35467530604345,56.1224432404845,45.83101033704005,47.93114287765836,63.96512195792916,46.40332185656661,69.18406940456288,37.65433441872197,71.30516674173629,40.73301969459011,35.58615741070461,50.6136430373888,72.42672934595606,57.98566313188125,44.41671143835133,44.26203291734237,47.58383202149223,38.115769289913,51.81002777256636,64.93637705264872,8.664054652632602,40.97442865058014,28.51769549966117,40.8764795152057,58.7109208875295,37.47183192152404,69.38307966405419,58.79678935237462,10.60183451586789,30.0360241165788]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>exporter<\/th>\n      <th>log_y<\/th>\n      <th>change_imr_full<\/th>\n      <th>change_price_full<\/th>\n      <th>rgdp<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,4,5]},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"exporter","targets":1},{"name":"log_y","targets":2},{"name":"change_imr_full","targets":3},{"name":"change_price_full","targets":4},{"name":"rgdp","targets":5}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> data_figure_7) <span class="sc">+</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">color =</span> change)) <span class="sc">+</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Log value of output"</span>,</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Percent changes"</span>,</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Figure 7: Effects of abolishing international borders on real GDP"</span>,</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Note: The inward multilateral resistances have been reformulated by multiplying their value by minus one.</span><span class="sc">\n</span><span class="st">Source: Authors' calculations"</span>,</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">""</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#3bade3"</span>, <span class="st">"#b6b8dd"</span>, <span class="st">"#232958"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02-general-equilibrium_files/figure-html/ch2_app1_figures_3-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="impact-of-regional-trade-agreements" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="impact-of-regional-trade-agreements"><span class="header-section-number">3.2</span> Impact of regional trade agreements</h2>
<section id="initial-data-1" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="initial-data-1"><span class="header-section-number">3.2.1</span> Initial data</h3>
<p>As in the previous application, we shall proceed by alternating both data transforming and regressions. To replicate the results from box #1 on page 112 in <span class="citation" data-cites="yotov2016advanced">Yotov et al. (<a href="#ref-yotov2016advanced" role="doc-biblioref">2016</a>)</span>, we need to convert “DEU” in both exporter and importer columns to “0-DEU”, as in the previous section.</p>
<p>We start by defining some parameters to simplify the code. As the notes in the original Stata code say, the criteria of convergence (<span class="math inline">\(\sigma = 7\)</span>) was taken from the literature.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>ref_country <span class="ot">&lt;-</span> <span class="st">"DEU"</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>ref_country0 <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"0-"</span>, ref_country)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>countries_rta <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"MEX"</span>, <span class="st">"USA"</span>, <span class="st">"CAN"</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>year_rta <span class="ot">&lt;-</span> <span class="dv">1994</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>sigma <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>max_dif <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>sd_dif <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>change_price_i_old <span class="ot">&lt;-</span> <span class="dv">0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In this case, we shall keep the panel dimension of the dataset to identify the effects of RTAs and comprehensively capture the impact of all time-invariant trade costs with the use of pair fixed effects.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>ch2_application2 <span class="ot">&lt;-</span> agtpa_applications <span class="sc">|&gt;</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(exporter, importer, pair_id, year, trade, dist, cntg, lang, clny, rta) <span class="sc">|&gt;</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">%in%</span> <span class="fu">seq</span>(<span class="dv">1986</span>, <span class="dv">2006</span>, <span class="dv">4</span>)) <span class="sc">|&gt;</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_dist =</span> <span class="fu">log</span>(dist),</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">intl =</span> <span class="fu">ifelse</span>(exporter <span class="sc">!=</span> importer, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">exporter =</span> <span class="fu">ifelse</span>(exporter <span class="sc">==</span> ref_country, ref_country0, exporter),</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">importer =</span> <span class="fu">ifelse</span>(importer <span class="sc">==</span> ref_country, ref_country0, importer)</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create Yit</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(exporter, year) <span class="sc">|&gt;</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y =</span> <span class="fu">sum</span>(trade, <span class="at">na.rm =</span> T)) <span class="sc">|&gt;</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create Eit</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(importer, year) <span class="sc">|&gt;</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">e =</span> <span class="fu">sum</span>(trade, <span class="at">na.rm =</span> T)) <span class="sc">|&gt;</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create Er</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year) <span class="sc">|&gt;</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">e_r =</span> <span class="fu">max</span>(<span class="fu">ifelse</span>(importer <span class="sc">==</span> ref_country0, e, <span class="cn">NA</span>), <span class="at">na.rm =</span> T)) <span class="sc">|&gt;</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(importer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Because of the panel dimension, we proceed as we did in the previous chapter by creating columns to combine exporter/importer and year alongside a pairing variable for the internal dyads for the fixed effects.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>ch2_application2 <span class="ot">&lt;-</span> ch2_application2 <span class="sc">|&gt;</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">exp_year =</span> <span class="fu">paste0</span>(exporter, year),</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">imp_year =</span> <span class="fu">paste0</span>(importer, year),</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">pair_id_2 =</span> <span class="fu">ifelse</span>(exporter <span class="sc">==</span> importer, <span class="st">"0-domestic"</span>, pair_id)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In addition, we need to compute the trade sum to filter the cases where the sum by dyad is zero.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>ch2_application2 <span class="ot">&lt;-</span> ch2_application2 <span class="sc">|&gt;</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(pair_id) <span class="sc">|&gt;</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sum_trade =</span> <span class="fu">sum</span>(trade, <span class="at">na.rm =</span> T)) <span class="sc">|&gt;</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-1-solve-the-baseline-gravity-model" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="step-1-solve-the-baseline-gravity-model"><span class="header-section-number">3.2.2</span> Step 1: Solve the baseline gravity model</h3>
<section id="stage-1-obtain-the-estimates-of-pair-fixed-effects-and-the-effects-of-rtas" class="level4" data-number="3.2.2.1">
<h4 data-number="3.2.2.1" class="anchored" data-anchor-id="stage-1-obtain-the-estimates-of-pair-fixed-effects-and-the-effects-of-rtas"><span class="header-section-number">3.2.2.1</span> Stage 1: Obtain the estimates of pair fixed effects and the effects of RTAs</h4>
<p>With the steps done before, it is straightforward to obtain the PPML regression shown in box #1 from page 112 in <span class="citation" data-cites="yotov2016advanced">Yotov et al. (<a href="#ref-yotov2016advanced" role="doc-biblioref">2016</a>)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>fit_baseline_app2 <span class="ot">&lt;-</span> <span class="fu">fepoisson</span>(</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  trade <span class="sc">~</span> rta <span class="sc">|</span> exp_year <span class="sc">+</span> imp_year <span class="sc">+</span> pair_id_2,</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">filter</span>(ch2_application2, sum_trade <span class="sc">&gt;</span> <span class="dv">0</span>),</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">list</span>(<span class="at">iter_max =</span> <span class="dv">500</span>)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can construct the variables for exporter-time, importer-time, and internal dyads with the estimated fixed effects from the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>fe_exporter_bln <span class="ot">&lt;-</span> fit_baseline_app2<span class="sc">$</span>fixed_effects<span class="sc">$</span>exp_year <span class="sc">|&gt;</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">enframe</span>(<span class="at">name =</span> <span class="st">"exp_year"</span>, <span class="at">value =</span> <span class="st">"fe_exporter_bln"</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>fe_importer_bln <span class="ot">&lt;-</span> fit_baseline_app2<span class="sc">$</span>fixed_effects<span class="sc">$</span>imp_year <span class="sc">|&gt;</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">enframe</span>(<span class="at">name =</span> <span class="st">"imp_year"</span>, <span class="at">value =</span> <span class="st">"fe_importer_bln"</span>)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>fe_pair_id_2_bln <span class="ot">&lt;-</span> fit_baseline_app2<span class="sc">$</span>fixed_effects<span class="sc">$</span>pair_id_2 <span class="sc">|&gt;</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">enframe</span>(<span class="at">name =</span> <span class="st">"pair_id_2"</span>, <span class="at">value =</span> <span class="st">"fe_pair_id_2_bln"</span>)</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>ch2_application2 <span class="ot">&lt;-</span> ch2_application2 <span class="sc">|&gt;</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(fe_exporter_bln, <span class="at">by =</span> <span class="st">"exp_year"</span>) <span class="sc">|&gt;</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(fe_importer_bln, <span class="at">by =</span> <span class="st">"imp_year"</span>) <span class="sc">|&gt;</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(fe_pair_id_2_bln, <span class="at">by =</span> <span class="st">"pair_id_2"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="stage-2-regress-the-estimates-of-pair-fixed-effects-on-gravity-variables-and-country-fixed-effects" class="level4" data-number="3.2.2.2">
<h4 data-number="3.2.2.2" class="anchored" data-anchor-id="stage-2-regress-the-estimates-of-pair-fixed-effects-on-gravity-variables-and-country-fixed-effects"><span class="header-section-number">3.2.2.2</span> Stage 2: Regress the estimates of pair fixed effects on gravity variables and country fixed effects</h4>
<p>Box #1 from page 113 in <span class="citation" data-cites="yotov2016advanced">Yotov et al. (<a href="#ref-yotov2016advanced" role="doc-biblioref">2016</a>)</span> can be divided into smaller chunks. We start by filtering to keep the observation from 1994, and then we compute the trade costs (<span class="math inline">\(\bar{t}_{ij}\)</span> and <span class="math inline">\(t_{ij}^{BLN}\)</span>) from the internal dyads fixed effects and the estimated RTA coefficient.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>ch2_application2 <span class="ot">&lt;-</span> ch2_application2 <span class="sc">|&gt;</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">tij_bar =</span> <span class="fu">exp</span>(fe_pair_id_2_bln),</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">tij_bln =</span> <span class="fu">exp</span>(fe_pair_id_2_bln <span class="sc">+</span> fit_baseline_app2<span class="sc">$</span>coef_table[<span class="st">"rta"</span>, <span class="dv">1</span>] <span class="sc">*</span> rta)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We need to create a table for the year 1994 and international flows, which we will use to predict the trade costs for the observations with zero trade flows. The reason to create a sub-table, instead of filtering observations in the regression function, is that it eases posterior work to predict the costs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>ch2_application2_2 <span class="ot">&lt;-</span> ch2_application2 <span class="sc">|&gt;</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> year_rta, exporter <span class="sc">!=</span> importer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, unlike the book, which duplicates <span class="math inline">\(\overline{t_{ij}}\)</span> by creating <span class="math inline">\(t_{ij}\)</span>, we can fit a regression to estimate the costs. This is something that emerges from the small differences between expressing an idea in Stata or R.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>fit_costs_app2 <span class="ot">&lt;-</span> <span class="fu">fepoisson</span>(</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  tij_bar <span class="sc">~</span> log_dist <span class="sc">+</span> cntg <span class="sc">+</span> lang <span class="sc">+</span> clny <span class="sc">|</span> exporter <span class="sc">+</span> importer,</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> ch2_application2_2,</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">list</span>(<span class="at">iter_max =</span> <span class="dv">500</span>)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With the regression, we add the fitted values to the sub-table.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>ch2_application2_2 <span class="ot">&lt;-</span> ch2_application2_2 <span class="sc">|&gt;</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tij_no_rta =</span> <span class="fu">predict</span>(fit_costs_app2, <span class="at">newdata =</span> ch2_application2_2)) <span class="sc">|&gt;</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(exporter, importer, tij_no_rta)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The final step is to keep the observations for the year 1994 in the original table and replace the missing costs with the predicted values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>ch2_application2 <span class="ot">&lt;-</span> ch2_application2 <span class="sc">|&gt;</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> year_rta) <span class="sc">|&gt;</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(ch2_application2_2, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"exporter"</span>, <span class="st">"importer"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">tij_bar =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(tij_bar), tij_no_rta, tij_bar),</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">tij_bln =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(tij_bln), tij_bar <span class="sc">*</span> <span class="fu">exp</span>(fit_baseline_app2<span class="sc">$</span>coef_table[<span class="st">"rta"</span>, <span class="dv">1</span>] <span class="sc">*</span> rta), tij_bln)</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>tij_no_rta)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Box #2 from page 113 in <span class="citation" data-cites="yotov2016advanced">Yotov et al. (<a href="#ref-yotov2016advanced" role="doc-biblioref">2016</a>)</span> is easier to replicate. The first part of completing Box #2 involves solving the constrained baseline gravity model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>fit_constrained_app2 <span class="ot">&lt;-</span> <span class="fu">fepoisson</span>(</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  trade <span class="sc">~</span> <span class="dv">0</span> <span class="sc">|</span> exporter <span class="sc">+</span> importer,</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> ch2_application2,</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">offset =</span> <span class="sc">~</span> <span class="fu">log</span>(tij_bln),</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">list</span>(<span class="at">iter_max =</span> <span class="dv">500</span>)</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With the fitted model, we can add the prediction and the <span class="math inline">\(\xi^{BLN}\)</span> column.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>ch2_application2 <span class="ot">&lt;-</span> ch2_application2 <span class="sc">|&gt;</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tradehat_bln =</span> <span class="fu">predict</span>(fit_constrained_app2, ch2_application2)) <span class="sc">|&gt;</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(exporter) <span class="sc">|&gt;</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">xi_bln =</span> <span class="fu">sum</span>(tradehat_bln <span class="sc">*</span> (exporter <span class="sc">!=</span> importer), <span class="at">na.rm =</span> T)) <span class="sc">|&gt;</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The book specifies that all other baseline indexes of interest can be obtained by applying the same procedure described in the previous application. Here we will obtain the multilateral resistances terms (<span class="math inline">\(OMR^{BLN}\)</span> and <span class="math inline">\(IMR^{BLN}\)</span>) by adding the fixed effects from the constrained model to the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>fe_exporter_cns <span class="ot">&lt;-</span> fit_constrained_app2<span class="sc">$</span>fixed_effects<span class="sc">$</span>exporter <span class="sc">|&gt;</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">enframe</span>(<span class="at">name =</span> <span class="st">"exporter"</span>, <span class="at">value =</span> <span class="st">"fe_exporter_cns"</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>fe_importer_cns <span class="ot">&lt;-</span> fit_constrained_app2<span class="sc">$</span>fixed_effects<span class="sc">$</span>importer <span class="sc">|&gt;</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">enframe</span>(<span class="at">name =</span> <span class="st">"importer"</span>, <span class="at">value =</span> <span class="st">"fe_importer_cns"</span>)</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>ch2_application2 <span class="ot">&lt;-</span> ch2_application2 <span class="sc">|&gt;</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(fe_exporter_cns, <span class="at">by =</span> <span class="st">"exporter"</span>) <span class="sc">|&gt;</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(fe_importer_cns, <span class="at">by =</span> <span class="st">"importer"</span>)</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>ch2_application2 <span class="ot">&lt;-</span> ch2_application2 <span class="sc">|&gt;</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">omr_bln =</span> y <span class="sc">*</span> e_r <span class="sc">/</span> <span class="fu">exp</span>(fe_exporter_cns),</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">imr_bln =</span> e <span class="sc">/</span> (<span class="fu">exp</span>(fe_importer_cns) <span class="sc">*</span> e_r)</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="step-ii-define-a-counterfactual-scenario-1" class="level3" data-number="3.2.3">
<h3 data-number="3.2.3" class="anchored" data-anchor-id="step-ii-define-a-counterfactual-scenario-1"><span class="header-section-number">3.2.3</span> Step II: Define a counterfactual scenario</h3>
<p>Box #1 from page 114 in <span class="citation" data-cites="yotov2016advanced">Yotov et al. (<a href="#ref-yotov2016advanced" role="doc-biblioref">2016</a>)</span> is direct and consists in replacing the RTA values by zero if the pairs of countries are NAFTA members.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>ch2_application2 <span class="ot">&lt;-</span> ch2_application2 <span class="sc">|&gt;</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">rta_no_nafta =</span> <span class="fu">ifelse</span>(exporter <span class="sc">%in%</span> countries_rta <span class="sc">&amp;</span> importer <span class="sc">%in%</span> countries_rta, <span class="dv">0</span>, rta),</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">tij_cfl =</span> tij_bar <span class="sc">*</span> <span class="fu">exp</span>(fit_baseline_app2<span class="sc">$</span>coef_table[<span class="st">"rta"</span>, <span class="dv">1</span>] <span class="sc">*</span> rta_no_nafta)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-iii-solve-the-counterfactual-model-1" class="level3" data-number="3.2.4">
<h3 data-number="3.2.4" class="anchored" data-anchor-id="step-iii-solve-the-counterfactual-model-1"><span class="header-section-number">3.2.4</span> Step III: Solve the counterfactual model</h3>
<p>The same procedure from the previous section applies to obtain the conditional general equilibrium effects and then compute the full endowment general equilibrium effects. We start by fitting a counterfactual model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>fit_counterfactual_app2 <span class="ot">&lt;-</span> <span class="fu">fepoisson</span>(</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  trade <span class="sc">~</span> <span class="dv">0</span> <span class="sc">|</span> exporter <span class="sc">+</span> importer,</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> ch2_application2,</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">offset =</span> <span class="sc">~</span> <span class="fu">log</span>(tij_cfl),</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">list</span>(<span class="at">iter_max =</span> <span class="dv">500</span>)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With the fitted model we add the fixed effects.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>fe_exporter_cfl <span class="ot">&lt;-</span> fit_counterfactual_app2<span class="sc">$</span>fixed_effects<span class="sc">$</span>exporter <span class="sc">|&gt;</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">enframe</span>(<span class="at">name =</span> <span class="st">"exporter"</span>, <span class="at">value =</span> <span class="st">"fe_exporter_cfl"</span>)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>fe_importer_cfl <span class="ot">&lt;-</span> fit_counterfactual_app2<span class="sc">$</span>fixed_effects<span class="sc">$</span>importer <span class="sc">|&gt;</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">enframe</span>(<span class="at">name =</span> <span class="st">"importer"</span>, <span class="at">value =</span> <span class="st">"fe_importer_cfl"</span>)</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>ch2_application2 <span class="ot">&lt;-</span> ch2_application2 <span class="sc">|&gt;</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(fe_exporter_cfl, <span class="at">by =</span> <span class="st">"exporter"</span>) <span class="sc">|&gt;</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(fe_importer_cfl, <span class="at">by =</span> <span class="st">"importer"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As we did in stage 2, we compute the multilateral resistance terms.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>ch2_application2 <span class="ot">&lt;-</span> ch2_application2 <span class="sc">|&gt;</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">omr_cfl =</span> y <span class="sc">*</span> e_r <span class="sc">/</span> <span class="fu">exp</span>(fe_exporter_cfl),</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">imr_cfl =</span> e <span class="sc">/</span> (<span class="fu">exp</span>(fe_importer_cfl) <span class="sc">*</span> e_r)</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Up to this point, we are ready to compute the conditional general equilibrium effects of trade.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>ch2_application2 <span class="ot">&lt;-</span> ch2_application2 <span class="sc">|&gt;</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tradehat_cfl =</span> <span class="fu">predict</span>(fit_counterfactual_app2, ch2_application2)) <span class="sc">|&gt;</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(exporter) <span class="sc">|&gt;</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">xi_cfl =</span> <span class="fu">sum</span>(tradehat_cfl <span class="sc">*</span> (exporter <span class="sc">!=</span> importer), <span class="at">na.rm =</span> T)) <span class="sc">|&gt;</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we are going to compute the full endowment general equilibrium effects. We start by repeating the steps to obtain changes in <span class="math inline">\(t_{ij}\)</span> <span class="math inline">\(\phi\)</span> from the last section.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>ch2_application2 <span class="ot">&lt;-</span> ch2_application2 <span class="sc">|&gt;</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">change_tij =</span> tij_cfl <span class="sc">/</span> tij_bln,</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">phi =</span> <span class="fu">ifelse</span>(importer <span class="sc">==</span> exporter, e <span class="sc">/</span> y, <span class="dv">0</span>)</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(exporter) <span class="sc">|&gt;</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">phi =</span> <span class="fu">max</span>(phi, <span class="at">na.rm =</span> T)) <span class="sc">|&gt;</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we compute changes in <span class="math inline">\(p_i\)</span>, <span class="math inline">\(p_j\)</span> and <span class="math inline">\(trade^{CFL}\)</span>, which is just a repetition of the previous steps with some adaptation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>ch2_application2 <span class="ot">&lt;-</span> ch2_application2 <span class="sc">|&gt;</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(exporter) <span class="sc">|&gt;</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">change_p_i =</span> ((<span class="fu">exp</span>(fe_exporter_cfl) <span class="sc">/</span> e_r) <span class="sc">/</span> (<span class="fu">exp</span>(fe_exporter_cns) <span class="sc">/</span> e_r))<span class="sc">^</span>(<span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> sigma))) <span class="sc">|&gt;</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(importer) <span class="sc">|&gt;</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">change_p_j =</span> <span class="fu">ifelse</span>(importer <span class="sc">==</span> exporter, change_p_i, <span class="dv">0</span>),</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">change_p_j =</span> <span class="fu">max</span>(change_p_j, <span class="at">na.rm =</span> T)</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>ch2_application2 <span class="ot">&lt;-</span> ch2_application2 <span class="sc">|&gt;</span></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">trade_cfl =</span> tradehat_cfl <span class="sc">*</span> change_p_i <span class="sc">*</span> change_p_j)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then we need a <code>while()</code> loop, but before, we need to duplicate some columns under new names for the loop operations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>ch2_application2 <span class="ot">&lt;-</span> ch2_application2 <span class="sc">|&gt;</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">omr_cfl_0 =</span> omr_cfl,</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">imr_cfl_0 =</span> imr_cfl,</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">change_imr_full_0 =</span> <span class="dv">1</span>,</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">change_omr_full_0 =</span> <span class="dv">1</span>,</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">change_p_i_0 =</span> change_p_i,</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">change_p_j_0 =</span> change_p_j,</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">fe_exporter_cfl_0 =</span> fe_exporter_cfl,</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">fe_importer_cfl_0 =</span> fe_importer_cfl,</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">tradehat_0 =</span> tradehat_cfl,</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">e_r_cfl_0 =</span> e_r</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Furthermore, now we run the loop, where the step <span class="math inline">\(N\)</span> depends on the step <span class="math inline">\(N-1\)</span> as in the previous section.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>i2 <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> (sd_dif <span class="sc">&gt;</span> <span class="fl">1e-3</span> <span class="sc">|</span> max_dif <span class="sc">&gt;</span> <span class="fl">1e-3</span>) {</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  ch2_application2 <span class="ot">&lt;-</span> ch2_application2 <span class="sc">|&gt;</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">trade_1 =</span> tradehat_0 <span class="sc">*</span> change_p_i_0 <span class="sc">*</span> change_p_j_0 <span class="sc">/</span> (change_omr_full_0 <span class="sc">*</span> change_imr_full_0))</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># repeat the counterfactual model</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>  fit_counterfactual_app2_2 <span class="ot">&lt;-</span> <span class="fu">fepoisson</span>(</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>    trade_1 <span class="sc">~</span> <span class="dv">0</span> <span class="sc">|</span> exporter <span class="sc">+</span> importer,</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> ch2_application2,</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">offset =</span> <span class="sc">~</span> <span class="fu">log</span>(tij_cfl),</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">list</span>(<span class="at">iter_max =</span> <span class="dv">500</span>)</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>  fe_exporter_cfl <span class="ot">&lt;-</span> fit_counterfactual_app2_2<span class="sc">$</span>fixed_effects<span class="sc">$</span>exporter <span class="sc">|&gt;</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>    tibble<span class="sc">::</span><span class="fu">enframe</span>(<span class="at">name =</span> <span class="st">"exporter"</span>, <span class="at">value =</span> <span class="st">"fe_exporter_cfl"</span>)</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>  fe_importer_cfl <span class="ot">&lt;-</span> fit_counterfactual_app2_2<span class="sc">$</span>fixed_effects<span class="sc">$</span>importer <span class="sc">|&gt;</span></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>    tibble<span class="sc">::</span><span class="fu">enframe</span>(<span class="at">name =</span> <span class="st">"importer"</span>, <span class="at">value =</span> <span class="st">"fe_importer_cfl"</span>)</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>  ch2_application2<span class="sc">$</span>fe_exporter_cfl <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>  ch2_application2<span class="sc">$</span>fe_importer_cfl <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a>  ch2_application2 <span class="ot">&lt;-</span> ch2_application2 <span class="sc">|&gt;</span></span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(fe_exporter_cfl, <span class="at">by =</span> <span class="st">"exporter"</span>) <span class="sc">|&gt;</span></span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(fe_importer_cfl, <span class="at">by =</span> <span class="st">"importer"</span>)</span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># compute the conditional general equilibrium effects of trade</span></span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a>  ch2_application2 <span class="ot">&lt;-</span> ch2_application2 <span class="sc">|&gt;</span></span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">tradehat_1 =</span> <span class="fu">predict</span>(fit_counterfactual_app2_2, ch2_application2)) <span class="sc">|&gt;</span></span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(exporter) <span class="sc">|&gt;</span></span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">y_cfl_1 =</span> <span class="fu">sum</span>(tradehat_1, <span class="at">na.rm =</span> T)) <span class="sc">|&gt;</span></span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">e_cfl_1 =</span> <span class="fu">ifelse</span>(importer <span class="sc">==</span> exporter, phi <span class="sc">*</span> y_cfl_1, <span class="dv">0</span>)) <span class="sc">|&gt;</span></span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(importer) <span class="sc">|&gt;</span></span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">e_cfl_1 =</span> <span class="fu">max</span>(e_cfl_1, <span class="at">na.rm =</span> T)) <span class="sc">|&gt;</span></span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb52-37"><a href="#cb52-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb52-38"><a href="#cb52-38" aria-hidden="true" tabindex="-1"></a>      <span class="at">e_r_cfl_1 =</span> <span class="fu">ifelse</span>(importer <span class="sc">==</span> ref_country0, e_cfl_1, <span class="dv">0</span>),</span>
<span id="cb52-39"><a href="#cb52-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">e_r_cfl_1 =</span> <span class="fu">max</span>(e_r_cfl_1, <span class="at">na.rm =</span> T)</span>
<span id="cb52-40"><a href="#cb52-40" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb52-41"><a href="#cb52-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-42"><a href="#cb52-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># compute the change in prices for exporters and importers</span></span>
<span id="cb52-43"><a href="#cb52-43" aria-hidden="true" tabindex="-1"></a>  ch2_application2 <span class="ot">&lt;-</span> ch2_application2 <span class="sc">|&gt;</span></span>
<span id="cb52-44"><a href="#cb52-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">change_p_i_1 =</span> ((<span class="fu">exp</span>(fe_exporter_cfl) <span class="sc">/</span> e_r_cfl_1) <span class="sc">/</span></span>
<span id="cb52-45"><a href="#cb52-45" aria-hidden="true" tabindex="-1"></a>      (<span class="fu">exp</span>(fe_exporter_cfl_0) <span class="sc">/</span> e_r_cfl_0))<span class="sc">^</span>(<span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> sigma)))</span>
<span id="cb52-46"><a href="#cb52-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-47"><a href="#cb52-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># compute the change in prices for exporters and importers</span></span>
<span id="cb52-48"><a href="#cb52-48" aria-hidden="true" tabindex="-1"></a>  ch2_application2 <span class="ot">&lt;-</span> ch2_application2 <span class="sc">|&gt;</span></span>
<span id="cb52-49"><a href="#cb52-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(importer) <span class="sc">|&gt;</span></span>
<span id="cb52-50"><a href="#cb52-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb52-51"><a href="#cb52-51" aria-hidden="true" tabindex="-1"></a>      <span class="at">change_p_j_1 =</span> <span class="fu">ifelse</span>(importer <span class="sc">==</span> exporter, change_p_i_1, <span class="dv">0</span>),</span>
<span id="cb52-52"><a href="#cb52-52" aria-hidden="true" tabindex="-1"></a>      <span class="at">change_p_j_1 =</span> <span class="fu">max</span>(change_p_j_1, <span class="at">na.rm =</span> T)</span>
<span id="cb52-53"><a href="#cb52-53" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb52-54"><a href="#cb52-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb52-55"><a href="#cb52-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-56"><a href="#cb52-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># compute both outward and inward multilateral resistance</span></span>
<span id="cb52-57"><a href="#cb52-57" aria-hidden="true" tabindex="-1"></a>  ch2_application2 <span class="ot">&lt;-</span> ch2_application2 <span class="sc">|&gt;</span></span>
<span id="cb52-58"><a href="#cb52-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb52-59"><a href="#cb52-59" aria-hidden="true" tabindex="-1"></a>      <span class="at">omr_cfl_1 =</span> (y_cfl_1 <span class="sc">*</span> e_r_cfl_1) <span class="sc">/</span> <span class="fu">exp</span>(fe_exporter_cfl),</span>
<span id="cb52-60"><a href="#cb52-60" aria-hidden="true" tabindex="-1"></a>      <span class="at">imr_cfl_1 =</span> e_cfl_1 <span class="sc">/</span> (<span class="fu">exp</span>(fe_importer_cfl) <span class="sc">*</span> e_r_cfl_1)</span>
<span id="cb52-61"><a href="#cb52-61" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb52-62"><a href="#cb52-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-63"><a href="#cb52-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># update the differences</span></span>
<span id="cb52-64"><a href="#cb52-64" aria-hidden="true" tabindex="-1"></a>  max_dif <span class="ot">&lt;-</span> <span class="fu">abs</span>(<span class="fu">max</span>(ch2_application2<span class="sc">$</span>change_p_i_0 <span class="sc">-</span> change_price_i_old, <span class="at">na.rm =</span> T))</span>
<span id="cb52-65"><a href="#cb52-65" aria-hidden="true" tabindex="-1"></a>  sd_dif <span class="ot">&lt;-</span> <span class="fu">sd</span>(ch2_application2<span class="sc">$</span>change_p_i_0 <span class="sc">-</span> change_price_i_old)</span>
<span id="cb52-66"><a href="#cb52-66" aria-hidden="true" tabindex="-1"></a>  change_price_i_old <span class="ot">&lt;-</span> ch2_application2<span class="sc">$</span>change_p_i_0</span>
<span id="cb52-67"><a href="#cb52-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-68"><a href="#cb52-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># compute changes in outward and inward multilateral resistance</span></span>
<span id="cb52-69"><a href="#cb52-69" aria-hidden="true" tabindex="-1"></a>  ch2_application2 <span class="ot">&lt;-</span> ch2_application2 <span class="sc">|&gt;</span></span>
<span id="cb52-70"><a href="#cb52-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb52-71"><a href="#cb52-71" aria-hidden="true" tabindex="-1"></a>      <span class="at">change_omr_full_1 =</span> omr_cfl_1 <span class="sc">/</span> omr_cfl_0,</span>
<span id="cb52-72"><a href="#cb52-72" aria-hidden="true" tabindex="-1"></a>      <span class="at">change_imr_full_1 =</span> imr_cfl_1 <span class="sc">/</span> imr_cfl_0,</span>
<span id="cb52-73"><a href="#cb52-73" aria-hidden="true" tabindex="-1"></a>      <span class="at">omr_cfl_0 =</span> omr_cfl_1,</span>
<span id="cb52-74"><a href="#cb52-74" aria-hidden="true" tabindex="-1"></a>      <span class="at">imr_cfl_0 =</span> imr_cfl_1,</span>
<span id="cb52-75"><a href="#cb52-75" aria-hidden="true" tabindex="-1"></a>      <span class="at">change_omr_full_0 =</span> change_omr_full_1,</span>
<span id="cb52-76"><a href="#cb52-76" aria-hidden="true" tabindex="-1"></a>      <span class="at">change_imr_full_0 =</span> change_imr_full_1,</span>
<span id="cb52-77"><a href="#cb52-77" aria-hidden="true" tabindex="-1"></a>      <span class="at">change_p_i_0 =</span> change_p_i_1,</span>
<span id="cb52-78"><a href="#cb52-78" aria-hidden="true" tabindex="-1"></a>      <span class="at">change_p_j_0 =</span> change_p_j_1,</span>
<span id="cb52-79"><a href="#cb52-79" aria-hidden="true" tabindex="-1"></a>      <span class="at">fe_exporter_cfl_0 =</span> fe_exporter_cfl,</span>
<span id="cb52-80"><a href="#cb52-80" aria-hidden="true" tabindex="-1"></a>      <span class="at">fe_importer_cfl_0 =</span> fe_importer_cfl,</span>
<span id="cb52-81"><a href="#cb52-81" aria-hidden="true" tabindex="-1"></a>      <span class="at">tradehat_0 =</span> tradehat_1,</span>
<span id="cb52-82"><a href="#cb52-82" aria-hidden="true" tabindex="-1"></a>      <span class="at">e_r_cfl_0 =</span> e_r_cfl_1</span>
<span id="cb52-83"><a href="#cb52-83" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb52-84"><a href="#cb52-84" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>fe_exporter_cfl, <span class="sc">-</span>fe_importer_cfl)</span>
<span id="cb52-85"><a href="#cb52-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-86"><a href="#cb52-86" aria-hidden="true" tabindex="-1"></a>  i2 <span class="ot">&lt;-</span> i2 <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb52-87"><a href="#cb52-87" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The last loop allows us to obtain changes in <span class="math inline">\(p_i^{full}\)</span>, <span class="math inline">\(p_j^{full}\)</span> and <span class="math inline">\(y^{full}\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>ch2_application2 <span class="ot">&lt;-</span> ch2_application2 <span class="sc">|&gt;</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">change_p_i_full =</span> ((<span class="fu">exp</span>(fe_exporter_cfl_0) <span class="sc">/</span> e_r_cfl_0) <span class="sc">/</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>      (<span class="fu">exp</span>(fe_exporter_cns) <span class="sc">/</span> e_r))<span class="sc">^</span>(<span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> sigma)),</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">change_p_j_full =</span> change_p_i_full <span class="sc">*</span> (exporter <span class="sc">==</span> importer)</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(importer) <span class="sc">|&gt;</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">change_p_j_full =</span> <span class="fu">max</span>(change_p_j_full, <span class="at">na.rm =</span> T)) <span class="sc">|&gt;</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y_full =</span> change_p_i_full <span class="sc">*</span> y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we compute $e^{full} and <span class="math inline">\(e_r^{full}\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>ch2_application2 <span class="ot">&lt;-</span> ch2_application2 <span class="sc">|&gt;</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">e_full =</span> change_p_j_full <span class="sc">*</span> e <span class="sc">*</span> (exporter <span class="sc">==</span> importer)) <span class="sc">|&gt;</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(importer) <span class="sc">|&gt;</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">e_full =</span> <span class="fu">max</span>(e_full, <span class="at">na.rm =</span> T)) <span class="sc">|&gt;</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">e_full_r =</span> e_full <span class="sc">*</span> (importer <span class="sc">==</span> ref_country0),</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">e_full_r =</span> <span class="fu">max</span>(e_full_r, <span class="at">na.rm =</span> T)</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We also need <code>omr_full</code> and <code>imr_full</code>. This part of the code needs <em>attention</em> because the IMR full term is computed in a different way compared to the previous section. Please see the script <em>RTAsEffects.do</em>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>ch2_application2 <span class="ot">&lt;-</span> ch2_application2 <span class="sc">|&gt;</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">omr_full =</span> y_full <span class="sc">*</span> e_r_cfl_0 <span class="sc">/</span> <span class="fu">exp</span>(fe_exporter_cfl_0),</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">imr_full =</span> e_cfl_1 <span class="sc">/</span> (<span class="fu">exp</span>(fe_importer_cfl_0) <span class="sc">*</span> e_r_cfl_0)</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To complete this step, we compute <span class="math inline">\(\xi^{full}\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>ch2_application2 <span class="ot">&lt;-</span> ch2_application2 <span class="sc">|&gt;</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">x_full =</span> (y_full <span class="sc">*</span> e_full <span class="sc">*</span> tij_cfl) <span class="sc">/</span> (imr_full <span class="sc">*</span> omr_full)) <span class="sc">|&gt;</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(exporter) <span class="sc">|&gt;</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">xi_full =</span> <span class="fu">sum</span>(x_full <span class="sc">*</span> (importer <span class="sc">!=</span> exporter), <span class="at">na.rm =</span> T)) <span class="sc">|&gt;</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-iv-collect-construct-and-report-indexes-of-interest-1" class="level3" data-number="3.2.5">
<h3 data-number="3.2.5" class="anchored" data-anchor-id="step-iv-collect-construct-and-report-indexes-of-interest-1"><span class="header-section-number">3.2.5</span> Step IV: Collect, construct, and report indexes of interest</h3>
<p>This step aims to reproduce the table from page 116 in <span class="citation" data-cites="yotov2016advanced">Yotov et al. (<a href="#ref-yotov2016advanced" role="doc-biblioref">2016</a>)</span>.</p>
<p>To ease the task of creating the table from the book, we divide between exporter and importer indexes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>exporter_indexes <span class="ot">&lt;-</span> ch2_application2 <span class="sc">|&gt;</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    exporter, <span class="fu">starts_with</span>(<span class="st">"omr_"</span>), change_p_i_full,</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">starts_with</span>(<span class="st">"xi_"</span>), y, y_full</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>() <span class="sc">|&gt;</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">exporter =</span> <span class="fu">ifelse</span>(exporter <span class="sc">==</span> ref_country0, ref_country, exporter)) <span class="sc">|&gt;</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(exporter) <span class="sc">|&gt;</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">change_p_i_full =</span> (<span class="dv">1</span> <span class="sc">-</span> change_p_i_full) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">change_omr_cfl =</span> ((omr_bln <span class="sc">/</span> omr_cfl)<span class="sc">^</span>(<span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> sigma)) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">change_omr_full =</span> ((omr_bln <span class="sc">/</span> omr_full)<span class="sc">^</span>(<span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> sigma)) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">change_xi_cfl =</span> (xi_bln <span class="sc">/</span> xi_cfl <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">change_xi_full =</span> (xi_bln <span class="sc">/</span> xi_full <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(exporter, <span class="fu">starts_with</span>(<span class="st">"change"</span>), <span class="fu">starts_with</span>(<span class="st">"y"</span>))</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>importer_indexes <span class="ot">&lt;-</span> ch2_application2 <span class="sc">|&gt;</span></span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(importer, imr_bln, imr_cfl, imr_full) <span class="sc">|&gt;</span></span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>() <span class="sc">|&gt;</span></span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">importer =</span> <span class="fu">ifelse</span>(importer <span class="sc">==</span> ref_country0, ref_country, importer)) <span class="sc">|&gt;</span></span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(importer) <span class="sc">|&gt;</span></span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">change_imr_cfl =</span> ((imr_bln <span class="sc">/</span> imr_cfl)<span class="sc">^</span>(<span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> sigma)) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">change_imr_full =</span> ((imr_bln <span class="sc">/</span> imr_full)<span class="sc">^</span>(<span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> sigma)) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we can replicate the table that we wanted to. Instead of printing the raw table, we format it as HTML in a separate chunk. Note that this result matches the Stata code but in the book flipped the GDP and OMR columns.</p>
<div class="cell">
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-4b9d9ef98c9c5304b36b" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-4b9d9ef98c9c5304b36b">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69"],["ARG","AUS","AUT","BEL","BGR","BOL","BRA","CAN","CHE","CHL","CHN","CMR","COL","CRI","CYP","DEU","DNK","ECU","EGY","ESP","FIN","FRA","GBR","GRC","HKG","HUN","IDN","IND","IRL","IRN","ISL","ISR","ITA","JOR","JPN","KEN","KOR","KWT","LKA","MAC","MAR","MEX","MLT","MMR","MUS","MWI","MYS","NER","NGA","NLD","NOR","NPL","PAN","PHL","POL","PRT","QAT","ROM","SEN","SGP","SWE","THA","TTO","TUN","TUR","TZA","URY","USA","ZAF"],[-0.66,-0.49,-0.07000000000000001,-0.09,-0.05,-0.47,-0.65,34.99,-0.14,-0.8100000000000001,-0.34,-0.13,-1.8,-1.03,-0.09,-0.14,-0.06,-0.93,-0.31,-0.13,-0.09,-0.13,-0.23,-0.08,-0.2,-0.04,-0.19,-0.3,-0.1,-0.13,-0.23,-0.38,-0.12,-0.28,-0.35,-0.22,-0.41,-0.23,-0.3,-0.21,-0.08,41.64,-0.13,-0.09,-0.06,-0.18,-0.22,-0.11,-0.37,-0.07000000000000001,-0.24,-0.22,-0.6,-0.29,-0.05,-0.06,-0.19,-0.08,-0.08,-0.15,-0.11,-0.25,-0.86,-0.04,-0.14,-0.16,-0.42,14.48,-0.31],[-0.6899999999999999,-0.51,-0.1,-0.12,-0.07000000000000001,-0.48,-0.6899999999999999,37.46,-0.17,-0.83,-0.38,-0.16,-1.73,-1.04,-0.11,-0.17,-0.09,-0.89,-0.33,-0.15,-0.11,-0.15,-0.25,-0.11,-0.23,-0.07000000000000001,-0.24,-0.33,-0.13,-0.16,-0.25,-0.41,-0.15,-0.3,-0.42,-0.24,-0.45,-0.26,-0.33,-0.24,-0.1,43.51,-0.15,-0.19,-0.09,-0.19,-0.27,-0.13,-0.39,-0.09,-0.25,-0.25,-0.62,-0.33,-0.07000000000000001,-0.08,-0.22,-0.1,-0.11,-0.19,-0.13,-0.29,-0.88,-0.07000000000000001,-0.16,-0.17,-0.44,14.88,-0.34],[-0.01,-0.01,-0.01,-0,-0,-0.02,-0.01,3.4,-0.01,-0.03,-0.01,-0.01,-0.03,-0.07000000000000001,-0,-0.01,-0.01,-0.02,-0.01,-0.01,-0.01,-0.01,-0.01,-0,-0.02,-0,-0.01,-0.01,-0.03,-0,-0.01,-0.02,-0.01,-0,-0.01,-0,-0.02,-0.01,-0.01,-0.05,-0,3.81,-0.02,-0,-0.01,-0.01,-0.03,-0.02,-0,-0.01,-0.01,-0.01,-0.02,-0.03,-0,-0,-0.01,-0,-0,-0.03,-0.01,-0.01,-0.08,-0,-0,-0.01,-0.02,0.33,-0.01],[0.01,0.02,0,0,0,0.03,-0,-1.48,0,0.01,-0.01,0.01,0.09,0.06,0.01,0,0,0.08,0.02,0,-0,0,0.01,0.01,0.01,-0,-0,0.01,0.01,0.01,0.02,0.02,0,0.02,-0.02,0.02,-0.01,0.01,0.02,0.02,0,-2.4,0.01,0.01,0.01,0.02,0.01,0.02,0.03,0,0.02,0.02,0.02,0.01,0,0,0.01,0,0.01,0.01,0,-0,0.02,0,0,0.02,0.01,-0.18,0.01],[0,-0.01,0.01,0,0,-0.01,0.02,-2.14,0.01,0.03,0.03,-0,-0.07000000000000001,0.01,-0.01,0.01,0.01,-0.06,-0.02,0.01,0.01,0.01,0.01,-0,0.01,0.01,0.01,0,0.02,-0.01,-0.01,0,0.01,-0.02,0.03,-0.02,0.03,0,-0.01,0.03,-0,-1.52,0.01,-0.01,0,-0.01,0.03,0.01,-0.03,0.01,-0,-0.01,-0,0.02,0,0,0.01,0,-0.01,0.02,0.01,0.02,0.07000000000000001,-0,0,-0.01,0.01,-0.17,-0],[-0,0.01,-0.01,-0,-0,0.01,-0.01,1.84,-0.01,-0.03,-0.02,0,0.06,-0.01,0.01,-0.01,-0.01,0.05,0.01,-0.01,-0.01,-0,-0,0,-0.01,-0,-0.01,-0,-0.02,0.01,0.01,-0,-0.01,0.02,-0.03,0.02,-0.02,-0,0,-0.02,0,1.3,-0.01,0.01,-0,0.01,-0.02,-0.01,0.02,-0.01,0,0.01,0,-0.02,-0,-0,-0.01,-0,0.01,-0.02,-0.01,-0.01,-0.06,0,-0,0.01,-0.01,0.15,0]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>exporter<\/th>\n      <th>change_xi_cfl<\/th>\n      <th>change_xi_full<\/th>\n      <th>change_rgdp_full<\/th>\n      <th>change_imr_full<\/th>\n      <th>change_omr_full<\/th>\n      <th>change_p_i_full<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[2,3,4,5,6,7]},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"exporter","targets":1},{"name":"change_xi_cfl","targets":2},{"name":"change_xi_full","targets":3},{"name":"change_rgdp_full","targets":4},{"name":"change_imr_full","targets":5},{"name":"change_omr_full","targets":6},{"name":"change_p_i_full","targets":7}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
</section>
<section id="references" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="references"><span class="header-section-number">3.3</span> References</h2>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-yotov2016advanced" class="csl-entry" role="listitem">
Yotov, Yoto V, Roberta Piermartini, José-Antonio Monteiro, and Mario Larch. 2016. <em>An Advanced Guide to Trade Policy Analysis: The Structural Gravity Model</em>. World Trade Organization Geneva.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./01-traditional-gravity.html" class="pagination-link" aria-label="Partial equilibrium trade policy analysis with structural gravity">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Partial equilibrium trade policy analysis with structural gravity</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav>
</div> <!-- /content -->




</body></html>